/*! cheqroom-core 2019-09-02 */
!function(a,b){"function"==typeof define&&define.amd?define(["jquery","moment"],b):a.cheqroomCore=b($,moment)}(this,function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja;return c=function(a){a.fn.ajaxQueue=function(){var b=(new a.Deferred).resolve();return function(a,c){if("function"!=typeof a)throw"must be a function";return b=b.then(a,c||a)}}}(a),d=function(a,b){var c=2048;a.ajaxSetup({cache:!1});var d={};return d.NetworkNotConnected=function(a,b){this.code=999,this.message=a||"Connection interrupted",this.opt=b},d.NetworkNotConnected.prototype=new Error,d.NetworkTimeout=function(a,b){this.code=408,this.message=a||"Could not reach the server in time",this.opt=b},d.NetworkTimeout.prototype=new Error,d.ApiError=function(a,b){this.code=500,this.message=a||"Something went wrong on the server",this.opt=b},d.ApiError.prototype=new Error,d.ApiNotFound=function(a,b){this.code=404,this.message=a||"Could not find what you're looking for",this.opt=b},d.ApiNotFound.prototype=new Error,d.ApiBadRequest=function(a,b){this.code=400,this.message=a||"The server did not understand your request",this.opt=b},d.ApiBadRequest.prototype=new Error,d.ApiUnauthorized=function(a,b){this.code=401,this.message=a||"Your session has expired",this.opt=b},d.ApiUnauthorized.prototype=new Error,d.ApiForbidden=function(a,b){this.code=403,this.message=a||"You don't have sufficient rights",this.opt=b},d.ApiForbidden.prototype=new Error,d.ApiUnprocessableEntity=function(a,b){this.code=422,this.message=a||"Some data is invalid",this.opt=b},d.ApiUnprocessableEntity.prototype=new Error,d.ApiSubscriptionLimit=function(a,b){this.code=422,this.message=a||"You have reached your subscription limit",this.opt=b},d.ApiSubscriptionLimit.prototype=new Error,d.ApiPaymentRequired=function(a,b){this.code=402,this.message=a||"Your subscription has expired",this.opt=b},d.ApiPaymentRequired.prototype=new Error,d.ApiServerCapicity=function(a,b){this.code=503,this.message=a||"Back-end server is at capacity",this.opt=b},d.ApiServerCapicity.prototype=new Error,d.ApiAjax=function(a){a=a||{},this.timeOut=a.timeOut||1e4,this.responseInTz=!0},d.ApiAjax.prototype.get=function(a,b){return this._getAjax(a,b)},d.ApiAjax.prototype.post=function(a,b,c){return this._postAjax(a,b,c)},d.ApiAjax.prototype._handleAjaxSuccess=function(a,b,c){return this.responseInTz&&(b=this._fixDates(b)),a.resolve(b)},d.ApiAjax.prototype._handleAjaxError=function(a,b,c,e,f){if("abort"!=c){var g="";if("timeout"===e)a.reject(new d.NetworkTimeout(g,f));else switch(b&&(b.statusText&&b.statusText.indexOf("Notify user:")>-1&&(g=b.statusText.slice(b.statusText.indexOf("Notify user:")+13)),422==b.status&&b.responseText&&b.responseText.match(/HTTPError: \(.+\)/g).length>0&&(f={detail:b.responseText.match(/HTTPError: \(.+\)/g)[0]})),b.status){case 400:a.reject(new d.ApiBadRequest(g,f));break;case 401:a.reject(new d.ApiUnauthorized(g,f));break;case 402:a.reject(new d.ApiPaymentRequired(g,f));break;case 403:a.reject(new d.ApiForbidden(g,f));break;case 404:a.reject(new d.ApiNotFound(g,f));break;case 408:a.reject(new d.NetworkTimeout(g,f));break;case 422:a.reject(g&&g.indexOf("limit")>=0&&g.indexOf("reach")>=0?new d.ApiSubscriptionLimit(g,f):new d.ApiUnprocessableEntity(g,f));break;case 503:a.reject(new d.ApiServerCapicity(g,f));break;case 500:default:a.reject(new d.ApiError(g,f))}}},d.ApiAjax.prototype._postAjax=function(b,c,d,e){var f=a.Deferred(),g=this,h=a.ajax({type:"POST",url:b,data:JSON.stringify(this._prepareDict(c)),contentType:"application/json; charset=utf-8",timeout:d||this.timeOut,success:function(a){return g._handleAjaxSuccess(f,a,e)},error:function(a,b,c){return g._handleAjaxError(f,a,b,c,e)}}),i=f.promise();return i.abort=function(){h.abort()},i},d.ApiAjax.prototype._getAjax=function(b,c,d){var e=a.Deferred(),f=this,g=a.ajax({url:b,timeout:c||this.timeOut,success:function(a){return f._handleAjaxSuccess(e,a,d)},error:function(a,b,c){return f._handleAjaxError(e,a,b,c,d)}}),h=e.promise();return h.abort=function(){g.abort()},h},d.ApiAjax.prototype._prepareDict=function(c){return c?(a.each(c,function(a,d){b.isMoment(d)&&(c[a]=d.toJSONDate())}),c):{}},d.ApiAjax.prototype._fixDates=function(c){if("string"==typeof c||c instanceof String){if(c.endsWith("+00:00")){var d=c.length;if(25==d)return b(c.substring(0,d-6));if(32==d)return b(c.substring(0,d-6).split(".")[0])}}else if(c instanceof Object||a.isArray(c)){var e=this;a.each(c,function(a,b){c[a]=e._fixDates(b)})}return c},d.ApiUser=function(a){a=a||{},this.userId=a.userId||"",this.userToken=a.userToken||"",this.tokenType=a.tokenType||""},d.ApiUser.prototype.fromStorage=function(){this.userId=window.localStorage.getItem("userId")||"",this.userToken=window.localStorage.getItem("userToken")||"",this.tokenType=window.localStorage.getItem("tokenType")||""},d.ApiUser.prototype.toStorage=function(){window.localStorage.setItem("userId",this.userId),window.localStorage.setItem("userToken",this.userToken),window.localStorage.setItem("tokenType",this.tokenType)},d.ApiUser.prototype.removeFromStorage=function(){window.localStorage.removeItem("userId"),window.localStorage.removeItem("userToken"),window.localStorage.removeItem("tokenType")},d.ApiUser.prototype.clearToken=function(){window.localStorage.setItem("userToken",null),window.localStorage.setItem("tokenType",null)},d.ApiUser.prototype.isValid=function(){return null!=this.userId&&this.userId.length>0&&null!=this.userToken&&this.userToken.length>0},d.ApiUser.prototype._reset=function(){this.userId="",this.userToken="",this.tokenType=""},d.ApiAuth=function(a){a=a||{},this.urlAuth=a.urlAuth||"",this.ajax=a.ajax,this.version=a.version,this.platform=a.platform,this.device=a.device,this.allowAccountOwner=void 0!==a.allowAccountOwner?a.allowAccountOwner:!0},d.ApiAuth.prototype.authenticate=function(b,c){var d=this,e={user:b,password:c,_v:this.version};this.platform&&(e.platform=this.platform),this.device&&(e.device=this.device);var f=a.Deferred();return this.ajax.post(this.urlAuth,e,3e4).done(function(a){"OK"==a.status&&(-1!=["expired","cancelled_expired","archived"].indexOf(a.subscription)?d.allowAccountOwner:!0)?f.resolve(a.data):f.reject(a)}).fail(function(a){f.reject(a)}),f.promise()},d.ApiAuthV2=d.ApiAuth,d.ApiAnonymous=function(a){a=a||{},this.ajax=a.ajax,this.urlApi=a.urlApi||"",this.version=a.version},d.ApiAnonymous.prototype.call=function(b,d,e,f){this.version&&(d=d||{},d._v=this.version);var g=this.urlApi+"/"+b,h=g+"?"+a.param(this.ajax._prepareDict(d));return f||h.length>=c?this.ajax.post(g,d,e):this.ajax.get(h,e)},d.ApiAnonymous.prototype.longCall=function(a,b,c){return this.call(a,b,6e4,c)},d.ApiDataSource=function(a){a=a||{},this.collection=a.collection||"",this.urlApi=a.urlApi||"",this.user=a.user,this.ajax=a.ajax,this.version=a.version},d.ApiDataSource.prototype.exists=function(b,c){var e="exists",f=a.Deferred(),g=this.getBaseUrl()+b,h=this.getParams(c);return a.isEmptyObject(h)||(g+="?"+this.getParams(h)),this._ajaxGet(e,g).done(function(a){f.resolve(a)}).fail(function(a){a instanceof d.ApiNotFound?f.resolve(null):f.reject(a)}),f.promise()},d.ApiDataSource.prototype.get=function(b,c){var d="get",e=this.getBaseUrl()+b,f=this.getParamsDict(c);return a.isEmptyObject(f)||(e+="?"+this.getParams(f)),this._ajaxGet(d,e)},d.ApiDataSource.prototype.getIgnore404=function(b,c){var e=a.Deferred();return this.get(b,c).done(function(a){e.resolve(a)}).fail(function(a){a instanceof d.ApiNotFound?e.resolve(null):e.reject(a)}),e.promise()},d.ApiDataSource.prototype.getMultiple=function(b,c){var d="getMultiple",e=100,f=b.map(function(a,c){return c%e===0?b.slice(c,c+e):null}).filter(function(a){return a}),g=this,h=[],i=new a.fn.ajaxQueue,j=a.Deferred();return a.each(f,function(b,e){var f=g.getBaseUrl()+e.join(","),j=g.getParamsDict(c);a.isEmptyObject(j)||(f+="?"+g.getParams(j)),i(function(){return g._ajaxGet(d,f).then(function(b){b=a.isArray(b)?b:[b],h=h.concat(b)})})}),i(function(){return j.resolve(h)}),j},d.ApiDataSource.prototype["delete"]=function(a){var b="delete",c=this.getBaseUrl()+a+"/delete";return this._ajaxGet(b,c)},d.ApiDataSource.prototype.deleteMultiple=function(a,b){var d="deleteMultiple",e=this.getBaseUrl()+"delete",f={pk:a},g=e+"?"+this.getParams(f);return b||g.length>=c?this._ajaxPost(d,e,f):this._ajaxGet(d,g)},d.ApiDataSource.prototype.update=function(b,d,e,f,g){var h="update",i=this.getBaseUrl()+b+"/update",j=a.extend({},d);null!=e&&e.length>0&&(j._fields=a.isArray(e)?e.join(","):e);var k=i+"?"+this.getParams(j);return g||k.length>=c?this._ajaxPost(h,i,j,f):this._ajaxGet(h,k,f)},d.ApiDataSource.prototype.create=function(b,d,e,f){var g="create",h=this.getBaseUrl()+"create",i=a.extend({},b);null!=d&&d.length>0&&(i._fields=a.isArray(d)?d.join(","):d);var j=h+"?"+this.getParams(i);return f||j.length>=c?this._ajaxPost(g,h,i,e):this._ajaxGet(g,j,e)},d.ApiDataSource.prototype.createMultiple=function(b,c){var d=a.Deferred(),e=this,f=b.slice(0),g=[],h=function(a){if(a.length>0){var b=a.pop();e.create(b,c).done(function(b){return g.push(b._id),h(a)}).fail(function(a){d.reject(a)})}else d.resolve(g)};return h(f),d.promise()},d.ApiDataSource.prototype.list=function(b,c,d,e,f){b=b||"";var g="list."+b,h=this.getBaseUrl();null!=b&&b.length>0&&(h+="list/"+b+"/");var i=this.getParamsDict(c,d,e,f);return a.isEmptyObject(i)||(h+="?"+this.getParams(i)),this._ajaxGet(g,h)},d.ApiDataSource.prototype.search=function(a,b,c,d,e,f){var g="search",h=this.searchUrl(a,b,c,d,e,f);return this._ajaxGet(g,h)},d.ApiDataSource.prototype.searchUrl=function(b,c,d,e,f,g){var h=this.getBaseUrl()+"search",i=a.extend(this.getParamsDict(c,d,e,f),b);return null!=g&&g.length>0&&(i.mimeType=g),h+="?"+this.getParams(i)},d.ApiDataSource.prototype["export"]=function(a,b,c,d,e,f){var g="export",h=this.exportUrl(a,b,c,d,e,f);return this._ajaxGet(g,h)},d.ApiDataSource.prototype.exportUrl=function(b,c,d,e,f,g){var h=this.getBaseUrl()+"call/export",i=a.extend(this.getParamsDict(c,d,e,f),b);return null!=g&&g.length>0&&(i.mimeType=g),h+="?"+this.getParams(i)},d.ApiDataSource.prototype.call=function(b,d,e,f,g,h){var i="call."+d,j=null!=b&&b.length>0?this.getBaseUrl()+b+"/call/"+d:this.getBaseUrl()+"call/"+d,k=a.extend({},this.getParamsDict(f,null,null,null),e),l=j+"?"+this.getParams(k);return h||l.length>=c?this._ajaxPost(i,j,k,g):this._ajaxGet(i,l,g)},d.ApiDataSource.prototype.callMultiple=function(b,d,e,f,g,h){var i="call."+d,j=this.getBaseUrl()+b.join(",")+"/call/"+d,k=a.extend({},this.getParamsDict(f,null,null,null),e),l=j+"?"+this.getParams(k);return h||l.length>=c?this._ajaxPost(i,j,k,g):this._ajaxGet(i,l,g)},d.ApiDataSource.prototype.longCall=function(a,b,c,d,e){return this.call(a,b,c,d,6e4,e)},d.ApiDataSource.prototype.getBaseUrl=function(){var a=null!=this.user.tokenType&&this.user.tokenType.length>0?this.user.tokenType:"null";return this.urlApi+"/"+this.user.userId+"/"+this.user.userToken+"/"+a+"/"+this.collection+"/"},d.ApiDataSource.prototype.getParams=function(b){return a.param(this.ajax._prepareDict(b))},d.ApiDataSource.prototype.getParamsDict=function(b,c,d,e){var f={};return b&&(f._fields=a.isArray(b)?b.join(","):b.replace(/\s/g,"")),c&&(f._limit=c),d&&(f._skip=d),e&&(f._sort=e),this.version&&(f._v=this.version),f},d.ApiDataSource.prototype._ajaxGet=function(a,b,c){return this.ajax.get(b,c,{coll:this.collection,cmd:a})},d.ApiDataSource.prototype._ajaxPost=function(a,b,c,d){return this.ajax.post(b,c,d,{coll:this.collection,cmd:a})},d}(a,b),e={amazonBucket:"app"},f={isCodeValid:function(a){return null!=a.trim().match(/^[a-z0-9]{8}$/i)},isCodeFromScanner:function(a){if(!a||0==a.length)return!1;var b=a.substring(0,23),c="http://cheqroom.com/qr/".indexOf(b);return 0==c},isValidBarcode:function(a){return a&&null!=a.match(/^([A-Z0-9\s\-]{3,22})$/i)},isValidQRCode:function(a){return this.isValidItemQRCode(a)||this.isValidTransferQRCode(a)},isValidTransferQRCode:function(a){return null!=a.match(/^http:\/\/cheqroom\.com\/ordertransfer\/[a-zA-Z0-9]{22}$/i)},isValidDocQRCode:function(a){return a&&(null!=a.match(/^http:\/\/cheqroom\.com\/qr\/[a-z0-9]{8}$/i)||null!=a.match(/^[a-z0-9]{8}$/i))},isValidItemQRCode:function(a){return this.isValidDocQRCode(a)},isValidKitQRCode:function(a){return this.isValidDocQRCode(a)},getCheqRoomRedirectUrl:function(a){return this.isCodeValid(a)?"http://cheqroom.com/qr/"+a.trim():""},getCheqRoomRedirectUrlQR:function(a,b){if(this.isCodeValid(a)){var c=encodeURI(this.getCheqRoomRedirectUrl(a));return"https://chart.googleapis.com/chart?chs="+b+"x"+b+"&cht=qr&choe=UTF-8&chld=L|0&chl="+c}return""},getQRCodeUrl:function(a,b,c){return a+"/qrcode?code="+b+"&size="+c},getBarcodeUrl:function(a,b,c,d){return a+"/barcode?code="+b+"&width="+c+(d?"&height="+d:"")}},g=function(a){return{getFriendlyOrderStatus:function(a){switch(a){case"creating":return"Draft";case"open":return"Open";case"closed":return"Completed";default:return"Unknown"}},getFriendlyOrderCss:function(a){switch(a){case"creating":return"label-creating";case"open":return"label-open";case"closed":return"label-closed";default:return""}},getFriendlyOrderSize:function(a){if(a.items&&a.items.length>0){var b=a.items.length+" item";return a.items.length>1&&(b+="s"),b}return"No items"},isOrderOverdue:function(b,c){return c=c||a(),"open"==b.status&&c.isAfter(b.due)},isOrderArchived:function(a){return a&&null!=a.archived},getOrderStatus:function(b,c){return c=c||a(),this.isOrderOverdue(b,c)?"Overdue":this.isOrderArchived(b)?"Archived":this.getFriendlyOrderStatus(b.status)},getOrderCss:function(b,c){return c=c||a(),this.isOrderOverdue(b,c)?"label-overdue":this.isOrderArchived(b)?"label-archived":this.getFriendlyOrderCss(b.status)},canOrderSpotcheck:function(a){return null==a.archived&&-1==["closed"].indexOf(a.status)}}}(b),h={getFriendlyReservationCss:function(a){switch(a){case"creating":return"label-creating";case"open":return"label-open";case"closed":return"label-converted";case"closed_manually":return"label-closed";case"cancelled":return"label-cancelled";default:return""}},getFriendlyReservationStatus:function(a){switch(a){case"creating":return"Draft";case"open":return"Booked";case"closed":return"Converted";case"closed_manually":return"Closed";case"cancelled":return"Cancelled";default:return"Unknown"}},getFriendlyReservationFrequency:function(a){switch(a){case"every_day":return"Repeats every day";case"every_weekday":return"Repeats every weekday";case"every_week":return"Repeats every week";case"every_2_weeks":return"Repeats every 2 weeks";case"every_month":return"Repeats every month";case"every_2_months":return"Repeats every 2 months";case"every_3_months":return"Repeats every 3 months";case"every_6_months":return"Repeats every 6 months";default:return"Repeating reservation"}},isReservationOverdue:function(a,c){return c=c||b(),"open"==a.status&&c.isAfter(a.fromDate||a.from)},isReservationInThePast:function(a,c){return c=c||b(),"open"==a.status&&c.isAfter(a.fromDate)&&c.isAfter(a.toDate)},isReservationArchived:function(a){return a&&null!=a.archived},getReservationCss:function(a){return this.isReservationArchived(a)?"label-archived":this.getFriendlyReservationCss(a.status)},getReservationStatus:function(a){return this.isReservationArchived(a)?"Archived":this.getFriendlyReservationStatus(a.status)},canReservationSpotcheck:function(a){return null==a.archived&&-1==["cancelled","closed"].indexOf(a.status)}},i=function(a,b,c){var d={};return d.itemCanTakeCustody=function(a){var b=void 0!==a.canCustody?"available"===a.canCustody:!0;return b&&"available"==a.status},d.itemCanReleaseCustody=function(a){return"in_custody"==a.status},d.itemCanTransferCustody=function(a){var b=void 0!==a.canCustody?"available"===a.canCustody:!0;return b&&"in_custody"==a.status},d.itemCanReserve=function(a){return void 0!==a.canReserve?"available"===a.canReserve:!0},d.itemCanCheckout=function(a){return void 0!==a.canOrder?"available"===a.canOrder:!0},d.itemCanGoToCheckout=function(a){return"checkedout"==a.status||"await_checkout"==a.status},d.itemCanCheckin=function(a){return"checkedout"==a.status},d.itemCanExpire=function(a){return"available"==a.status},d.itemCanUndoExpire=function(a){return"expired"==a.status},d.itemCanDelete=function(a){return"available"==a.status||"expired"==a.status},d.getFriendlyItemStatus=function(a){switch(a){case"available":return"Available";case"checkedout":return"Checked out";case"await_checkout":return"Checking out";case"in_transit":return"In transit";case"in_custody":return"In custody";case"maintenance":return"Maintenance";case"repair":return"Repair";case"inspection":return"Inspection";case"expired":return"Expired";default:return"Unknown"}},d.getItemStatusCss=function(a){switch(a){case"available":return"label-available";case"checkedout":return"label-checkedout";case"await_checkout":return"label-awaitcheckout";case"in_transit":return"label-transit";case"in_custody":return"label-custody";case"maintenance":return"label-maintenance";case"repair":return"label-repair";case"inspection":return"label-inspection";case"expired":return"label-expired";default:return""}},d.getItemStatusIcon=function(a){switch(a){case"available":return"fa fa-check-circle";case"checkedout":return"fa fa-times-circle";case"await_checkout":return"fa fa-ellipsis-h";case"in_transit":return"fa fa-truck";case"in_custody":return"fa fa-exchange";case"maintenance":return"fa fa-wrench";case"repair":return"fa fa-wrench";case"inspection":return"fa fa-stethoscope";case"expired":return"fa fa-bug";default:return""}},d.getItemsByStatus=function(a,b){return a?a.filter(function(a){return"string"==typeof b?a.status==b:b(a)}):[]},d.getAvailableItems=function(a){return this.getItemsByStatus(a,"available").filter(function(a){return"available"===a.canOrder})},d.getActiveItems=function(a){return this.getItemsByStatus(a,function(a){return"expired"!=a.status&&"in_custody"!=a.status}).filter(function(a){return"available"===a.canReserve})},d.getItemIds=function(a){return a.map(function(a){return"string"==typeof a?a:a._id})},d.getItemMessages=function(c,d,e,f){var g=[],h={Critical:0,High:1,Medium:2,Low:3},i=e,j=!i.hasContactReadOtherPermission(),k=$.Deferred(),l=$.Deferred(),m=$.Deferred(),n=function(b){return b.format("MMMM Do"+(b.year()==a().year()?"":" YYYY"))};if("checkedout"==c.status||"await_checkout"==c.status){var o="",p=$.Deferred();j?p.resolve(null):d("orders").search({_fields:"name,itemSummary,status,started,due,finished,customer.name,customer.user.picture,customer.cover,customer.kind",_restrict:!j,_sort:"started",status:"checkedout"==c.status?"open":"creating",_limit:1,_skip:0,items__contains:c.id}).then(function(a){a&&a.count>0&&p.resolve(a.docs[0])}),p.then(function(a){o="await_checkout"==c.status?"Item is currently <strong>awaiting checkout</strong>":a&&b.isOrderOverdue(a)?"Item was <strong>due back</strong> "+a.due.fromNow()+" from "+a.customer.name:"Item is <strong>checked out</strong>"+(a?" to "+a.customer.name+" until "+n(a.due):""),g.push({kind:"checkout",priority:h.Critical,message:o,checkout:a||{}}),k.resolve()})}else k.resolve();if(i.hasReservationPermission("read")?d("reservations").search({status:"open",fromDate__gte:a(),_fields:"name,status,itemSummary,fromDate,toDate,customer.name,customer.user.picture,customer.cover,customer.kind",_restrict:!j,_sort:"fromDate",_limit:1,_skip:0,items__contains:c.id}).then(function(a){if(a&&a.count>0){var b=a.docs[0];o="Next <strong>reservation</strong> is "+b.fromDate.fromNow()+" <span class='text-muted'>on "+n(b.fromDate)+"</span>",g.push({kind:"reservation",priority:h.High,reservation:b,message:o})}l.resolve()}):l.resolve(),"in_custody"==c.status){var p=$.Deferred();j?p.resolve(null):d("items").call(c.id,"getChangeLog",{action__in:["takeCustody","transferCustody"],limit:1,skip:0}).then(function(a){d("contacts").get(a[0].obj,"name,cover,user.picture,kind").then(function(b){p.resolve(b,a[0].created)})}),p.then(function(a,b){var c="Item is <strong>in custody</strong>"+(a?" of "+a.name+" <span class='text-muted'>since "+n(b)+"</span>":"");g.push({kind:"custody",priority:h.High,by:a||{},message:c}),m.resolve()})}else m.resolve();var q=i.hasItemPermission("reserve")&&c.allowReserve,r=i.hasItemPermission("checkout")&&c.allowCheckout,s=i.hasItemPermission("takeCustody")&&c.allowCustody;if(!c.allowReserve||!c.allowCheckout||!c.allowCustody){var t=[],u=[];i.hasReservationPermission("read")&&i.hasCheckoutPermission("read")&&(!q&&!r||q&&r)?q&&r?u.push("Bookings"):i.hasCheckoutPermission("read")&&i.hasReservationPermission("read")&&t.push("Bookings"):(q?u.push("Reservation"):i.hasReservationPermission("read")&&t.push("Reservation"),r?u.push("Check-out"):i.hasCheckoutPermission("read")&&t.push("Check-out")),s?u.push("Custody"):i.hasItemPermission("takeCustody")&&t.push("Custody");var o="",v=!q&&!r&&!s;o=v?"Item is <strong>unavailable</strong> for "+t.joinAdvanced(", "," and "):"Item is <strong>available</strong> for "+u.joinAdvanced(", "," and ")+" <span class='text-muted'>, not for "+t.joinAdvanced(", "," and ")+"</span>",g.push({kind:"permission",priority:h.Medium,message:o})}if(c.flag){var o="Item was <strong>flagged</strong> as "+c.flag+(c.flagged?" <span class='text-muted'>"+c.flagged.fromNow()+"</span>":"");g.push({kind:"flag",priority:h.Medium,message:o})}if(c.warrantyDate){var o="",w=Math.round(a().diff(c.warrantyDate,"days"))>=0;o=w?"Went <strong>out of warranty</strong> "+c.warrantyDate.fromNow()+" <span class='text-muted'>on "+n(c.warrantyDate)+"</span>":"Warranty <strong>expires</strong> "+c.warrantyDate.fromNow()+" <span class='text-muted'>on "+n(c.warrantyDate)+"</span>",g.push({kind:"warranty",priority:h.Low,message:o,inWarranty:w})}if("expired"==c.status){var o="Item was <strong>expired</strong> "+(c.expired?"<span class='text-muted'>"+c.expired.fromNow()+"</span>":"");g.push({kind:"expired",priority:h.Critical,message:o})}return $.when(k,l,m).then(function(){return g.sort(function(a,b){return a.priority-b.priority})})},d}(b,g,h),j={getFriendlyConflictKind:function(a){switch(a){case"location":return"At wrong location";case"order":return"Checked out";case"reservation":return"Already reserved";case"expired":return"Item is expired";case"custody":return"Item is in custody";case"not_allowed_reservation":return"Item cannot be reserved";case"not_allowed_order":return"Item cannot be checked out";default:return""}}},k=function(){var a=function(a){return"string"==typeof a?a:a.name};return{getCategoryKeyFromName:function(a){return"cheqroom.types.item."+a.split(" ").join("_").split(".").join("").toLowerCase()},getCategoryNameFromKey:function(a){var b=new RegExp("_","g");return a.split(".").pop().replace(b," ")},getCategorySummary:function(b){if(b=b||[],0==b.length)return"No items";for(var c=null,d=null,e=null,f={},g="",h=0,i=0,j=b.length;j>i;i++)c=b[i],e=c.category?a(c.category):"",d=e?this.getCategoryNameFromKey(e):"",f[d]?f[d]+=1:f[d]=1,f[d]>h&&(g=d,h=f[d]);var k=f[g]+" ";if(k+=1==h&&String.prototype.singularize?g.singularize():g,b.length>f[g]){var l=b.length-f[g];k+=" +"+l+" other"}return k},getItemSummary:function(a){if(a=a||[],0==a.length)return"No items";for(var b=", ",c=null,d=0,e={},f=[],g=0,h=a.length;h>g;g++)c=a[g],c.kit&&c.kit.name?e[c.kit.name]?e[c.kit.name].push(c):(e[c.kit.name]=[c],d+=1):f.push(c);if(0==d)return this.getCategorySummary(a);var i=$.map(e,function(a,b){return b});if(0==f.length){var j=30;return i.joinOther(j,b,"other kits")}return 1==d?i[0]+b+this.getCategorySummary(f):h(i)+" kits"+b+this.getCategorySummary(f)}}}(),l=function(a){return{getAvatarInitial:function(b,c){b=b||"Unknown";var d={XS:32,S:64,M:128,L:256,XL:512},e=["#1abc9c","#2ecc71","#3498db","#9b59b6","#34495e","#16a085","#27ae60","#2980b9","#8e44ad","#2c3e50","#f1c40f","#e67e22","#e74c3c","#95a5a6","#f39c12","#d35400","#c0392b","#bdc3c7"],f=b.split(" "),g=2==f.length?f[0].charAt(0).toUpperCase()+f[1].charAt(0).toUpperCase():f[0].charAt(0).toUpperCase(),h=g.charCodeAt(0)-65,i=h%e.length,j=d[c],k=d[c],l=j,m=k,n=a("<canvas />").attr({width:j,height:k}),o=n.get(0).getContext("2d");return window.devicePixelRatio&&(n.attr("width",j*window.devicePixelRatio),n.attr("height",k*window.devicePixelRatio),n.css("width",l),n.css("height",m),o.scale(window.devicePixelRatio,window.devicePixelRatio)),o.fillStyle=e[i],o.fillRect(0,0,j,k),o.font=j/2+"px Arial",o.textAlign="center",o.fillStyle="#FFF",o.fillText(g,l/2,m/1.5),n.get(0).toDataURL()},getMaintenanceAvatar:function(a){return this.getIconAvatar(a,"f0ad")},getIconAvatar:function(b,c,d,e,f){var g={XS:32,S:64,M:128,L:256,XL:512},h=g[b],i=g[b],j=h,k=i;d||(d="#aaa"),e||(e="#f5f5f5"),f||(f=h/2);var l=a("<canvas />").attr({width:h,height:i}),m=l.get(0).getContext("2d");return window.devicePixelRatio&&(l.attr("width",h*window.devicePixelRatio),l.attr("height",i*window.devicePixelRatio),l.css("width",j),l.css("height",k),m.scale(window.devicePixelRatio,window.devicePixelRatio)),m.fillStyle=e,m.fillRect(0,0,h,i),m.font=f+"px FontAwesome",m.textAlign="center",m.fillStyle=d,m.fillText(String.fromCharCode("0x"+c),j/2,k/1.5),l.get(0).toDataURL()},getTextImage:function(b,c,d,e){var f={XS:32,S:64,M:128,L:256,XL:512};d||(d="#aaa"),e||(e="#e5e5e5");var g=f[c],h=f[c],i=g,j=h,k=a("<canvas />").attr({width:g,height:h}),l=k.get(0).getContext("2d");return window.devicePixelRatio&&(k.attr("width",g*window.devicePixelRatio),k.attr("height",h*window.devicePixelRatio),k.css("width",i),k.css("height",j),l.scale(window.devicePixelRatio,window.devicePixelRatio)),l.fillStyle=e,l.fillRect(0,0,g,h),l.font=g/2.7+"px Arial",l.textAlign="center",l.fillStyle=d,l.fillText(b,i/2,j/1.5),k.get(0).toDataURL()},getImageUrl:function(a,b,c,d){var e=a.getBaseUrl()+b+"?mimeType=image/jpeg";return c&&"orig"!=c&&(e+="&size="+c),d&&(e+="&_bust="+(new Date).getTime()),e},getImageCDNUrl:function(a,b,c,d){var e="https://assets.cheqroomcdn.com/"+a.amazonBucket+"/groups/"+b+"/"+c;if(d&&d.length>0){{var f=e.split(".");-1!=c.indexOf(".")?f.pop():""}e=f.join(".")+"-"+d+".jpg"}return e},getNoImage:function(a){return this.getIconAvatar(a,"f03e","rgba(0,0,0,0.2)","rgba(255,255,255,0.5)")}}}(a),m=function(a){var b=["jpg","jpeg","png","gif"];return{getImgFileNameFromName:function(b){return null!=b&&b.length>0?b.split(" ").join("_").split(".").join("_")+".jpg":"upload "+a().format("YYYY-MM-DD at hh:mm:ss a")+".jpg"},makeFileNameJpg:function(a){return a.indexOf(".")>=0?a.substr(0,a.lastIndexOf("."))+".jpg":a},getFileNameFromUrl:function(a){if(a){var b=a.toString().match(/.*\/(.+?)\./);if(b&&b.length>1)return b[1]}return""},isImage:function(a){var c=this.getExt(a);return $.inArray(c,b)>=0},getExt:function(a){var b=/(?:\.([^.]+))?$/;return(b.exec(a)[1]||"").toLowerCase()}}}(b),n=function(){String.prototype.pluralize=function(a,b){return"is"==this&&1!=a?"are":"this"==this?1==a?this:"these":this.endsWith("s")?(b=b||"es",1==a?this:this+b):this.endsWith("y")?(b=b||"ies",1==a?this:this.substr(0,this.length-1)+b):(b=b||"s",1==a?this:this+b)},String.prototype.capitalize=function(a){return(a?this.toLowerCase():this).replace(/(?:^|\s)\S/g,function(a){return a.toUpperCase()})},String.prototype.startsWith||(String.prototype.startsWith=function(a){return 0==this.indexOf(a)}),String.prototype.endsWith||(String.prototype.endsWith=function(a){return this.length<a.length?!1:this.lastIndexOf(a)==this.length-a.length}),String.prototype.truncate||(String.prototype.truncate=function(a){a=null!=a?a:25;var b=this.match(RegExp("^.{0,"+a+"}[S]*")),c=b[0].length;return b=b[0].replace(/\s$/,""),c<this.length&&(b+="&hellip;"),b}),String.prototype.isValidUrl||(String.prototype.isValidUrl=function(){var a=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i");return a.test(this)?!0:!1}),String.prototype.hashCode||(String.prototype.hashCode=function(){var a,b,c,d=0;if(0==this.length)return d;for(a=0,c=this.length;c>a;a++)b=this.charCodeAt(a),d=(d<<5)-d+b,d|=0;return d});var a={};a.latin_map={"Á":"A","Ă":"A","Ắ":"A","Ặ":"A","Ằ":"A","Ẳ":"A","Ẵ":"A","Ǎ":"A","Â":"A","Ấ":"A","Ậ":"A","Ầ":"A","Ẩ":"A","Ẫ":"A","Ä":"A","Ǟ":"A","Ȧ":"A","Ǡ":"A","Ạ":"A","Ȁ":"A","À":"A","Ả":"A","Ȃ":"A","Ā":"A","Ą":"A","Å":"A","Ǻ":"A","Ḁ":"A","Ⱥ":"A","Ã":"A","Ꜳ":"AA","Æ":"AE","Ǽ":"AE","Ǣ":"AE","Ꜵ":"AO","Ꜷ":"AU","Ꜹ":"AV","Ꜻ":"AV","Ꜽ":"AY","Ḃ":"B","Ḅ":"B","Ɓ":"B","Ḇ":"B","Ƀ":"B","Ƃ":"B","Ć":"C","Č":"C","Ç":"C","Ḉ":"C","Ĉ":"C","Ċ":"C","Ƈ":"C","Ȼ":"C","Ď":"D","Ḑ":"D","Ḓ":"D","Ḋ":"D","Ḍ":"D","Ɗ":"D","Ḏ":"D","ǲ":"D","ǅ":"D","Đ":"D","Ƌ":"D","Ǳ":"DZ","Ǆ":"DZ","É":"E","Ĕ":"E","Ě":"E","Ȩ":"E","Ḝ":"E","Ê":"E","Ế":"E","Ệ":"E","Ề":"E","Ể":"E","Ễ":"E","Ḙ":"E","Ë":"E","Ė":"E","Ẹ":"E","Ȅ":"E","È":"E","Ẻ":"E","Ȇ":"E","Ē":"E","Ḗ":"E","Ḕ":"E","Ę":"E","Ɇ":"E","Ẽ":"E","Ḛ":"E","Ꝫ":"ET","Ḟ":"F","Ƒ":"F","Ǵ":"G","Ğ":"G","Ǧ":"G","Ģ":"G","Ĝ":"G","Ġ":"G","Ɠ":"G","Ḡ":"G","Ǥ":"G","Ḫ":"H","Ȟ":"H","Ḩ":"H","Ĥ":"H","Ⱨ":"H","Ḧ":"H","Ḣ":"H","Ḥ":"H","Ħ":"H","Í":"I","Ĭ":"I","Ǐ":"I","Î":"I","Ï":"I","Ḯ":"I","İ":"I","Ị":"I","Ȉ":"I","Ì":"I","Ỉ":"I","Ȋ":"I","Ī":"I","Į":"I","Ɨ":"I","Ĩ":"I","Ḭ":"I","Ꝺ":"D","Ꝼ":"F","Ᵹ":"G","Ꞃ":"R","Ꞅ":"S","Ꞇ":"T","Ꝭ":"IS","Ĵ":"J","Ɉ":"J","Ḱ":"K","Ǩ":"K","Ķ":"K","Ⱪ":"K","Ꝃ":"K","Ḳ":"K","Ƙ":"K","Ḵ":"K","Ꝁ":"K","Ꝅ":"K","Ĺ":"L","Ƚ":"L","Ľ":"L","Ļ":"L","Ḽ":"L","Ḷ":"L","Ḹ":"L","Ⱡ":"L","Ꝉ":"L","Ḻ":"L","Ŀ":"L","Ɫ":"L","ǈ":"L","Ł":"L","Ǉ":"LJ","Ḿ":"M","Ṁ":"M","Ṃ":"M","Ɱ":"M","Ń":"N","Ň":"N","Ņ":"N","Ṋ":"N","Ṅ":"N","Ṇ":"N","Ǹ":"N","Ɲ":"N","Ṉ":"N","Ƞ":"N","ǋ":"N","Ñ":"N","Ǌ":"NJ","Ó":"O","Ŏ":"O","Ǒ":"O","Ô":"O","Ố":"O","Ộ":"O","Ồ":"O","Ổ":"O","Ỗ":"O","Ö":"O","Ȫ":"O","Ȯ":"O","Ȱ":"O","Ọ":"O","Ő":"O","Ȍ":"O","Ò":"O","Ỏ":"O","Ơ":"O","Ớ":"O","Ợ":"O","Ờ":"O","Ở":"O","Ỡ":"O","Ȏ":"O","Ꝋ":"O","Ꝍ":"O","Ō":"O","Ṓ":"O","Ṑ":"O","Ɵ":"O","Ǫ":"O","Ǭ":"O","Ø":"O","Ǿ":"O","Õ":"O","Ṍ":"O","Ṏ":"O","Ȭ":"O","Ƣ":"OI","Ꝏ":"OO","Ɛ":"E","Ɔ":"O","Ȣ":"OU","Ṕ":"P","Ṗ":"P","Ꝓ":"P","Ƥ":"P","Ꝕ":"P","Ᵽ":"P","Ꝑ":"P","Ꝙ":"Q","Ꝗ":"Q","Ŕ":"R","Ř":"R","Ŗ":"R","Ṙ":"R","Ṛ":"R","Ṝ":"R","Ȑ":"R","Ȓ":"R","Ṟ":"R","Ɍ":"R","Ɽ":"R","Ꜿ":"C","Ǝ":"E","Ś":"S","Ṥ":"S","Š":"S","Ṧ":"S","Ş":"S","Ŝ":"S","Ș":"S","Ṡ":"S","Ṣ":"S","Ṩ":"S","Ť":"T","Ţ":"T","Ṱ":"T","Ț":"T","Ⱦ":"T","Ṫ":"T","Ṭ":"T","Ƭ":"T","Ṯ":"T","Ʈ":"T","Ŧ":"T","Ɐ":"A","Ꞁ":"L","Ɯ":"M","Ʌ":"V","Ꜩ":"TZ","Ú":"U","Ŭ":"U","Ǔ":"U","Û":"U","Ṷ":"U","Ü":"U","Ǘ":"U","Ǚ":"U","Ǜ":"U","Ǖ":"U","Ṳ":"U","Ụ":"U","Ű":"U","Ȕ":"U","Ù":"U","Ủ":"U","Ư":"U","Ứ":"U","Ự":"U","Ừ":"U","Ử":"U","Ữ":"U","Ȗ":"U","Ū":"U","Ṻ":"U","Ų":"U","Ů":"U","Ũ":"U","Ṹ":"U","Ṵ":"U","Ꝟ":"V","Ṿ":"V","Ʋ":"V","Ṽ":"V","Ꝡ":"VY","Ẃ":"W","Ŵ":"W","Ẅ":"W","Ẇ":"W","Ẉ":"W","Ẁ":"W","Ⱳ":"W","Ẍ":"X","Ẋ":"X","Ý":"Y","Ŷ":"Y","Ÿ":"Y","Ẏ":"Y","Ỵ":"Y","Ỳ":"Y","Ƴ":"Y","Ỷ":"Y","Ỿ":"Y","Ȳ":"Y","Ɏ":"Y","Ỹ":"Y","Ź":"Z","Ž":"Z","Ẑ":"Z","Ⱬ":"Z","Ż":"Z","Ẓ":"Z","Ȥ":"Z","Ẕ":"Z","Ƶ":"Z","Ĳ":"IJ","Œ":"OE","ᴀ":"A","ᴁ":"AE","ʙ":"B","ᴃ":"B","ᴄ":"C","ᴅ":"D","ᴇ":"E","ꜰ":"F","ɢ":"G","ʛ":"G","ʜ":"H","ɪ":"I","ʁ":"R","ᴊ":"J","ᴋ":"K","ʟ":"L","ᴌ":"L","ᴍ":"M","ɴ":"N","ᴏ":"O","ɶ":"OE","ᴐ":"O","ᴕ":"OU","ᴘ":"P","ʀ":"R","ᴎ":"N","ᴙ":"R","ꜱ":"S","ᴛ":"T","ⱻ":"E","ᴚ":"R","ᴜ":"U","ᴠ":"V","ᴡ":"W","ʏ":"Y","ᴢ":"Z","á":"a","ă":"a","ắ":"a","ặ":"a","ằ":"a","ẳ":"a","ẵ":"a","ǎ":"a","â":"a","ấ":"a","ậ":"a","ầ":"a","ẩ":"a","ẫ":"a","ä":"a","ǟ":"a","ȧ":"a","ǡ":"a","ạ":"a","ȁ":"a","à":"a","ả":"a","ȃ":"a","ā":"a","ą":"a","ᶏ":"a","ẚ":"a","å":"a","ǻ":"a","ḁ":"a","ⱥ":"a","ã":"a","ꜳ":"aa","æ":"ae","ǽ":"ae","ǣ":"ae","ꜵ":"ao","ꜷ":"au","ꜹ":"av","ꜻ":"av","ꜽ":"ay","ḃ":"b","ḅ":"b","ɓ":"b","ḇ":"b","ᵬ":"b","ᶀ":"b","ƀ":"b","ƃ":"b","ɵ":"o","ć":"c","č":"c","ç":"c","ḉ":"c","ĉ":"c","ɕ":"c","ċ":"c","ƈ":"c","ȼ":"c","ď":"d","ḑ":"d","ḓ":"d","ȡ":"d","ḋ":"d","ḍ":"d","ɗ":"d","ᶑ":"d","ḏ":"d","ᵭ":"d","ᶁ":"d","đ":"d","ɖ":"d","ƌ":"d","ı":"i","ȷ":"j","ɟ":"j","ʄ":"j","ǳ":"dz","ǆ":"dz","é":"e","ĕ":"e","ě":"e","ȩ":"e","ḝ":"e","ê":"e","ế":"e","ệ":"e","ề":"e","ể":"e","ễ":"e","ḙ":"e","ë":"e","ė":"e","ẹ":"e","ȅ":"e","è":"e","ẻ":"e","ȇ":"e","ē":"e","ḗ":"e","ḕ":"e","ⱸ":"e","ę":"e","ᶒ":"e","ɇ":"e","ẽ":"e","ḛ":"e","ꝫ":"et","ḟ":"f","ƒ":"f","ᵮ":"f","ᶂ":"f","ǵ":"g","ğ":"g","ǧ":"g","ģ":"g","ĝ":"g","ġ":"g","ɠ":"g","ḡ":"g",
"ᶃ":"g","ǥ":"g","ḫ":"h","ȟ":"h","ḩ":"h","ĥ":"h","ⱨ":"h","ḧ":"h","ḣ":"h","ḥ":"h","ɦ":"h","ẖ":"h","ħ":"h","ƕ":"hv","í":"i","ĭ":"i","ǐ":"i","î":"i","ï":"i","ḯ":"i","ị":"i","ȉ":"i","ì":"i","ỉ":"i","ȋ":"i","ī":"i","į":"i","ᶖ":"i","ɨ":"i","ĩ":"i","ḭ":"i","ꝺ":"d","ꝼ":"f","ᵹ":"g","ꞃ":"r","ꞅ":"s","ꞇ":"t","ꝭ":"is","ǰ":"j","ĵ":"j","ʝ":"j","ɉ":"j","ḱ":"k","ǩ":"k","ķ":"k","ⱪ":"k","ꝃ":"k","ḳ":"k","ƙ":"k","ḵ":"k","ᶄ":"k","ꝁ":"k","ꝅ":"k","ĺ":"l","ƚ":"l","ɬ":"l","ľ":"l","ļ":"l","ḽ":"l","ȴ":"l","ḷ":"l","ḹ":"l","ⱡ":"l","ꝉ":"l","ḻ":"l","ŀ":"l","ɫ":"l","ᶅ":"l","ɭ":"l","ł":"l","ǉ":"lj","ſ":"s","ẜ":"s","ẛ":"s","ẝ":"s","ḿ":"m","ṁ":"m","ṃ":"m","ɱ":"m","ᵯ":"m","ᶆ":"m","ń":"n","ň":"n","ņ":"n","ṋ":"n","ȵ":"n","ṅ":"n","ṇ":"n","ǹ":"n","ɲ":"n","ṉ":"n","ƞ":"n","ᵰ":"n","ᶇ":"n","ɳ":"n","ñ":"n","ǌ":"nj","ó":"o","ŏ":"o","ǒ":"o","ô":"o","ố":"o","ộ":"o","ồ":"o","ổ":"o","ỗ":"o","ö":"o","ȫ":"o","ȯ":"o","ȱ":"o","ọ":"o","ő":"o","ȍ":"o","ò":"o","ỏ":"o","ơ":"o","ớ":"o","ợ":"o","ờ":"o","ở":"o","ỡ":"o","ȏ":"o","ꝋ":"o","ꝍ":"o","ⱺ":"o","ō":"o","ṓ":"o","ṑ":"o","ǫ":"o","ǭ":"o","ø":"o","ǿ":"o","õ":"o","ṍ":"o","ṏ":"o","ȭ":"o","ƣ":"oi","ꝏ":"oo","ɛ":"e","ᶓ":"e","ɔ":"o","ᶗ":"o","ȣ":"ou","ṕ":"p","ṗ":"p","ꝓ":"p","ƥ":"p","ᵱ":"p","ᶈ":"p","ꝕ":"p","ᵽ":"p","ꝑ":"p","ꝙ":"q","ʠ":"q","ɋ":"q","ꝗ":"q","ŕ":"r","ř":"r","ŗ":"r","ṙ":"r","ṛ":"r","ṝ":"r","ȑ":"r","ɾ":"r","ᵳ":"r","ȓ":"r","ṟ":"r","ɼ":"r","ᵲ":"r","ᶉ":"r","ɍ":"r","ɽ":"r","ↄ":"c","ꜿ":"c","ɘ":"e","ɿ":"r","ś":"s","ṥ":"s","š":"s","ṧ":"s","ş":"s","ŝ":"s","ș":"s","ṡ":"s","ṣ":"s","ṩ":"s","ʂ":"s","ᵴ":"s","ᶊ":"s","ȿ":"s","ɡ":"g","ᴑ":"o","ᴓ":"o","ᴝ":"u","ť":"t","ţ":"t","ṱ":"t","ț":"t","ȶ":"t","ẗ":"t","ⱦ":"t","ṫ":"t","ṭ":"t","ƭ":"t","ṯ":"t","ᵵ":"t","ƫ":"t","ʈ":"t","ŧ":"t","ᵺ":"th","ɐ":"a","ᴂ":"ae","ǝ":"e","ᵷ":"g","ɥ":"h","ʮ":"h","ʯ":"h","ᴉ":"i","ʞ":"k","ꞁ":"l","ɯ":"m","ɰ":"m","ᴔ":"oe","ɹ":"r","ɻ":"r","ɺ":"r","ⱹ":"r","ʇ":"t","ʌ":"v","ʍ":"w","ʎ":"y","ꜩ":"tz","ú":"u","ŭ":"u","ǔ":"u","û":"u","ṷ":"u","ü":"u","ǘ":"u","ǚ":"u","ǜ":"u","ǖ":"u","ṳ":"u","ụ":"u","ű":"u","ȕ":"u","ù":"u","ủ":"u","ư":"u","ứ":"u","ự":"u","ừ":"u","ử":"u","ữ":"u","ȗ":"u","ū":"u","ṻ":"u","ų":"u","ᶙ":"u","ů":"u","ũ":"u","ṹ":"u","ṵ":"u","ᵫ":"ue","ꝸ":"um","ⱴ":"v","ꝟ":"v","ṿ":"v","ʋ":"v","ᶌ":"v","ⱱ":"v","ṽ":"v","ꝡ":"vy","ẃ":"w","ŵ":"w","ẅ":"w","ẇ":"w","ẉ":"w","ẁ":"w","ⱳ":"w","ẘ":"w","ẍ":"x","ẋ":"x","ᶍ":"x","ý":"y","ŷ":"y","ÿ":"y","ẏ":"y","ỵ":"y","ỳ":"y","ƴ":"y","ỷ":"y","ỿ":"y","ȳ":"y","ẙ":"y","ɏ":"y","ỹ":"y","ź":"z","ž":"z","ẑ":"z","ʑ":"z","ⱬ":"z","ż":"z","ẓ":"z","ȥ":"z","ẕ":"z","ᵶ":"z","ᶎ":"z","ʐ":"z","ƶ":"z","ɀ":"z","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ĳ":"ij","œ":"oe","ﬆ":"st","ₐ":"a","ₑ":"e","ᵢ":"i","ⱼ":"j","ₒ":"o","ᵣ":"r","ᵤ":"u","ᵥ":"v","ₓ":"x"},String.prototype.latinise=function(){return this.replace(/[^A-Za-z0-9\[\] ]/g,function(b){return a.latin_map[b]||b})},String.prototype.latinize=String.prototype.latinise,String.prototype.isLatin=function(){return this==this.latinise()},String.prototype.OnlyAlphaNumSpaceAndUnderscore=function(){return $.trim(this).toLowerCase().replace(/[\s-]+/g,"_").latinise().replace(/[\W]/g,"")},String.prototype.OnlyAlphaNumSpaceUnderscoreAndDot=function(){return $.trim(this).toLowerCase().replace(/[\s-]+/g,"_").latinise().replace(/[^a-z0-9_\.]/g,"")},String.prototype.NoWhiteSpaceInWord||(String.prototype.NoWhiteSpaceInWord=function(){return this.replace(/[\s]+/g,"")}),String.prototype.addLeadingZero||(String.prototype.addLeadingZero=function(a){var b=this.toString();return b.length<a?("0"+b).addLeadingZero(a):b}),String.prototype.lpad=function(a,b){for(var c=this;c.length<b;)c=a+c;return c},String.prototype.trimLeft||(String.prototype.trimLeft=function(){return this.replace(/^\s+/,"")}),String.prototype.trimRight||(String.prototype.trimRight=function(){return this.replace(/\s+$/,"")}),Number.prototype.between||(Number.prototype.between=function(a,b){var c=Math.min(a,b),d=Math.max(a,b);return this>=c&&d>=this}),Array.prototype.joinOther||(Array.prototype.joinOther=function(a,b,c){if(this.length<2)return this.join(b);b=b||", ",c=c||"other",(!a||0>a)&&(a=1);for(var d=this.slice(0),e=d.join(b);d.length>1&&e.length>a;)d.pop(),e=d.join(b);var f=this.length-d.length;return f>0&&(e+=" +"+f+" "+c),e}),Array.prototype.joinAdvanced||(Array.prototype.joinAdvanced=function(a,b){var c=this.slice(0),d="";return 1===c.length?d=c[0]:2===c.length?d=c.join(b):c.length>2&&(d=c.slice(0,-1).join(a)+b+c.slice(-1)),d}),Array.prototype.find||(Array.prototype.find=function(a){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(b=c[f],a.call(e,b,f,c))return b;return void 0}),Object.values||(Object.values=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}),CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e,f,g){var h={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0};if("undefined"==typeof g&&(g=!0),"object"==typeof e)for(var i in e)h[i]=e[i];this.beginPath(),this.moveTo(a+h.upperLeft,b),this.lineTo(a+c-h.upperRight,b),this.quadraticCurveTo(a+c,b,a+c,b+h.upperRight),this.lineTo(a+c,b+d-h.lowerRight),this.quadraticCurveTo(a+c,b+d,a+c-h.lowerRight,b+d),this.lineTo(a+h.lowerLeft,b+d),this.quadraticCurveTo(a,b+d,a,b+d-h.lowerLeft),this.lineTo(a,b+h.upperLeft),this.quadraticCurveTo(a,b,a+h.upperLeft,b),this.closePath(),g&&this.stroke(),f&&this.fill()}}(),o=function(a){return{isValidEmail:function(a){var b=a.match(/^([\w-\+']+(?:\.[\w-\+']+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,}(?:\.[a-z]{2})?)$/i);return null!=b&&b.length>0},isFreeEmail:function(a){var b=a.match(/^([\w-\+]+(?:\.[\w-\+]+)*)@(?!gmail\.com)(?!yahoo\.com)(?!hotmail\.com)(?!163\.com)(?!qq\.com)((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,}(?:\.[a-z]{2})?)$/i);return null==b},isValidPhone:function(a){if(a=a.replace(/[^A-Za-z 0-9 \.,\?""!@#\$%\^&\*\(\)-_=\+;:<>\/\\\|\}\{\[\]`~]*/g,""),$.isNumeric(a))return!0;var b=a.match(/^[\s()+-]*([0-9][\s()+-]*){7,20}(( x| ext)\d{1,5}){0,1}$/);return null!=b&&b.length>0},isValidURL:function(a){var b=a.match(/^(https?|ftp):\/\/([a-zA-Z0-9.-]+(:[a-zA-Z0-9.&%$-]+)*@)*((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3}|([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{1,}))(:[0-9]+)*(\/($|[a-zA-Z0-9.,?'\\+&%$#=~_@\!-]+))*$/);return null!=b&&b.length>0},isValidPassword:function(a){var b=a.match(/[0-9]/);return a.length>=4&&b},isNumeric:function(a,b){$.isNumeric(a);return b?(0^a)===Number(a):$.isNumeric(a)},isValidDate:function(b){return isNaN(b)||(b=parseInt(b)),a(b).isValid()}}}(b),p=function(a){var b={};return b.sortFields=function(b,c,d,e){var f=[],g=null,h=null;c=c.slice(),null!=d&&(c=c.filter(function(a){return a.form==d}));for(var i=0;i<c.length&&(g=c[i],h=b[g.name],f.push(a.extend({value:h},g)),!(null!=e&&f.length>=e));i++);return f},b.stringifyOrdered=function(a){if(keys=[],a)for(var b in a)keys.push(b);keys.sort();var b,c={};for(var d in keys)b=keys[d],c[b]=a[b];return JSON.stringify(c)},b.areEqual=function(a,c){return b.stringifyOrdered(a||{})==b.stringifyOrdered(c||{})},b.badgeify=function(a){return a>100?"99+":a>10?"10+":a>0?""+a:""},b.getLoginName=function(a,b){var c=/[\s-]*/gim,d=[];return a&&d.push(a.latinise().toLowerCase().replace(c,"")),b&&d.push(b.latinise().toLowerCase().replace(c,"")),d.join(".")},b.getUrlParam=function(a,b,c){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var d="[\\?&]"+a+"=([^&#]*)",e=new RegExp(d),f=e.exec(c||window.location.href);return f?decodeURIComponent(f[1].replace(/\+/g," ")):b},a.urlParam=b.getUrlParam,b.getParsedLines=function(b){if(b&&b.length>0){var c=b.split(/\s*([,;\r\n]+|\s\s)\s*/);return c.filter(function(b,c,d){return b.length>0&&b.indexOf(",")<0&&b.indexOf(";")<0&&a.trim(b).length>0&&d.indexOf(b)>=c}).map(function(b){return a.trim(b)})}return[]},b.getFriendlyFileName=function(a){return a.replace(/[^a-z0-9]/gi,"_").toLowerCase()},b.getFriendlyKind=function(a){var b=a;return"string"==a&&(b="single line text"),"text"==a&&(b="multi line text"),"select"==a&&(b="dropdown list"),"number"==a&&(b="numeric"),b},b.arrayToCSV=function(a,b){var c,d;c=new Blob([a],{type:"text/csv"}),window.navigator&&window.navigator.msSaveOrOpenBlob?window.navigator.msSaveOrOpenBlob(c,b):(d=window.document.createElement("a"),d.download=b,d.href=window.URL.createObjectURL(c),d.style.display="none",window.document.body.appendChild(d),d.click())},b}(a),q=function(){var a=function(){function a(a,b){var c=(""+a).trimLeft().trimRight();return/^<\/?(ul|ol|li|h|p|bl)/i.test(c)?c:(c=c.replace(/\n/g,"<br />"),"<p>"+c+"</p>")}function b(a,b){return"\n<ul>\n	<li>"+b.trim()+"</li>\n</ul>"}function c(a,b){return"\n<ol>\n	<li>"+b.trim()+"</li>\n</ol>"}function d(a,b,c){return"\n<blockquote>"+c.trim()+"</blockquote>"}function e(a,b,c){var d=b.length;return"<h"+d+">"+c.trim()+"</h"+d+">"}function f(a){var b=a.match(/(\(?https?:\/\/[-A-Za-z0-9+&@#\/%?=~_()|!:,.;]*[-A-Za-z0-9+&@#\/%=~_()|])(">|<\/a>|\)|\])?/gm);if(null==b)return a;for(var c={},d=0;d<b.length;d++){var e=b[d];if(-1!=e.lastIndexOf("]")||-1!=e.lastIndexOf(")"))break;if(c[e])break;c[e]=e,a=a.replace(e,"["+e+"]("+e+")")}return a}this.rules=[{regex:/(#{1,6})\s(.*)/g,replacement:e},{regex:/!\[([^\[]+)\]\(([^\)]+)\)/g,replacement:"<img src='$2' alt='$1'>"},{regex:/\[([^\[]+)\]\(([^\)]+)\)/g,replacement:"<a href='$2'>$1</a>"},{regex:/(\*\*|__)(.*?)\1/g,replacement:"<strong>$2</strong>"},{regex:/(\*|_)(.*?)\1/g,replacement:"<em>$2</em>"},{regex:/\~\~(.*?)\~\~/g,replacement:"<del>$1</del>"},{regex:/\:\"(.*?)\"\:/g,replacement:"<q>$1</q>"},{regex:/`(.*?)`/g,replacement:"<code>$1</code>"},{regex:/\n\*(.*)/g,replacement:b},{regex:/\n[0-9]+\.\s(.*)/g,replacement:c},{regex:/\n(&gt;|\>)(.*)/g,replacement:d},{regex:/\n-{5,}/g,replacement:"\n<hr />"},{regex:/<\/ul>\s?<ul>/g,replacement:""},{regex:/<\/ol>\s?<ol>/g,replacement:""},{regex:/(?:[^\n]|(?:<[^>].*>)\n(?! *\n))+/g,replacement:a},{regex:/<\/blockquote><blockquote>/g,replacement:"\n"}],this.addRule=function(a,b){a.global=!0,a.multiline=!1,this.rules.push({regex:a,replacement:b})},this.render=function(a){return a="\n"+a+"\n",a=f(a),this.rules.forEach(function(b){a=a.replace(b.regex,b.replacement)}),a.trim()}};window.Slimdown=a}(),r=function(a,b,c,d,e){var f={};return f.kitCanCheckout=function(a){return void 0!==a.canOrder?"available"===a.canOrder||"available_partially"===a.canOrder:!0},f.kitCanReserve=function(a){return void 0!==a.canReserve?"available"===a.canReserve||"available_partially"===a.canReserve:!0},f.kitCanTakeCustody=function(a){var b=void 0!==a.canCustody?"available"===a.canCustody:!0;return b&&"available"==a.status},f.kitCanReleaseCustody=function(a){var b=void 0!==a.canCustody?"available"===a.canCustody:!0;return b&&"in_custody"==a.status},f.kitCanTransferCustody=function(a){var b=void 0!==a.canCustody?"available"===a.canCustody:!0;return b&&"in_custody"==a.status},f.getKitStatus=function(b){var c={},d=[],e={},f=[];return a.each(b,function(a,b){c[b.status]||(c[b.status]=!0,d.push(b.status)),e[b.order]||(e[b.order]=!0,f.push(b.order))}),1==d.length&&f.length<=1?d[0]:"incomplete"},f.getFriendlyKitStatus=function(a){return"incomplete"==a?"Incomplete":b.getFriendlyItemStatus(a)},f.getKitStatusCss=function(a){return"incomplete"==a?"label-incomplete":b.getItemStatusCss(a)},f.getKitStatusIcon=function(a){switch(a){case"available":return"fa fa-check-circle";case"checkedout":return"fa fa-times-circle";case"await_checkout":return"fa fa-ellipsis-h";case"incomplete":return"fa fa-warning";case"empty":return"fa fa-ellipsis-h";case"in_transit":return"fa fa-truck";case"in_custody":return"fa fa-exchange";case"maintenance":return"fa fa-wrench";case"repair":return"fa fa-wrench";case"inspection":return"fa fa-stethoscope";case"expired":return"fa fa-bug";default:return""}},f.getKitIds=function(b){var c={},d=[];return a.each(b,function(a,b){if(b.kit){var e="string"==typeof b.kit?b.kit:b.kit._id;c[e]||(c[e]=!0,d.push(e))}}),d},f.getKitMessages=function(e,f,g,h){var i=[],j={Critical:0,High:1,Medium:2,Low:3},k=g,l=!k.hasContactReadOtherPermission(),m=a.Deferred(),n=a.Deferred(),o=a.Deferred(),p=function(a){return a.format("MMMM Do"+(a.year()==c().year()?"":" YYYY"))};if(!k.hasCheckoutPermission("read")||"checkedout"!=e.status&&"await_checkout"!=e.status)m.resolve();else{var q="",r=a.Deferred();l?r.resolve(null):f("orders").search({_fields:"name,itemSummary,status,started,due,finished,customer.name,customer.user.picture,customer.cover,customer.kind",_restrict:!l,_sort:"started",status:"checkedout"==e.status?"open":"creating",_limit:1,_skip:0,items__in:b.getItemIds(e.items)}).then(function(a){a&&a.count>0&&r.resolve(a.docs[0])}),r.then(function(a){q="await_checkout"==e.status?"Kit is currently <strong>awaiting checkout</strong>":a&&d.isOrderOverdue(a)?"Kit was <strong>due back</strong> "+a.due.fromNow()+" from "+a.customer.name:"Kit is <strong>checked out</strong>"+(a?" to "+a.customer.name+" until "+p(a.due):""),i.push({kind:"checkout",priority:j.Critical,message:q,checkout:a||{}}),m.resolve()})}if(k.hasReservationPermission("read")&&e.items.length>0?f("reservations").search({status:"open",fromDate__gte:c(),_fields:"name,status,itemSummary,fromDate,toDate,customer.name,customer.user.picture,customer.cover,customer.kind",_restrict:!l,_sort:"fromDate",_limit:1,_skip:0,items__in:b.getItemIds(e.items)}).then(function(a){if(a&&a.count>0){var b=a.docs[0];q="Next <strong>reservation</strong> is "+b.fromDate.fromNow()+" <span class='text-muted'>on "+p(b.fromDate)+"</span>",i.push({kind:"reservation",priority:j.High,reservation:b,message:q})}n.resolve()}):n.resolve(),"in_custody"==e.status){var r=a.Deferred();l?r.resolve(null):f("kits").call(e.id,"getChangeLog",{action__in:["takeCustody"],limit:1,skip:0}).then(function(a){f("contacts").get(a[0].obj,"name,cover,user.picture,kind").then(function(b){r.resolve(b,a[0].created)})}),r.then(function(a,b){var c="Kit is <strong>in custody</strong>"+(a?" of "+a.name+" <span class='text-muted'>since "+p(b)+"</span>":"");i.push({kind:"custody",priority:j.High,by:a||{},message:c}),o.resolve()})}else o.resolve();var s=k.hasKitPermission("reserve")&&(e._canReserve||e.canReserve),t=k.hasKitPermission("checkout")&&(e._canOrder||e.canOrder),u=k.hasKitPermission("takeCustody")&&(e._canCustody||e.canCustody),v="available"===s||"available_partially"===s,w="available"===t||"available_partially"===t,x="available"===u;if(v||w||x){var y=[],z=[];k.hasReservationPermission("read")&&k.hasCheckoutPermission("read")&&v&&w||!v&&!w?v&&w?z.push("Bookings"):k.hasCheckoutPermission("read")&&k.hasReservationPermission("read")&&y.push("Bookings"):(v?z.push("Reservation"):k.hasReservationPermission("read")&&y.push("Reservation"),w?z.push("Check-out"):k.hasCheckoutPermission("read")&&y.push("Check-out")),x?z.push("Custody"):k.hasItemPermission("takeCustody")&&y.push("Custody");var q="",A=!v&&!x&&!w;q=A?"Kit is <strong>unavailable</strong> for "+y.joinAdvanced(", "," and "):"Kit is <strong>"+("available_partially"==s||"available_partially"==t?"partially ":"")+"available</strong> for "+z.joinAdvanced(", "," and ")+(y.length>0?" <span class='text-muted'>, not for "+y.joinAdvanced(", "," and ")+"</span>":""),i.push({kind:"permission",priority:j.Medium,message:q})}if("empty"==e.status){var q="Kit is <strong>empty</strong>";i.push({kind:"empty",priority:j.Low,message:q})}if("incomplete"==e.status){var q="Kit is <strong>incomplete</strong>",B=e.items,C={};a.each(B,function(a,b){var c=b.status;if("available"==b.status){var d=b.canReserve,e=b.canOrder;"available"!==d&&"unavailable_status"!==d&&"available"!==e&&"unavailable_status"!==e&&(c="unavailable")}var f=C[c]||0;C[c]=f+1});{var D=C.unavailable||0,E=C.checkedout||0,F=C.await_checkout||0,G=C.expired||0,H=C.available||0,I=C.in_custody||0;B.length+" item".pluralize(B.length)}if(H==B.length||E==B.length||F==B.length||G==B.length||I==B.length);else{var J=[];D>0&&J.push(D+" unavailable"),H>0&&J.push(H+" available"),E>0&&J.push(E+" checked out"),F>0&&J.push(F+" awaiting checkout"),G>0&&J.push(G+" expired"),I>0&&J.push(I+" in custody"),q+=" <span class='text-muted'>("+J.joinAdvanced(", "," and ")+")</span>"}i.push({kind:"incomplete",priority:j.Low,message:q})}if("expired"==e.status){var q="Kit is <strong>expired</strong>";i.push({kind:"expired",priority:j.Critical,message:q})}return a.when(m,n,o).then(function(){return i.sort(function(a,b){return a.priority-b.priority})})},f}(a,i,b,g,h),s=function(a,b){var c={};return c.contactGetUserId=function(a){if(a.user){if("string"==typeof a.user)return a.user;if(a.user.hasOwnProperty("_id"))return a._id}},c.contactGetUserSync=function(a){return a.user&&a.user.sync?a.user.sync:void 0},c.contactCanReserve=function(a){return"active"==a.status},c.contactCanCheckout=function(a){return"active"==a.status},c.contactCanGenerateDocument=function(a){return"active"==a.status},c.contactCanArchive=function(a){return"active"==a.status&&!c.contactGetUserSync(a)},c.contactCanUndoArchive=function(a){return"archived"==a.status&&!c.contactGetUserSync(a)},c.contactCanDelete=function(a){return!c.contactGetUserSync(a)},c.contactCanBlock=function(a){return"active"==a.status},c.contactCanUndoBlock=function(a){return"blocked"==a.status},c.getContactImageUrl=function(c,d,e,f){return d.user&&d.user.picture?a.getImageUrl(c,d.user.picture,e,f):d.cover&&b.isImage(d.cover)?a.getImageUrl(c,d.cover,e,f):"maintenance"==d.kind?a.getMaintenanceAvatar(e):a.getAvatarInitial(d.name,e)},c.getContactImageCDNUrl=function(b,c,d,e,f){return d.user&&d.user.picture?a.getImageCDNUrl(b,c,d.user.picture,e,f):d.cover?a.getImageCDNUrl(b,c,d.cover,e,f):"maintenance"==d.kind?a.getMaintenanceAvatar(e):a.getAvatarInitial(d.name,e)},c}(l,m),t=function(a){return{getUserImageUrl:function(b,c,d,e){return c&&c.picture?a.getImageUrl(b,c.picture,d,e):a.getAvatarInitial(c.name,d)},getUserImageCDNUrl:function(b,c,d,e,f){return d&&d.picture?a.getImageCDNUrl(b,c,d.picture,e,f):a.getAvatarInitial(d.name,e)}}}(l),u=function(a){return{templateIsArchived:function(a){return!(null==a.archived)},templateCanDelete:function(a){return!a.system},templateCanActivate:function(a){return"inactive"==a.status&&null==a.archived},templateCanDeactivate:function(a){return"active"==a.status&&null==a.archived},templateCanArchive:function(a){return null==a.archived},templateCanUndoArchive:function(a){return null!=a.archived},getFriendlyTemplateStatus:function(a){switch(a){case"inactive":return"Inactive";case"active":return"Active";case"archived":return"Archived";default:return"Unknown"}},getFriendlyTemplateCss:function(a){switch(a){case"inactive":return"label-inactive";case"active":return"label-active";case"archived":return"label-archived";default:return""}},getFriendlyTemplateSize:function(a,b,c){if(0==a||0==b)return"";if("inch"==c&&(8.5==a&&11==b||11==a&&8.5==b))return"US Letter";if("inch"==c&&(11==a&&17==b||17==a&&11==b))return"US Tabloid";if("mm"==c&&(210==a&&297==b||297==a&&210==b))return"A4";if("cm"==c&&(21==a&&29.7==b||29.7==a&&21==b))return"A4";var d="inch"==c?'"':c;return a+d+" x "+b+d},getPageSizes:function(){return[{id:"letter",name:"US Letter",width:8.5,height:11,unit:"inch",layout:"portrait",px:{width:816,height:1056}},{id:"a4",name:"A4",width:210,height:297,unit:"mm",layout:"portrait",px:{width:793,height:1122}},{id:"tabloid",name:"US Tabloid",width:11,height:17,unit:"inch",layout:"portrait",px:{width:1056,height:1632}},{id:"label4x6",name:'4" x 6" Shipping Label',width:4,height:6,unit:"inch",layout:"portrait",px:{width:384,height:576}}]},getPageSize:function(a,b,c){var d=this.getPageSizes(),e=null;return(e=d.find(function(d){return d.unit==a&&d.width==b&&d.height==c}))?e:(e=d.find(function(d){return d.unit==a&&d.width==c&&d.height==b}),e?(e.layout="landscape",e):null)}}}(b),v=function(){var a=localStorage.setItem,b=localStorage.getItem,c=localStorage.removeItem,d={};Storage.prototype.setItem=function(b,c){try{a.apply(this,[b,c])}catch(e){d[b]=String(c)}return!0},Storage.prototype.getItem=function(a){try{return b.apply(this,[a])}catch(c){return d.hasOwnProperty(a)?d[a]:void 0}return null},Storage.prototype.removeItem=function(a){try{c.apply(this,[a])}catch(b){delete d[a]}return!0}}(),w={containsValue:function(a,b,c){if(a=a||{},c=c||["name","fields","codes","barcodes"],b=$.trim(b).toLowerCase(),-1!=c.indexOf("name")&&a.name&&-1!=a.name.toLowerCase().indexOf(b))return!0;if(-1!=c.indexOf("fields")&&a.fields){var d=Object.values(a.fields).find(function(a){return-1!=a.toString().toLowerCase().indexOf(b)});if(d)return!0}if(-1!=c.indexOf("codes")&&a.codes){var d=a.codes.find(function(a){return-1!=a.toLowerCase().indexOf(b)});if(d)return!0}if(-1!=c.indexOf("barcodes")&&a.barcodes){var d=a.barcodes.find(function(a){return-1!=a.toLowerCase().indexOf(b)});if(d)return!0}return!1},getDocumentIds:function(a){return a.map(function(a){return"string"==typeof a?a:a._id})}},x=function(a,b){var c={};return c.getTransactionSummary=function(a,c){if(a){if(a.name)return a.name;if(a.itemSummary)return a.itemSummary;if(a.items&&a.items.length>0)return b.getCategorySummary(a.items)}return c||"No items"},c.getOrderDuration=function(b){var c=b.started||a(),d="closed"==b.status?b.finished:b.due;return d?a.duration(d-c):null},c.getFriendlyOrderDuration=function(a,b){var d=c.getOrderDuration(a);return null!=d?b.getFriendlyDuration(d):""},c.getReservationDuration=function(b){return b?null!=b.fromDate&&null!=b.toDate?a.duration(b.toDate-b.fromDate):null:void 0},c.getFriendlyReservationDuration=function(a,b){var d=c.getReservationDuration(a);return null!=d?b.getFriendlyDuration(d):""},c}(b,k),y=function(a){var b=a({});a.subscribe=function(){b.on.apply(b,arguments)},a.unsubscribe=function(){b.off.apply(b,arguments)},a.publish=function(){b.trigger.apply(b,arguments)}}(a),z=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){return a.extend({},b,c,d,e,f,g,h,i,k,l,n,o,p,q,s,t)}(a,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,c,y),A=function(a){var b={id:null,name:"",color:"Gold",readonly:!1,selected:!1},c=function(c){c=c||{},this.raw=a.extend({},b,c),this.id=c.id||b.id,this.name=c.name||b.name,this.color=c.color||b.color,this.readonly=c.readonly||b.readonly,this.selected=c.selected||b.selected};return c.prototype.isDirty=function(){return this.raw.name!=this.name||this.raw.color!=this.color},c.prototype.isValid=function(){return this.name&&this.name.length>0},c.prototype._fromJson=function(c){return this.id=c.id||b.id,this.name=c.name||b.name,this.color=c.color||b.color,this.selected=c.selected||b.selected,this.readonly=c.readonly||b.readonly,a.Deferred().resolve()},c.prototype._toJson=function(){return{id:this.id,name:this.name,color:this.color,selected:this.selected,readonly:this.readonly}},c}(a),B=function(a,b,c,d){var e={id:""},f=function(a){this.raw=null,this.id=a.id||e.id,this.ds=a.ds,this._fields=a._fields};return f.prototype.reset=function(){return this._fromJson(this._getDefaults(),null)},f.prototype.existsInDb=function(){return null!=this.id&&this.id.length>0},f.prototype.isEmpty=function(){return!0},f.prototype.isDirty=function(){return!1},f.prototype.isValid=function(){return!0},f.prototype.discardChanges=function(){return this.raw?this._fromJson(this.raw,null):this.reset()},f.prototype.reload=function(b){return this.existsInDb()?this.get(b):a.Deferred().reject(new c.ApiError("Cannot reload document, id is empty or null"))},f.prototype.get=function(b){if(this.existsInDb()){var d=this;return this.ds.get(this.id,b||this._fields).then(function(a){return d._fromJson(a)})}return a.Deferred().reject(new c.ApiError("Cannot get document, id is empty or null"))},f.prototype.create=function(b){return this.existsInDb()?a.Deferred().reject(new Error("Cannot create document, already exists in database")):this.isEmpty()?a.Deferred().reject(new Error("Cannot create empty document")):this.isValid()?this._create(b):a.Deferred().reject(new Error("Cannot create, invalid document"))},f.prototype.update=function(b){return this.existsInDb()?this.isEmpty()?a.Deferred().reject(new Error("Cannot update to empty document")):this.isValid()?this._update(b):a.Deferred().reject(new Error("Cannot update, invalid document")):a.Deferred().reject(new Error("Cannot update document without id"))},f.prototype["delete"]=function(){return this.existsInDb()?this._delete():a.Deferred().reject(new Error("Document does not exist"))},f.prototype._getDefaults=function(){return e},f.prototype._toJson=function(a){return{id:this.id}},f.prototype._fromJson=function(b,c){return this.raw=b,this.id=b._id||e.id,a.Deferred().resolve(b)},f.prototype._create=function(a){var b=this,c=this._toJson();return delete c.id,this.ds.create(c,this._fields).then(function(c){return 1==a?c:b._fromJson(c)})},f.prototype._update=function(a){var b=this,c=this._toJson();return delete c.id,this.ds.update(this.id,c,this._fields).then(function(c){return 1==a?c:b._fromJson(c)})},f.prototype._delete=function(){var a=this;return this.ds["delete"](this.id).then(function(){return a.reset()})},f.prototype._isDirtyProperty=function(a){return this.raw?this[a]!=this.raw[a]:!1},f.prototype._isDirtyStringProperty=function(a){if(this.raw){var b=this[a]==this.raw[a]||""==this[a]&&null==this.raw[a];return!b}return!1},f.prototype._isDirtyMomentProperty=function(a){if(this.raw){var b=this[a],c=this.raw[a];return null==b&&null==c?!1:b&&c?!b.isSame(c):!0}return!1},f.prototype._getId=function(a,b){return"string"==typeof a?a:a[b||"_id"]},f.prototype._getIds=function(a,b){return a.map(function(a){return"string"==typeof a?a:a[b||"_id"]})},f.prototype._doApiCall=function(a){var b=this;return this.ds.call(1==a.collectionCall?null:a.pk||this.id,a.method,a.params,a._fields||this._fields,a.timeOut,a.usePost).then(function(c){return 1==a.skipRead?c:b._fromJson(c)})},f.prototype._doApiLongCall=function(a){return a.timeOut=a.timeOut||6e4,this._doApiCall(a)},f.prototype._getColorLabel=function(b,c){var e=a.extend({},c||{},b);return new d(e)},f}(a,z,d,A),C=function(a,b,c,d){var e={id:"",planning:"",item:"",from:null,to:null,order:"",reservation:""},f=function(){};f.prototype=d.prototype;var g=function(b){var c=a.extend({},b);d.call(this,c),this.planning=c.planning||e.planning,this.item=c.item||e.item,this.from=c.from||e.from,this.to=c.to||e.to,this.order=c.order||e.order,this.reservation=c.reservation||e.reservation};return g.prototype=new f,g.prototype.constructor=g,g.prototype._getDefaults=function(){return e},g.prototype.isEmpty=function(){return!1},g.prototype.canDelete=function(){return a.Deferred().resolve(!1)},g.prototype._toJson=function(a){var b=d.prototype._toJson.call(this,a);return b.planning=this.planning,b.item=this.item,b.fromDate=this.from,b.toDate=this.to,b.order=this.order,b.reservation=this.reservation,b},g.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.planning=a.planning||e.planning,c.item=a.item||e.item,c.from=a.fromDate||e.from,c.to=a.toDate||e.to,c.order=a.order||e.order,c.reservation=a.reservation||e.reservation,a})},g}(a,z,d,B),D=function(a,b){var c=["jpg","jpeg","png","gif","doc","docx","pdf"],d={fileName:"",fileSize:0,isCover:!1,canBeCover:!0},e=function(a){a=a||{},this.ds=a.ds,this.raw=null,this.fileName=a.fileName||d.fileName,this.fileSize=a.fileSize||d.fileSize,this.value=a.value||d.value,this.created=a.created||d.created,this.by=a.by||d.by,this.isCover=null!=a.isCover?a.isCover:d.isCover,this.canBeCover=null!=a.canBeCover?a.canBeCover:d.canBeCover};return e.prototype.getThumbnailUrl=function(a){return this.hasPreview()?this.helper.getImageUrl(this.ds,this.value,a||"S"):""},e.prototype.getDownloadUrl=function(){return this.ds.getBaseUrl()+this.value+"?download=True"},e.prototype.getExt=function(a){return b.getExt(a||this.fileName)},e.prototype.getFriendlyFileSize=function(){var a=this.fileSize;return isNaN(a)&&(a=0),1024>a?a+" Bytes":(a/=1024,1024>a?a.toFixed(2)+" Kb":(a/=1024,1024>a?a.toFixed(2)+" Mb":(a/=1024,1024>a?a.toFixed(2)+" Gb":(a/=1024,a.toFixed(2)+" Tb"))))},e.prototype.isImage=function(){return b.isImage(this.fileName)},e.prototype.hasPreview=function(){var b=this.getExt(this.fileName);return a.inArray(b,c)>=0},e.prototype._toJson=function(a){return{fileName:this.fileName,fileSize:this.fileSize,value:this.value,created:this.created,by:this.by}},e.prototype._fromJson=function(b,c){return this.raw=b,this.fileName=b.fileName||d.fileName,this.fileSize=b.fileSize||d.fileSize,this.value=b.value||d.value,this.created=b.created||d.created,this.by=b.by||d.by,a.Deferred().resolve(b)},e}(a,m),E=function(a){var b={id:"",value:null,created:null,modified:null,by:null},c=function(a){a=a||{},this.ds=a.ds,this.raw=null,this.id=a.id||b.id,this.value=a.value||b.value,this.created=a.created||b.created,this.modified=a.modified||b.modified,this.by=a.by||b.by,this.fromReservation=a.fromReservation||!1};return c.prototype._toJson=function(a){return{id:this.id,value:this.value,created:this.created,modified:this.modified,by:this.by}},c.prototype._fromJson=function(c,d){return this.raw=c,this.id=c.id||b.id,this.value=c.value||b.value,this.created=c.created||b.created,this.modified=c.modified||b.modified,this.by=c.by||b.by,a.Deferred().resolve(c)},c}(a),F=function(a,b){var c=["jpg","jpeg","png","gif","doc","docx","pdf"],d={fileName:"",fileSize:0,isCover:!1,canBeCover:!0},e=function(a){a=a||{},this.ds=a.ds,this.raw=null,this.fileName=a.fileName||d.fileName,this.fileSize=a.fileSize||d.fileSize,this.value=a.value||d.value,this.created=a.created||d.created,this.by=a.by||d.by,this.isCover=null!=a.isCover?a.isCover:d.isCover,this.canBeCover=null!=a.canBeCover?a.canBeCover:d.canBeCover};return e.prototype.getThumbnailUrl=function(a){return this.hasPreview()?this.helper.getImageUrl(this.ds,this.value,a||"S"):""},e.prototype.getDownloadUrl=function(){return this.ds.getBaseUrl()+this.value+"?download=True"},e.prototype.getExt=function(a){return b.getExt(a||this.fileName)},e.prototype.getFriendlyFileSize=function(){var a=this.fileSize;return isNaN(a)&&(a=0),1024>a?a+" Bytes":(a/=1024,1024>a?a.toFixed(2)+" Kb":(a/=1024,1024>a?a.toFixed(2)+" Mb":(a/=1024,1024>a?a.toFixed(2)+" Gb":(a/=1024,a.toFixed(2)+" Tb"))))},e.prototype.isImage=function(){return b.isImage(this.fileName)},e.prototype.hasPreview=function(){var b=this.getExt(this.fileName);return a.inArray(b,c)>=0},e.prototype._toJson=function(a){return{fileName:this.fileName,fileSize:this.fileSize,value:this.value,created:this.created,by:this.by}},e.prototype._fromJson=function(b,c){return this.raw=b,this.fileName=b.fileName||d.fileName,this.fileSize=b.fileSize||d.fileSize,this.value=b.value||d.value,this.created=b.created||d.created,this.by=b.by||d.by,a.Deferred().resolve(b)},e}(a,m),G=function(a,b){var c={name:null,value:null,required:!1,unit:"",kind:"string",form:!1,editor:null,description:"",select:[]},d=function(a){a=a||{},this.raw=a,this.name=a.name||c.name,this.value=a.value||c.value,this.required=a.required||c.required,this.unit=a.unit||c.unit,this.kind=a.kind||c.kind,this.form=a.form||c.form,this.editor=a.editor||c.editor,this.description=a.description||c.description,this.select=a.select||c.select};return d.prototype.isValid=function(c){var d=a.trim(this.value);if(!this.required&&""==d)return!0;switch(this.kind){case"float":case"decimal":case"currency":return b.isNumeric(d);case"int":return b.isNumeric(d,!0);case"date":case"datetime":return b.isValidDate(d);case"string":case"select":return"phone"==this.editor?b.isValidPhone(d):"email"==this.editor?b.isValidEmail(d):"url"==this.editor?b.isValidURL(d):"number"==this.editor?b.isNumeric(d):""!=d;default:return!0}},d.prototype.isDirty=function(){return this.raw.value!=this.value},d.prototype.isEmpty=function(){return""==a.trim(this.value)},d}(a,z),H=function(a,b,c,d,e,f,g){var h={id:"",modified:null,cover:null,flag:null,label:null,fields:{},comments:[],attachments:[],barcodes:[]},i=function(){};i.prototype=d.prototype;var j=function(b){var c=a.extend({},b);d.call(this,c),this.dsAttachments=c.dsAttachments,
this.crtype=c.crtype,this.modified=c.modified||h.modified,this.flag=c.flag||h.flag,this.fields=c.fields||a.extend({},h.fields),this.comments=c.comments||h.comments.slice(),this.attachments=c.attachments||h.attachments.slice(),this.cover=c.cover||h.cover,this.barcodes=c.barcodes||h.barcodes.slice(),this.label=c.label||h.label};return j.prototype=new i,j.prototype.constructor=j,j.prototype._getDefaults=function(){return h},j.prototype.isEmpty=function(){return!(this.flag!=h.flag||null!=this.fields&&0!=Object.keys(this.fields).length||null!=this.comments&&0!=this.comments.length||null!=this.attachments&&0!=this.attachments.length)},j.prototype.isDirty=function(){return this._isDirtyFlag()||this._isDirtyFields()},j.prototype.canDelete=function(){return this.existsInDb()?this.ds.call(this.id,"canDelete"):a.Deferred().resolve({result:!1,message:""})},j.prototype.addComment=function(a,b){return this._doApiCall({method:"addComment",params:{comment:a},skipRead:b})},j.prototype.updateComment=function(a,b,c){return this._doApiCall({method:"updateComment",params:{commentId:a,comment:b},skipRead:c})},j.prototype.deleteComment=function(a,b){return this._doApiCall({method:"removeComment",params:{commentId:a},skipRead:b})},j.prototype.setFields=function(b,c){var d=this,e={};return a.each(b,function(a,c){d.raw.fields[a]!=b[a]&&(e[a]=c)}),this._doApiCall({method:"setFields",params:e,skipRead:c,usePost:!0})},j.prototype.setField=function(a,b,c){return b?this._doApiCall({method:"setField",params:{field:a,value:b},skipRead:c}):this.clearField(a,c)},j.prototype.clearField=function(a,b){return this._doApiCall({method:"clearField",params:{field:a},skipRead:b})},j.prototype.addBarcode=function(a,b){return this._doApiCall({method:"addBarcode",params:{barcode:a},skipRead:b})},j.prototype.removeBarcode=function(a,b){return this._doApiCall({method:"removeBarcode",params:{barcode:a},skipRead:b})},j.prototype.getImageUrl=function(a,b,c,d){var e=c||this.cover;return null!=e&&e.length>0?this.helper.getImageCDNUrl(b,e,a):this.helper.getImageUrl(this.ds,this.id,a,d)},j.prototype.setCover=function(a,b){return this._doApiCall({method:"setCover",params:{attachmentId:a._id},skipRead:b})},j.prototype.clearCover=function(a){return this._doApiCall({method:"clearCover",params:{},skipRead:a})},j.prototype.attach=function(b,d){return this.existsInDb()?this._doApiCall({method:"attach",params:{attachments:[b]},skipRead:d}):a.Deferred().reject(new c.ApiError("Cannot attach attachment, id is empty or null"))},j.prototype.detach=function(b,d){return this.existsInDb()?this._doApiCall({method:"detach",params:{attachments:[b]},skipRead:d}):a.Deferred().reject(new c.ApiError("Cannot detach attachment, id is empty or null"))},j.prototype.setFlag=function(a,b){return this._doApiCall({method:"setFlag",params:{flag:a},skipRead:b})},j.prototype.clearFlag=function(a){return this._doApiCall({method:"clearFlag",params:{},skipRead:a})},j.prototype.setLabel=function(a,b){return this._doApiCall({method:"setLabel",params:{labelId:a},skipRead:b})},j.prototype.clearLabel=function(a){return this._doApiCall({method:"clearLabel",params:{},skipRead:a})},j.prototype.getSortedFields=function(b,c,d){var e=this,f=[],g=null,h=null;b=b.slice(),b=b.filter(function(a){return 1==c?a.form:!0});for(var i=0;i<b.length;i++)g=b[i],h=e.fields[g.name]||"",(null==d||d>f.length)&&f.push(e._getField(a.extend({value:h},g)));return f},j.prototype.setSortedFields=function(a){for(var b=0;b<a.length;b++){var c=a[b];c.isEmpty()?delete this.fields[c.name]:this.fields[c.name]=c.value}},j.prototype.validateSortedFields=function(a){for(var b=0;b<a.length;b++)if(!a[b].isValid())return!1;return!0},j.prototype.updateFields=function(){return this._updateFields()},j.prototype._isDirtyFlag=function(){return this.raw?this.flag!=this.raw.flag:!1},j.prototype._isDirtyFields=function(){return this.raw?!b.areEqual(this.fields,this.raw.fields):!1},j.prototype._updateFields=function(){var b=[];if(this.raw)for(var c in this.fields)this.fields[c]!=this.raw.fields[c]&&b.push(this.setField(c,this.fields[c],!0));return b.length>0?a.when(b):a.Deferred().resolve(this)},j.prototype._toJson=function(a){return d.prototype._toJson.call(this,a)},j.prototype._fromJson=function(b,c){var e=this;return d.prototype._fromJson.call(this,b,c).then(function(){return e.flag=b.flag||h.flag,e.fields=null!=b.fields?a.extend({},b.fields):a.extend({},h.fields),e.modified=b.modified||h.modified,e.barcodes=b.barcodes||h.barcodes,e.label=b.label||h.label,e._fromCommentsJson(b,c).then(function(){return e._fromAttachmentsJson(b,c)})})},j.prototype._toJsonFields=function(a){var b={};if(this.fields)for(var c in this.fields)b["fields__"+c]=this.fields[c];return b},j.prototype._fromCommentsJson=function(b,c){var d=null,e=this;return this.comments=h.comments.slice(),b.comments&&b.comments.length>0&&a.each(b.comments,function(a,b){d=e._getComment(b,c),d&&e.comments.push(d)}),a.Deferred().resolve(b)},j.prototype._fromAttachmentsJson=function(b,c){var d=null,e=this;return this.attachments=h.attachments.slice(),b.attachments&&b.attachments.length>0&&a.each(b.attachments,function(a,b){d=e._getAttachment(b,c),d&&e.attachments.push(d)}),a.Deferred().resolve(b)},j.prototype._getComment=function(b,c){var d=a.extend({ds:this.ds},c||{},b);return new e(d)},j.prototype._getAttachment=function(b,c){var d=a.extend({ds:this.ds},c||{},b);return new f(d)},j.prototype._getField=function(b,c){var d=a.extend({},c||{},b);return new g(d)},j}(a,z,d,B,E,F,G),I=function(a,b,c,d){var e={id:"",name:"",count:0,defs:[],parent:"",modified:null},f=function(){};f.prototype=d.prototype;var g=function(b){var c=a.extend({},b);d.call(this,c),this.name=c.name||e.name,this.count=c.count||e.count,this.defs=c.defs||e.defs.slice(),this.parent=c.parent||e.parent,this.modified=c.modified||e.modified};return g.prototype=new f,g.prototype.constructor=g,g.prototype.isValidName=function(){if(this.name=a.trim(this.name),this.name.length>=3){var b=this.name.latinise().replace(/[`~!@#$%^&*()_|+\-=?;:'",.<\{\}\[\]\\\/]/gi,"");return this.name==b}return!1},g.prototype.isValid=function(){return this.isValidName()},g.prototype._getDefaults=function(){return e},g.prototype.isEmpty=function(){return d.prototype.isEmpty.call(this)&&this.name==e.name},g.prototype.isDirty=function(){var a=d.prototype.isDirty.call(this);return!a&&this.raw&&(a=this.name!=this.raw.name),a},g.prototype.canDelete=function(){return this.ds.call(this.id,"canDeleteCategory",{omitFields:!0})},g.prototype.canChangeName=function(a){return this.ds.call(this.id,"canChangeName",{name:a})},g.prototype.changeName=function(a){return this._doApiCall({pk:this.id,method:"changeName",params:{name:a}})},g.prototype.canChangeParent=function(a){return this.ds.call(this.id,"canChangeParent",{parent:a,omitFields:!0})},g.prototype.changeParent=function(a){return this._doApiCall({pk:this.id,method:"changeParent",params:{parent:a,omitFields:!0}})},g.prototype._toJson=function(a){var b=d.prototype._toJson.call(this,a);return b.name=this.name,b},g.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.name=a.name||e.name,c.count=a.count||e.count,c.defs=a.defs||e.defs.slice(),c.parent=a.parent||e.parent,c.modified=a.modified||e.modified,a})},g}(a,z,d,B),J=function(a){var b={id:"",value:null,created:null,modified:null,by:null},c=function(a){a=a||{},this.ds=a.ds,this.raw=null,this.id=a.id||b.id,this.value=a.value||b.value,this.created=a.created||b.created,this.modified=a.modified||b.modified,this.by=a.by||b.by,this.fromReservation=a.fromReservation||!1};return c.prototype._toJson=function(a){return{id:this.id,value:this.value,created:this.created,modified:this.modified,by:this.by}},c.prototype._fromJson=function(c,d){return this.raw=c,this.id=c.id||b.id,this.value=c.value||b.value,this.created=c.created||b.created,this.modified=c.modified||b.modified,this.by=c.by||b.by,a.Deferred().resolve(c)},c}(a),K=function(a){var b={kind:"",doc:"",item:"",itemName:"",locationCurrent:"",locationDesired:"",fromDate:null,toDate:null},c=function(a){this.ds=a.ds,this._fields=a._fields,this.raw=null,this.kind=a.kind||b.kind,this.doc=a.doc||b.doc,this.item=a.item||b.item,this.itemName=a.itemName||b.itemName,this.locationCurrent=a.locationCurrent||b.locationCurrent,this.locationDesired=a.locationDesired||b.locationDesired,this.fromDate=a.fromDate||b.fromDate,this.toDate=a.toDate||b.toDate};return c.prototype._toJson=function(a){return{kind:this.kind,doc:this.doc,item:this.item,itemName:this.itemName,locationCurrent:this.locationCurrent,locationDesired:this.locationDesired,fromDate:this.fromDate,toDate:this.toDate}},c.prototype._fromJson=function(c,d){return this.raw=c,this.kind=c.kind||b.kind,this.item=c.item||b.item,this.itemName=c.itemName||b.itemName,this.fromDate=c.fromDate||b.fromDate,this.toDate=c.toDate||b.toDate,a.Deferred().resolve(c)},c}(a),L=function(a,b,c,d,e,f,g){var h={id:"",modified:null,cover:null,flag:null,label:null,fields:{},comments:[],attachments:[],barcodes:[]},i=function(){};i.prototype=d.prototype;var j=function(b){var c=a.extend({},b);d.call(this,c),this.dsAttachments=c.dsAttachments,this.crtype=c.crtype,this.modified=c.modified||h.modified,this.flag=c.flag||h.flag,this.fields=c.fields||a.extend({},h.fields),this.comments=c.comments||h.comments.slice(),this.attachments=c.attachments||h.attachments.slice(),this.cover=c.cover||h.cover,this.barcodes=c.barcodes||h.barcodes.slice(),this.label=c.label||h.label};return j.prototype=new i,j.prototype.constructor=j,j.prototype._getDefaults=function(){return h},j.prototype.isEmpty=function(){return!(this.flag!=h.flag||null!=this.fields&&0!=Object.keys(this.fields).length||null!=this.comments&&0!=this.comments.length||null!=this.attachments&&0!=this.attachments.length)},j.prototype.isDirty=function(){return this._isDirtyFlag()||this._isDirtyFields()},j.prototype.canDelete=function(){return this.existsInDb()?this.ds.call(this.id,"canDelete"):a.Deferred().resolve({result:!1,message:""})},j.prototype.addComment=function(a,b){return this._doApiCall({method:"addComment",params:{comment:a},skipRead:b})},j.prototype.updateComment=function(a,b,c){return this._doApiCall({method:"updateComment",params:{commentId:a,comment:b},skipRead:c})},j.prototype.deleteComment=function(a,b){return this._doApiCall({method:"removeComment",params:{commentId:a},skipRead:b})},j.prototype.setFields=function(b,c){var d=this,e={};return a.each(b,function(a,c){d.raw.fields[a]!=b[a]&&(e[a]=c)}),this._doApiCall({method:"setFields",params:e,skipRead:c,usePost:!0})},j.prototype.setField=function(a,b,c){return b?this._doApiCall({method:"setField",params:{field:a,value:b},skipRead:c}):this.clearField(a,c)},j.prototype.clearField=function(a,b){return this._doApiCall({method:"clearField",params:{field:a},skipRead:b})},j.prototype.addBarcode=function(a,b){return this._doApiCall({method:"addBarcode",params:{barcode:a},skipRead:b})},j.prototype.removeBarcode=function(a,b){return this._doApiCall({method:"removeBarcode",params:{barcode:a},skipRead:b})},j.prototype.getImageUrl=function(a,b,c,d){var e=c||this.cover;return null!=e&&e.length>0?this.helper.getImageCDNUrl(b,e,a):this.helper.getImageUrl(this.ds,this.id,a,d)},j.prototype.setCover=function(a,b){return this._doApiCall({method:"setCover",params:{attachmentId:a._id},skipRead:b})},j.prototype.clearCover=function(a){return this._doApiCall({method:"clearCover",params:{},skipRead:a})},j.prototype.attach=function(b,d){return this.existsInDb()?this._doApiCall({method:"attach",params:{attachments:[b]},skipRead:d}):a.Deferred().reject(new c.ApiError("Cannot attach attachment, id is empty or null"))},j.prototype.detach=function(b,d){return this.existsInDb()?this._doApiCall({method:"detach",params:{attachments:[b]},skipRead:d}):a.Deferred().reject(new c.ApiError("Cannot detach attachment, id is empty or null"))},j.prototype.setFlag=function(a,b){return this._doApiCall({method:"setFlag",params:{flag:a},skipRead:b})},j.prototype.clearFlag=function(a){return this._doApiCall({method:"clearFlag",params:{},skipRead:a})},j.prototype.setLabel=function(a,b){return this._doApiCall({method:"setLabel",params:{labelId:a},skipRead:b})},j.prototype.clearLabel=function(a){return this._doApiCall({method:"clearLabel",params:{},skipRead:a})},j.prototype.getSortedFields=function(b,c,d){var e=this,f=[],g=null,h=null;b=b.slice(),b=b.filter(function(a){return 1==c?a.form:!0});for(var i=0;i<b.length;i++)g=b[i],h=e.fields[g.name]||"",(null==d||d>f.length)&&f.push(e._getField(a.extend({value:h},g)));return f},j.prototype.setSortedFields=function(a){for(var b=0;b<a.length;b++){var c=a[b];c.isEmpty()?delete this.fields[c.name]:this.fields[c.name]=c.value}},j.prototype.validateSortedFields=function(a){for(var b=0;b<a.length;b++)if(!a[b].isValid())return!1;return!0},j.prototype.updateFields=function(){return this._updateFields()},j.prototype._isDirtyFlag=function(){return this.raw?this.flag!=this.raw.flag:!1},j.prototype._isDirtyFields=function(){return this.raw?!b.areEqual(this.fields,this.raw.fields):!1},j.prototype._updateFields=function(){var b=[];if(this.raw)for(var c in this.fields)this.fields[c]!=this.raw.fields[c]&&b.push(this.setField(c,this.fields[c],!0));return b.length>0?a.when(b):a.Deferred().resolve(this)},j.prototype._toJson=function(a){return d.prototype._toJson.call(this,a)},j.prototype._fromJson=function(b,c){var e=this;return d.prototype._fromJson.call(this,b,c).then(function(){return e.flag=b.flag||h.flag,e.fields=null!=b.fields?a.extend({},b.fields):a.extend({},h.fields),e.modified=b.modified||h.modified,e.barcodes=b.barcodes||h.barcodes,e.label=b.label||h.label,e._fromCommentsJson(b,c).then(function(){return e._fromAttachmentsJson(b,c)})})},j.prototype._toJsonFields=function(a){var b={};if(this.fields)for(var c in this.fields)b["fields__"+c]=this.fields[c];return b},j.prototype._fromCommentsJson=function(b,c){var d=null,e=this;return this.comments=h.comments.slice(),b.comments&&b.comments.length>0&&a.each(b.comments,function(a,b){d=e._getComment(b,c),d&&e.comments.push(d)}),a.Deferred().resolve(b)},j.prototype._fromAttachmentsJson=function(b,c){var d=null,e=this;return this.attachments=h.attachments.slice(),b.attachments&&b.attachments.length>0&&a.each(b.attachments,function(a,b){d=e._getAttachment(b,c),d&&e.attachments.push(d)}),a.Deferred().resolve(b)},j.prototype._getComment=function(b,c){var d=a.extend({ds:this.ds},c||{},b);return new e(d)},j.prototype._getAttachment=function(b,c){var d=a.extend({ds:this.ds},c||{},b);return new f(d)},j.prototype._getField=function(b,c){var d=a.extend({},c||{},b);return new g(d)},j}(a,z,d,B,E,F,G),M=function(a,b,c){var d={name:"",email:"",group:"",picture:"",role:"user",active:!0,isOwner:!1,archived:null,restrictLocations:[]},e=function(){};e.prototype=b.prototype;var f=function(c){var e=a.extend({_fields:["*","group","picture"]},c);b.call(this,e),this.helper=e.helper,this.name=e.name||d.name,this.picture=e.picture||d.picture,this.email=e.email||d.email,this.role=e.role||d.role,this.group=e.group||d.group,this.active=null!=e.active?e.active:d.active,this.isOwner=null!=e.isOwner?e.isOwner:d.isOwner,this.archived=e.archived||d.archived,this.restrictLocations=e.restrictLocations?e.restrictLocations.slice():d.restrictLocations.slice(),this.dsAnonymous=e.dsAnonymous};return f.prototype=new e,f.prototype.constructor=f,f.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=4},f.prototype.isValidEmail=function(){return this.email=a.trim(this.email),c.isValidEmail(this.email)},f.prototype.isValidRole=function(){switch(this.role){case"user":case"admin":case"root":case"selfservice":return!0;default:return!1}},f.prototype.emailExists=function(){return this.isValidEmail()?null!=this.id&&this.email==this.raw.email?a.Deferred().resolve(!1):this.dsAnonymous.call("emailExists",{email:this.email}).then(function(a){return a.result}):a.Deferred().resolve(!1)},f.prototype.isValidPassword=function(){return this.password=a.trim(this.password),c.isValidPassword(this.password)},f.prototype.isValid=function(){return this.isValidName()&&this.isValidEmail()&&this.isValidRole()},f.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==d.name&&this.email==d.email&&this.role==d.role&&this.restrictLocations&&0==this.restrictLocations.length},f.prototype._isDirtyInfo=function(){if(this.raw){var a=this.raw.name||d.name,b=this.raw.role||d.role,c=this.raw.email||d.email,e=null!=this.raw.active?this.raw.active:d.active;return this.name!=a||this.email!=c||this.role!=b||this.active!=e}return!1},f.prototype._isDirtyRestrictLocations=function(){if(this.raw){var a=this,b=this.raw.restrictLocations||d.restrictLocations;return this.restrictLocations.filter(function(a){return b.indexOf(a)<0}).length>0||b.filter(function(b){return a.restrictLocations.indexOf(b)<0}).length>0}return!1},f.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);return a||this._isDirtyInfo()||this._isDirtyRestrictLocations()},f.prototype.getImageUrl=function(a,b){return null!=this.picture&&this.picture.length>0?this.helper.getImageCDNUrl(this.group,this.picture,a,b):this.helper.getImageUrl(this.ds,this.id,a,b)},f.prototype._getDefaults=function(){return d},f.prototype.addKeyValue=function(b,c,d,e){return a.Deferred().reject("Not implemented for User, use setPicture instead?")},f.prototype.addKeyValue=function(b,c,d,e,f){return a.Deferred().reject("Not implemented for User, use setPicture instead?")},f.prototype.removeKeyValue=function(b,c){return a.Deferred().reject("Not implemented for User, use clearPicture instead?")},f.prototype.setPicture=function(b,c){return this.existsInDb()?(this.picture=b,this._doApiCall({method:"setPicture",params:{attachment:b},skipRead:c})):a.Deferred().reject("User does not exist in database")},f.prototype.clearPicture=function(b){return this.existsInDb()?this._doApiCall({method:"clearPicture",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.canActivate=function(){return!this.active&&null==this.archived},f.prototype.canDeactivate=function(){return this.active&&null==this.archived&&!this.isOwner},f.prototype.canArchive=function(){return null==this.archived&&!this.isOwner},f.prototype.canUndoArchive=function(){return null!=this.archived},f.prototype.canBeOwner=function(){return null==this.archived&&this.active&&!this.isOwner&&"admin"==this.role},f.prototype.activate=function(b){return this.existsInDb()?this._doApiCall({method:"activate",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.deactivate=function(b){return this.existsInDb()?this._doApiCall({method:"deactivate",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.archive=function(b){return this.existsInDb()?this._doApiCall({method:"archive",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.undoArchive=function(b){return this.existsInDb()?this._doApiCall({method:"undoArchive",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.setRestrictLocations=function(b,c){return this.existsInDb()?this._doApiCall({method:"setRestrictLocations",params:{restrictLocations:b},skipRead:c}):a.Deferred().reject("User does not exist in database")},f.prototype.clearRestrictLocations=function(b){return this.existsInDb()?this._doApiCall({method:"clearRestrictLocations",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.update=function(b){if(this.isEmpty())return a.Deferred().reject(new Error("Cannot update to empty user"));if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot update user without id"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot update, invalid user"));var c=a.Deferred(),d=a.Deferred();return this._isDirtyInfo()?d=this.ds.update(this.id,this._toJson(),this._fields):d.resolve(),this._isDirtyRestrictLocations()?c=0!=this.restrictLocations.length?this.setRestrictLocations(this.restrictLocations,!0):this.clearRestrictLocations(!0):c.resolve(),a.when(d,c)},f.prototype._toJson=function(a){var c=b.prototype._toJson.call(this,a);return c.name=this.name||d.name,c.email=this.email||d.email,c.group=this.group||d.group,c.role=this.role||d.role,c},f.prototype._fromJson=function(c,e){var f=this;return b.prototype._fromJson.call(this,c,e).then(function(){return f.group=c.group&&null!=c.group._id?c.group._id:c.group||d.group,f.name=c.name||d.name,f.picture=c.picture||d.picture,f.email=c.email||d.email,f.role=c.role||d.role,f.active=null!=c.active?c.active:d.active,f.isOwner=null!=c.isOwner?c.isOwner:d.isOwner,f.archived=c.archived||d.archived,f.restrictLocations=c.restrictLocations?c.restrictLocations.slice():d.restrictLocations.slice(),a.publish("user.fromJson",c),c})},f}(a,L,z),N=function(a,b,c){return function(d){return d=d||b,{getSettings:function(){return d},getImageCDNUrl:function(a,b,e){return c.getImageCDNUrl(d,a,b,e)},getImageUrl:function(a,b,c,d){var e=a.getBaseUrl()+b+"?mimeType=image/jpeg";return c&&"orig"!=c&&(e+="&size="+c),d&&(e+="&_bust="+(new Date).getTime()),e},getICalUrl:function(b,c,d,e,f,g,h){e=e||[],f=f||[];var i=b+"/ical/"+c+"/"+d+"/public/locations/call/ical",j=[];h&&j.push("locations[]="+h),g&&j.push("customer="+g);var k=f.filter(function(a){return a.selected}).map(function(a){return a.id||""});0==k.length?j.push("skipOpenReservations=true"):k.length!=f.length&&j.push(a.param({rlab:k}));var l=e.filter(function(a){return a.selected}).map(function(a){return a.id||""});return 0==l.length?j.push("skipOpenOrders=true"):l.length!=e.length&&j.push(a.param({olab:l})),j.length>0?i+"?"+j.join("&"):i},getQRCodeUrl:function(a,b){return c.getQRCodeUrl(d.urlApi,a,b)},getBarcodeUrl:function(a,b,e){return c.getBarcodeUrl(d.urlApi,a,b,e)},getNumItemsLeft:function(a,b){var c=this.getStat(b,"items","status");return a.maxItems-this.getStat(b,"items","total")+c.expired},getNumUsersLeft:function(a,b){var c=this.getStat(b,"users","status");return a.maxUsers-c.active},getStat:function(a,b,c,d,e){if(a=a||{},a=a[d&&"null"!=d?d:"all"]||a.all,void 0===a)throw"Invalid stats";a=a[e||"production"];var f=a[b];if(void 0===f)throw"Stat doesn't exist";if(!c)return f;var g=f[c];if(void 0===g)throw"Stat value doesn't exist";return g},ensureValue:function(a,b){return"string"==typeof a?a:a&&a.hasOwnProperty(b)?a[b]:a},ensureId:function(a){return this.ensureValue(a,"_id")}}}}(a,e,z),O=function(a,b,c,d,e){var f={name:"",email:"",status:"active",user:{},kind:"contact",cover:"",blocked:null},g=function(){};g.prototype=b.prototype;var h=function(c){var d=a.extend({_fields:["*"],crtype:"cheqroom.types.customer"},c);b.call(this,d),this.helper=d.helper||new e,this.name=d.name||f.name,this.email=d.email||f.email,this.status=d.status||f.status,this.user=d.user||f.user,this.kind=d.kind||f.kind,this.cover=d.cover||f.cover,this.blocked=d.blocked||f.blocked};return h.prototype=new g,h.prototype.constructor=h,h.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},h.prototype.isValidEmail=function(){return this.email=a.trim(this.email),c.isValidEmail(this.email)},h.prototype.getUserId=function(){return this.helper.ensureId(this.user)},h.prototype.getUserSync=function(){return null!=this.user&&null!=this.user.sync?this.user.sync:""},h.prototype.canReserve=function(){return c.contactCanReserve(this)},h.prototype.canCheckout=function(){return c.contactCanCheckout(this)},h.prototype.canGenerateDocument=function(){return c.contactCanGenerateDocument(this)},h.prototype.canArchive=function(){return c.contactCanArchive(this)},h.prototype.canUndoArchive=function(){return c.contactCanUndoArchive(this)},h.prototype.canBlock=function(){return c.contactCanBlock(this)},h.prototype.canUndoBlock=function(){return c.contactCanUndoBlock(this)},h.prototype.canDelete=function(){return c.contactCanDelete(this)},h.prototype.archive=function(a){return this._doApiCall({method:"archive",params:{},skipRead:a})},h.prototype.undoArchive=function(a){return this._doApiCall({method:"undoArchive",params:{},skipRead:a})},h.prototype.block=function(a,b){return this._doApiCall({method:"block",params:{message:a},skipRead:b})},h.prototype.undoBlock=function(a,b){return this._doApiCall({method:"undoBlock",params:{message:a},skipRead:b})},h.prototype.generateDocument=function(a,b,c){return this._doApiLongCall({method:"generateDocument",params:{template:a,signature:b},skipRead:c})},h.prototype.isValid=function(){return this.isValidName()&&this.isValidEmail()},h.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==f.name&&this.email==f.email},h.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);return!a&&this.raw&&(a=this._isDirtyStringProperty("name")||this._isDirtyStringProperty("email")),a},h.prototype._getDefaults=function(){return f},h.prototype._toJson=function(a){var c=b.prototype._toJson.call(this,a);return c.name=this.name||f.name,c.email=this.email||f.email,c},h.prototype._fromJson=function(d,e){var g=this;return b.prototype._fromJson.call(this,d,e).then(function(b){g.name=b.name||f.name,g.email=b.email||f.email,g.status=b.status||f.status,g.user=b.user||f.user,g.kind=b.kind||f.kind,g.blocked=b.blocked||f.blocked;var d=b.cover||f.cover;return g.cover=c.isImage(d)?d:"",a.publish("contact.fromJson",b),b})},h.prototype._create=function(b){var c=this,d=a.extend({},this._toJson(),this._toJsonFields());return delete d.id,this.ds.create(d,this._fields).then(function(a){return 1==b?a:c._fromJson(a)})},h.prototype._update=function(a){var b=this,c={};return this._isDirtyStringProperty("name")&&(c.name=b.name),this._isDirtyStringProperty("email")&&(c.email=b.email),this.ds.update(this.id,c,this._fields).then(function(c){return 1==a?c:b._fromJson(c)})},h}(a,L,z,M,N),P=function(a,b){b.fn.toJSONDate=function(){return this.format("YYYY-MM-DD[T]HH:mm:ss.000[Z]")},b.fn.roundTo=function(a,c,d){a=b.normalizeUnits(a),c=c||1;var e=function(a){switch(d){case"up":a=Math.ceil(a/c);break;case"down":a=Math.floor(a/c);break;default:a=Math.round(a/c)}return a*c};switch(a){case"year":this.year(e(this.year()));break;case"month":this.month(e(this.month()));break;case"week":this.weekday(e(this.weekday()));break;case"isoWeek":this.isoWeekday(e(this.isoWeekday()));break;case"day":this.day(e(this.day()));break;case"hour":this.hour(e(this.hour()));break;case"minute":this.minute(e(this.minute()));break;case"second":this.second(e(this.second()));break;default:this.millisecond(e(this.millisecond()))}return this};var c=15,d=9,e=17,f=function(a){a=a||{},this.roundType=a.roundType||"nearest",this.roundMinutes=a.roundMinutes||c,this.timeFormat24=a.timeFormat24?a.timeFormat24:!1,this._momentFormat=this.timeFormat24?"MMM D [at] H:mm":"MMM D [at] h:mm a",this.startOfDayHours=null!=a.startOfDayHours?startOfDayHours:d,this.endOfDayHours=null!=a.endOfDayHours?endOfDayHours:e,this.businessHours=a.businessHours||[],this.weekStart=a.weekStart||1};return f.prototype.parseDate=function(a){if(("string"==typeof a||a instanceof String)&&a.endsWith("+00:00")){var c=a.length;if(25==c)return b(a.substring(0,c-6));if(32==c)return b(a.substring(0,c-6).split(".")[0])}},f.prototype.getNow=function(){return b()},f.prototype.getFriendlyDuration=function(a){return a.humanize()},f.prototype.getFriendlyDateParts=function(a,c,d){return b.isMoment(a)||(a=b(a)),c=c||this.getNow(),a.calendar().replace("AM","am").replace("PM","pm").split(" at ")},f.prototype.getDateRanges=function(a,c,d,e){d&&!b.isMoment(d)&&(d=b(d)),e=e||{year:"year",years:"years",month:"month",months:"months",week:"week",weeks:"weeks",day:"day",days:"days",hour:"hour",hours:"hours"};for(var f=["years","months","weeks","days","hours"],g=[8760,720,168,24,1],h=null,i=null,j=null,k=0,l=-1,m=[],n=0;n<f.length;n++)if(i=g[n],h=f[n],a>=i&&a%i==0){l=n;break}if(d=d||this.getNow(),l>=0)for(var n=1;c>=n;n++)k=n*a,j=e[1==k?h.replace("s",""):h],m.push({option:h,hours:k,title:k/g[l]+" "+j,from:d.clone(),to:d.clone().add(k,"hours")});return m.filter(function(a){return global.dateHelper.isValidBusinessDate(a.to)})},f.prototype.getFriendlyFromTo=function(a,c,d,e,f,g){b.isMoment(a)||(a=b(a)),b.isMoment(c)||(c=b(c)),e=e||this.getNow();var h=f||" - ",i=this.getFriendlyDateParts(a,e,g),j=this.getFriendlyDateParts(c,e,g),k={dayDiff:a?a.clone().startOf("day").diff(c,"days"):-1,fromDate:a?i[0]:"No from date set",fromTime:d&&null!=a?i[1]:"",toDate:c?j[0]:"No to date set",toTime:d&&null!=c?j[1]:""};return k.fromText=k.fromDate,k.toText=k.toDate,d&&(k.fromTime&&(k.fromText+=" "+k.fromTime),k.toTime&&(k.toText+=" "+k.toTime)),k.text=0==k.dayDiff?d?k.fromText+h+k.toText:k.fromText:k.fromText+h+k.toText,k},f.prototype.getFriendlyFromToOld=function(a,c,d){var e=this.roundFromTime(a,d),f=this.roundToTime(c,d);return{from:e,to:f,daysBetween:f.clone().startOf("day").diff(e.clone().startOf("day"),"days"),duration:b.duration(e-f).humanize(),fromText:e.calendar().replace(" at "," "),toText:f.calendar().replace(" at "," ")}},f.prototype.makeStartDate=function(a,c,d,e,f,g){if(c=null!=c?c:!0,d=null!=d?d:!1,g=g||b(),c&&!d)a=this.roundTimeFrom(a);else{var h=a.isSame(g,"day"),i=this._makeStartOfBusinessDay(a);a=h?a.isBefore(i)?i:this.roundTimeFrom(a):i}return e&&a.isBefore(e)?e:a},f.prototype.makeEndDate=function(a,c,d,e,f,g){if(c=null!=c?c:!0,d=null!=d?d:!1,g=g||b(),c&&!d)a=this.roundTimeTo(a);else{var h=a.isSame(g,"day"),i=this._makeEndOfBusinessDay(a),j=this._makeEndOfDay(a);a=h?a.isBefore(i)?i:j:a.isAfter(i)?j:i}return f&&a.isAfter(f)?f:a},f.prototype.getFriendlyDateText=function(a,b,c,d){if(null==a)return"Not set";var e=this.getFriendlyDateParts(a,c,d);return b?e.join(" "):e[0]},f.prototype.addAverageDuration=function(a){return a.clone().add(1,"day")},f.prototype.roundTimeFrom=function(a){return this.roundMinutes<=1?a:this.roundTime(a,this.roundMinutes,this._typeToDirection(this.roundType,"from"))},f.prototype.roundTimeTo=function(a){return this.roundMinutes<=1?a:this.roundTime(a,this.roundMinutes,this._typeToDirection(this.roundType,"to"))},f.prototype.roundTime=function(a,d,e){var f=b.isMoment(a)?a:b(a);return f.seconds(0).milliseconds(0),f.roundTo("minute",d||c,e)},f.prototype.roundTimeUp=function(a,d){var e=b.isMoment(a)?a:b(a);return e.seconds(0).milliseconds(0),e.roundTo("minute",d||c,"up")},f.prototype.roundTimeDown=function(a,d){var e=b.isMoment(a)?a:b(a);return e.seconds(0).milliseconds(0),e.roundTo("minute",d||c,"down")},f.prototype._typeToDirection=function(a,b){switch(a){case"longer":switch(b){case"from":return"down";case"to":return"up"}break;case"shorter":switch(b){case"from":return"up";case"to":return"down"}}},f.prototype.isValidBusinessDate=function(c){var d=!1,e=this.businessHours;return e.length>0?a.each(this._getBusinessHours(c),function(a,e){var f=b(b.utc(b.duration(e.openTime,"minutes").asMilliseconds()).format("H:mm"),"H:mm"),g=b(b.utc(b.duration(e.closeTime,"minutes").asMilliseconds()).format("H:mm"),"H:mm"),h=b(c.clone().format("H:mm"),"H:mm");return d=h.isBetween(f,g)||h.isSame(f)||h.isSame(g),d?!1:void 0}):d=!0,d},f.prototype.getValidBusinessDate=function(a){var b=this,c=this.getNow(),d=0;for(a.isBefore(c)&&a.date(c.date());!this.isValidBusinessDate(a)||d>=10080;)a=a.add(b.roundMinutes,"minutes"),d+=b.roundMinutes;return a},f.prototype._getBusinessHours=function(a){var b=this.businessHours;return b.length>0?b.filter(function(b){return b.isoWeekday==a.isoWeekday()}):[]},f.prototype._makeStartOfBusinessDay=function(a){var c=a.clone().hour(this.startOfDayHours).minutes(0).seconds(0).milliseconds(0),d=this.businessHours;if(d.length>0){var e=this._getBusinessHours(a);if(e.length>0){var f=b(b.utc(b.duration(e[0].openTime,"minutes").asMilliseconds()).format("H:mm"),"H:mm");c.hour(f.hour()).minute(f.minute())}}return this.getValidBusinessDate(c)},f.prototype._makeEndOfBusinessDay=function(a){var c=a.clone().hour(this.endOfDayHours).minutes(0).seconds(0).milliseconds(0),d=this.businessHours;if(d.length>0){var e=this._getBusinessHours(a).sort(function(a,b){
return a.closeTime<b.closeTime});if(e.length>0){var f=b(b.utc(b.duration(e[0].closeTime,"minutes").asMilliseconds()).format("H:mm"),"H:mm");c.hour(f.hour()).minute(f.minute())}}return this.getValidBusinessDate(c)},f.prototype._makeEndOfDay=function(a){return a.clone().hours(23).minutes(45).seconds(0).milliseconds(0)},f}(a,b),Q=function(a,b,c,d){var e={id:""},f=function(a){this.raw=null,this.id=a.id||e.id,this.ds=a.ds,this._fields=a._fields};return f.prototype.reset=function(){return this._fromJson(this._getDefaults(),null)},f.prototype.existsInDb=function(){return null!=this.id&&this.id.length>0},f.prototype.isEmpty=function(){return!0},f.prototype.isDirty=function(){return!1},f.prototype.isValid=function(){return!0},f.prototype.discardChanges=function(){return this.raw?this._fromJson(this.raw,null):this.reset()},f.prototype.reload=function(b){return this.existsInDb()?this.get(b):a.Deferred().reject(new c.ApiError("Cannot reload document, id is empty or null"))},f.prototype.get=function(b){if(this.existsInDb()){var d=this;return this.ds.get(this.id,b||this._fields).then(function(a){return d._fromJson(a)})}return a.Deferred().reject(new c.ApiError("Cannot get document, id is empty or null"))},f.prototype.create=function(b){return this.existsInDb()?a.Deferred().reject(new Error("Cannot create document, already exists in database")):this.isEmpty()?a.Deferred().reject(new Error("Cannot create empty document")):this.isValid()?this._create(b):a.Deferred().reject(new Error("Cannot create, invalid document"))},f.prototype.update=function(b){return this.existsInDb()?this.isEmpty()?a.Deferred().reject(new Error("Cannot update to empty document")):this.isValid()?this._update(b):a.Deferred().reject(new Error("Cannot update, invalid document")):a.Deferred().reject(new Error("Cannot update document without id"))},f.prototype["delete"]=function(){return this.existsInDb()?this._delete():a.Deferred().reject(new Error("Document does not exist"))},f.prototype._getDefaults=function(){return e},f.prototype._toJson=function(a){return{id:this.id}},f.prototype._fromJson=function(b,c){return this.raw=b,this.id=b._id||e.id,a.Deferred().resolve(b)},f.prototype._create=function(a){var b=this,c=this._toJson();return delete c.id,this.ds.create(c,this._fields).then(function(c){return 1==a?c:b._fromJson(c)})},f.prototype._update=function(a){var b=this,c=this._toJson();return delete c.id,this.ds.update(this.id,c,this._fields).then(function(c){return 1==a?c:b._fromJson(c)})},f.prototype._delete=function(){var a=this;return this.ds["delete"](this.id).then(function(){return a.reset()})},f.prototype._isDirtyProperty=function(a){return this.raw?this[a]!=this.raw[a]:!1},f.prototype._isDirtyStringProperty=function(a){if(this.raw){var b=this[a]==this.raw[a]||""==this[a]&&null==this.raw[a];return!b}return!1},f.prototype._isDirtyMomentProperty=function(a){if(this.raw){var b=this[a],c=this.raw[a];return null==b&&null==c?!1:b&&c?!b.isSame(c):!0}return!1},f.prototype._getId=function(a,b){return"string"==typeof a?a:a[b||"_id"]},f.prototype._getIds=function(a,b){return a.map(function(a){return"string"==typeof a?a:a[b||"_id"]})},f.prototype._doApiCall=function(a){var b=this;return this.ds.call(1==a.collectionCall?null:a.pk||this.id,a.method,a.params,a._fields||this._fields,a.timeOut,a.usePost).then(function(c){return 1==a.skipRead?c:b._fromJson(c)})},f.prototype._doApiLongCall=function(a){return a.timeOut=a.timeOut||6e4,this._doApiCall(a)},f.prototype._getColorLabel=function(b,c){var e=a.extend({},c||{},b);return new d(e)},f}(a,z,d,A),R=function(a,b,c,d){var e={id:"",name:"",itemFlags:[],kitFlags:[],customerFlags:[],orderFlags:[],reservationFlags:[],itemFields:[],kitFields:[],customerFields:[],orderFields:[],reservationFields:[],itemLabels:[],kitLabels:[],customerLabels:[],reservationLabels:[],orderLabels:[],businessHours:[],cancelled:null,calendarTemplate:"{{number}}: {{name_or_summary}} - {{contact.name}}"},f=function(){};f.prototype=d.prototype;var g=function(b){var c=a.extend({},b);d.call(this,c),this.name=c.name||e.name,this.itemFlags=c.itemFlags||e.itemFlags.slice(),this.kitFlags=c.kitFlags||e.kitFlags.slice(),this.customerFlags=c.customerFlags||e.customerFlags.slice(),this.orderFlags=c.orderFlags||e.orderFlags.slice(),this.reservationFlags=c.reservationFlags||e.reservationFlags.slice(),this.itemFields=c.itemFields||e.itemFields.slice(),this.kitFields=c.kitFields||e.kitFields.slice(),this.customerFields=c.customerFields||e.customerFields.slice(),this.reservationFields=c.reservationFields||e.reservationFields.slice(),this.orderFields=c.orderFields||e.orderFields.slice(),this.itemLabels=c.itemLabels||e.itemLabels.slice(),this.kitLabels=c.kitLabels||e.kitLabels.slice(),this.customerLabels=c.customerLabels||e.customerLabels.slice(),this.reservationLabels=c.reservationLabels||e.reservationLabels.slice(),this.orderLabels=c.orderLabels||e.orderLabels.slice(),this.businessHours=c.businessHours||e.businessHours.slice(),this.calendarTemplate=c.calendarTemplate||e.calendarTemplate};return g.prototype=new f,g.prototype.constructor=g,g.prototype.updateName=function(a){return this._doApiCall({pk:this.id,method:"updateName",location:a})},g.prototype.getStats=function(a){return this._doApiCall({pk:this.id,method:"getStats",location:a})},g.prototype.updateFlags=function(a,b,c){return this._doApiCall({pk:this.id,method:"updateFlags",collection:a,flags:b,skipRead:c})},g.prototype.createField=function(a,b,c,d,e,f,g,h,i,j,k){var l={collection:a,name:b,kind:c,required:d,form:e,unit:f,editor:g,description:h,search:j};return i&&i.length>0&&(l.select=i),this._doApiCall({pk:this.id,method:"createField",skipRead:k,params:l})},g.prototype.updateField=function(a,b,c,d,e,f,g,h,i,j,k,l){var m={collection:a,name:b,kind:d,required:e,form:f,unit:g,editor:h,description:i,search:k};return j&&j.length>0&&(m.select=j),this._doApiCall({pk:this.id,method:"updateField",skipRead:l,params:m})},g.prototype.deleteField=function(a,b,c){return this._doApiCall({pk:this.id,method:"deleteField",skipRead:c,params:{collection:a,name:b}})},g.prototype.moveField=function(a,b,c,d){return this._doApiCall({pk:this.id,method:"moveField",skipRead:d,params:{collection:a,oldPos:b,newPos:c}})},g.prototype.createLabel=function(a,b,c,d){return this._doApiCall({pk:this.id,method:"createLabel",skipRead:d,params:{collection:a,labelColor:b,labelName:c}})},g.prototype.updateLabel=function(a,b,c,d,e){return this._doApiCall({pk:this.id,method:"updateLabel",skipRead:e,params:{collection:a,labelId:b,labelColor:c,labelName:d}})},g.prototype.deleteLabel=function(a,b,c){return this._doApiCall({pk:this.id,method:"deleteLabel",skipRead:c,params:{collection:a,labelId:b}})},g.prototype.buyProduct=function(a,b,c){return this._doApiCall({pk:this.id,method:"buyProduct",skipRead:!0,params:{productId:a,quantity:b,shipping:c}})},g.prototype.buyProducts=function(a,b,c){return this._doApiCall({pk:this.id,method:"buyProducts",skipRead:!0,params:{products:a,shipping:b,coupon:c}})},g.prototype.addTags=function(a){return this._doApiCall({pk:this.id,method:"addTags",skipRead:!0,params:{tags:a}})},g.prototype.removeTags=function(a){return this._doApiCall({pk:this.id,method:"removeTags",skipRead:!0,params:{tags:a}})},g.prototype.getFieldsForCollection=function(b,c){var d=[];switch(b){case"items":d=this.itemFields;break;case"kits":d=this.kitFields;break;case"contacts":case"customers":d=this.customerFields;break;case"reservations":d=this.reservationFields;break;case"checkouts":case"orders":d=this.orderFields}return null!=c&&(d=a.grep(d,function(a,b){return a.form==c})),d},g.prototype.getFlagsForCollection=function(a){switch(a){case"items":return this.itemFlags;case"kits":return this.kitFlags;case"contacts":case"customers":return this.customerFlags;case"reservations":return this.reservationFlags;case"checkouts":case"orders":return this.orderFlags;default:return[]}},g.prototype.getBusinessDays=function(){return this.businessHours.map(function(a){return a.isoWeekday})},g.prototype.getBusinessHoursForIsoWeekday=function(a){return this.businessHours.filter(function(b){return b.isoWeekday==a})},g.prototype.setBusinessHours=function(b,c){return b=b||[],b=b.slice().map(function(b){var c=a.extend({},b);return c.dayOfWeek=b.isoWeekday-1,delete c.isoWeekday,c}),this._doApiCall({method:"setBusinessHours",params:{businessHours:b,_fields:this._fields},skipRead:c,usePost:!0})},g.prototype.getDefaultBusinessHours=function(){return[{isoWeekday:1,openTime:540,closeTime:1020},{isoWeekday:2,openTime:540,closeTime:1020},{isoWeekday:3,openTime:540,closeTime:1020},{isoWeekday:4,openTime:540,closeTime:1020},{isoWeekday:5,openTime:540,closeTime:1020}]},g.prototype.setCalendarTemplate=function(a,b){return this._doApiCall({method:"setCalendarTemplate",params:{template:a,kind:b},skipRead:!0,usePost:!0})},g.prototype.clearCalendarTemplate=function(){return this._doApiCall({method:"clearCalendarTemplate",skipRead:!0})},g.prototype.getCalendarTemplatePreview=function(a,b){return this._doApiCall({method:"getCalendarTemplatePreview",params:{template:a,kind:b},skipRead:!0,usePost:!0})},g.prototype.getDefaultCalendarTemplate=function(){return e.calendarTemplate},g.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},g.prototype._toJson=function(a){var b=d.prototype._toJson.call(this,a);return b.name=this.name,b},g.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.name=a.name||e.name,c.itemFlags=a.itemFlags||e.itemFlags.slice(),c.kitFlags=a.kitFlags||e.kitFlags.slice(),c.customerFlags=a.customerFlags||e.customerFlags.slice(),c.orderFlags=a.orderFlags||e.orderFlags.slice(),c.reservationFlags=a.reservationFlags||e.reservationFlags.slice(),c.itemFields=a.itemFields||e.itemFields.slice(),c.kitFields=a.kitFields||e.kitFields.slice(),c.customerFields=a.customerFields||e.customerFields.slice(),c.reservationFields=a.reservationFields||e.reservationFields.slice(),c.orderFields=a.orderFields||e.orderFields.slice(),c.cancelled=a.cancelled||e.cancelled,c.businessHours=a.businessHours||e.businessHours.slice(),c.calendarTemplate=a.calendarTemplate||e.calendarTemplate,c._fromColorLabelsJson(a,b).then(function(a){return c._fromBusinessHoursJson(a,b)})})},g.prototype._fromBusinessHoursJson=function(b,c){return b.businessHours=b.businessHours.map(function(a){return a.isoWeekday||(a.isoWeekday=a.dayOfWeek+1),delete a.dayOfWeek,a}),a.Deferred().resolve(b)},g.prototype._fromColorLabelsJson=function(b,c){var d=null,f=this;return a.each(["itemLabels","kitLabels","customerLabels","reservationLabels","orderLabels"],function(g,h){f[h]=e[h].slice(),"orderLabels"==h&&f[h].push(f._getColorLabel({readonly:!0,name:"Unlabeled",color:"SlateGray"},c)),"reservationLabels"==h&&f[h].push(f._getColorLabel({readonly:!0,name:"Unlabeled",color:"LimeGreen"},c)),b[h]&&b[h].length>0&&a.each(b[h],function(a,b){d=f._getColorLabel(b,c),d&&f[h].push(d)})}),a.Deferred().resolve(b)},g}(a,z,d,B),S=function(a,b,c){var d=0,e=0,f={name:"",status:"",codes:[],brand:"",model:"",warrantyDate:null,purchaseDate:null,purchasePrice:null,residualValue:null,location:"",category:"",geo:[d,e],address:"",order:null,kit:null,custody:null,cover:"",catalog:null,canReserve:"available",canOrder:"available",canCustody:"available",allowReserve:!0,allowOrder:!0,allowCustody:!0,flagged:null,expired:null},g=function(){};g.prototype=c.prototype;var h=function(b){var d=a.extend({_fields:["*"],crtype:"cheqroom.types.item"},b);c.call(this,d),this.name=d.name||f.name,this.status=d.status||f.status,this.brand=d.brand||f.brand,this.model=d.model||f.model,this.warrantyDate=d.warrantyDate||f.warrantyDate,this.purchaseDate=d.purchaseDate||f.purchaseDate,this.purchasePrice=d.purchasePrice||f.purchasePrice,this.residualValue=d.residualValue||f.residualValue,this.codes=d.codes||f.codes,this.location=d.location||f.location,this.category=d.category||f.category,this.geo=d.geo||f.geo.slice(),this.address=d.address||f.address,this.order=d.order||f.order,this.kit=d.kit||f.kit,this.custody=d.custody||f.custody,this.cover=d.cover||f.cover,this.catalog=d.catalog||f.catalog,this.allowReserve=void 0!==d.allowReserve?d.allowReserve:f.allowReserve,this.allowCheckout=void 0!==d.allowOrder?d.allowOrder:f.allowOrder,this.allowCustody=void 0!==d.allowCustody?d.allowCustody:f.allowCustody,this._canReserve=void 0!==d.canReserve?d.canReserve:f.canReserve,this._canCheckout=void 0!==d.canOrder?d.canOrder:f.canOrder,this._canCustody=void 0!==d.canCustody?d.canCustody:f.canCustody};return h.prototype=new g,h.prototype.constructor=h,h.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},h.prototype.isValidCategory=function(){return a.trim(this.category).length>0},h.prototype.isValidLocation=function(){return a.trim(this.location).length>0},h.prototype.isValid=function(){return this.isValidName()&&this.isValidCategory()&&("in_custody"==this.status?!0:this.isValidLocation())},h.prototype.isEmpty=function(){return c.prototype.isEmpty.call(this)&&this.name==f.name&&this.status==f.status&&this.brand==f.brand&&this.model==f.model&&this.warrantyDate==f.warrantyDate&&this.purchaseDate==f.purchaseDate&&this.purchasePrice==f.purchasePrice&&this.residualValue==f.residualValue&&0==this.codes.length&&this.location==f.location&&this.category==f.category},h.prototype.isDirty=function(){return c.prototype.isDirty.call(this)||this._isDirtyName()||this._isDirtyBrand()||this._isDirtyModel()||this._isDirtyWarrantyDate()||this._isDirtyPurchaseDate()||this._isDirtyPurchasePrice()||this._isDirtyResidualValue()||this._isDirtyCategory()||this._isDirtyLocation()||this._isDirtyGeo()||this._isDirtyFlag()||this._isDirtyPermissions()},h.prototype._getDefaults=function(){return f},h.prototype._toJson=function(a){var b=c.prototype._toJson.call(this,a);b.name=this.name||f.name,b.brand=this.brand||f.brand,b.model=this.model||f.model,b.warrantyDate=this.warrantyDate||f.warrantyDate,b.purchaseDate=this.purchaseDate||f.purchaseDate,b.purchasePrice=this.purchasePrice||f.purchasePrice,b.residualValue=this.residualValue||f.residualValue,b.category=this.category||f.category,b.location=this.location||f.location,b.catalog=this.catalog||f.catalog;for(var d in b)null==b[d]&&delete b[d];return b},h.prototype._fromJson=function(b,d){var e=this;return void 0===b.allowOrder&&(b.allowOrder=f.allowOrder),void 0===b.allowReserve&&(b.allowReserve=f.allowReserve),void 0===b.allowCustody&&(b.allowCustody=f.allowCustody),c.prototype._fromJson.call(this,b,d).then(function(){e.name=b.name||f.name,e.status=b.status||f.status,e.brand=b.brand||f.brand,e.model=b.model||f.model,e.warrantyDate=b.warrantyDate||f.warrantyDate,e.purchaseDate=b.purchaseDate||f.purchaseDate,e.purchasePrice=b.purchasePrice||f.purchasePrice,e.residualValue=b.residualValue||f.residualValue,e.codes=b.codes||f.codes,e.address=b.address||f.address,e.geo=b.geo||f.geo.slice(),e.cover=b.cover||f.cover,e.catalog=b.catalog||f.catalog,e.flagged=b.flagged||f.flagged,e.expired=b.expired||f.expired;var c=f.location;b.location&&(c=b.location._id?b.location._id:b.location),e.location=c;var d=f.category;b.category&&(d=b.category._id?b.category._id:b.category),e.category=d;var g=f.order;b.order&&(g=b.order._id?b.order._id:b.order),e.order=g;var h=f.kit;b.kit&&(h=b.kit._id?b.kit._id:b.kit),e.kit=h;var i=f.custody;return b.custody&&(i=b.custody._id?b.custody._id:b.custody),e.custody=i,e._canReserve=void 0!==b.canReserve?b.canReserve:f.canReserve,e._canOrder=void 0!==b.canOrder?b.canOrder:f.canOrder,e._canCustody=void 0!==b.canCustody?b.canCustody:f.canCustody,e.allowReserve=void 0!==b.allowReserve?b.allowReserve:f.allowReserve,e.allowCheckout=void 0!==b.allowOrder?b.allowOrder:f.allowOrder,e.allowCustody=void 0!==b.allowCustody?b.allowCustody:f.allowCustody,a.publish("item.fromJson",b),b})},h.prototype._toJsonKeyValues=function(){var b={};return null!=this.keyValues&&this.keyValues.length>0&&a.each(this.keyValues,function(a,c){var d="keyValues__"+c.key;b[d+"__kind"]=c.kind,b[d+"__value"]=c.value}),b},h.prototype._isDirtyName=function(){return this._isDirtyStringProperty("name")},h.prototype._isDirtyBrand=function(){return this._isDirtyStringProperty("brand")},h.prototype._isDirtyModel=function(){return this._isDirtyStringProperty("model")},h.prototype._isDirtyWarrantyDate=function(){return this._isDirtyMomentProperty("warrantyDate")},h.prototype._isDirtyPurchaseDate=function(){return this._isDirtyMomentProperty("purchaseDate")},h.prototype._isDirtyPurchasePrice=function(){return this._isDirtyProperty("purchasePrice")},h.prototype._isDirtyResidualValue=function(){return this._isDirtyProperty("residualValue")},h.prototype._isDirtyLocation=function(){if(this.raw&&"in_custody"!=this.status){var a=f.location;return this.raw.location&&(a=this.raw.location._id?this.raw.location._id:this.raw.location),this.location!=a}return!1},h.prototype._isDirtyCategory=function(){if(this.raw){var a=f.category;return this.raw.category&&(a=this.raw.category._id?this.raw.category._id:this.raw.category),this.category!=a}return!1},h.prototype._isDirtyPermissions=function(){if(this.raw){var a=this.raw.allowReserve,b=this.raw.allowOrder,c=this.raw.allowCustody;return this.allowReserve!=a||this.allowCheckout!=b||this.allowCustody!=c}return!1},h.prototype._isDirtyGeo=function(){if(this.raw){var a=this.raw.address||f.address,b=this.raw.geo||f.geo.slice();return this.address!=a||this.geo[0]!=b[0]||this.geo[1]!=b[1]}return!1},h.prototype._isDirtyFlag=function(){return this.raw?this.raw.flag!=this.flag:!1},h.prototype.getAvailabilities=function(a,b){return this.ds.call(this.id,"getAvailability",{fromDate:a,toDate:b})},h.prototype.update=function(b){if(this.isEmpty())return a.Deferred().reject(new Error("Cannot update to empty document"));if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot update document without id"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot update, invalid document"));var c=this,d=a.Deferred(),e=a.Deferred(),f=a.Deferred(),g=a.Deferred(),h=a.Deferred(),i=a.Deferred(),j=a.Deferred();return this._isDirtyCategory()?this.canChangeCategory(this.category).done(function(a){a.result?d.resolve():d.reject(new Error("Unable to change item category"))}):d.resolve(),d.then(function(){return c._isDirtyCategory()?e=c.changeCategory(c.category):e.resolve(),c._isDirtyLocation()&&"in_custody"!=c.status?f=c.changeLocation(c.location):f.resolve(),c._isDirtyFields()?g=c._updateFields():g.resolve(),c._isDirtyFlag()?h=""==c.flag||null==c.flag?c.clearFlag():c.setFlag(c.flag):h.resolve(),c._isDirtyName()||c._isDirtyBrand()||c._isDirtyModel()||c._isDirtyWarrantyDate()||c._isDirtyPurchaseDate()||c._isDirtyPurchasePrice()||c._isDirtyResidualValue()?j=c.updateBasicFields(c.name,c.brand,c.model,c.warrantyDate,c.purchaseDate,c.purchasePrice,c.residualValue):j.resolve(),c._isDirtyPermissions()?i=c.updateAllowedActions(c.allowReserve,c.allowCheckout,c.allowCustody):i.resolve(),a.when(e,f,g,h,j)})},h.prototype.create=function(b){if(this.existsInDb())return a.Deferred().reject(new Error("Cannot create document, already exists in database"));if(this.isEmpty())return a.Deferred().reject(new Error("Cannot create empty document"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot create, invalid document"));var c=this,d=a.extend(this._toJson(),this._toJsonFields());return delete d.id,this.ds.create(d,this._fields).then(function(a){return 1==b?a:c._fromJson(a)})},h.prototype.createMultiple=function(b,c,d,e){if(this.existsInDb())return a.Deferred().reject(new Error("Cannot create document, already exists in database"));if(this.isEmpty())return a.Deferred().reject(new Error("Cannot create empty document"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot create, invalid document"));var f=this,g=a.extend(this._toJson(),this._toJsonFields(),{times:b||1,autoNumber:c||!1,startFrom:d});return delete g.id,null!=g.model&&(g.brandModel=g.model,delete g.model),this._doApiCall({method:"createMultiple",params:g}).then(function(b){var c=1==e?a.Deferred().resolve(b[0]):f._fromJson(b[0]);return c.then(function(){return b})})},h.prototype.duplicate=function(a,b,c,d){return this._doApiCall({method:"duplicate",params:{times:a,location:b,autoNumber:c,startFrom:d},skipRead:!0})},h.prototype.canGoToCheckout=function(){return b.itemCanGoToCheckout(this)&&!a.isEmptyObject(this.order)},h.prototype.canCheckin=function(){return b.itemCanCheckin(this)},h.prototype.canExpire=function(){return b.itemCanExpire(this)},h.prototype.canUndoExpire=function(){return b.itemCanUndoExpire(this)},h.prototype.canDelete=function(){var a=c.prototype.canDelete.call(this);return a&&b.itemCanDelete(this)},h.prototype.expire=function(a,b){return this._doApiCall({method:"expire",params:{message:a||""},skipRead:b})},h.prototype.undoExpire=function(a){return this._doApiCall({method:"undoExpire",skipRead:a})},h.prototype.changeLocation=function(a,b){return this._doApiCall({method:"changeLocation",params:{location:a},skipRead:b})},h.prototype.addCode=function(a,b){return this._doApiCall({method:"addCodes",params:{codes:[a]},skipRead:b})},h.prototype.removeCode=function(a,b){return this._doApiCall({method:"removeCodes",params:{codes:[a]},skipRead:b})},h.prototype.updateGeo=function(a,b,c,d){return this._doApiCall({method:"updateGeo",params:{lat:a,lng:b,address:c},skipRead:d})},h.prototype.getLastNumber=function(){return this.ds.call(null,"getLastItemNumber",{name:this.name})},h.prototype.updateBasicFields=function(a,b,c,d,e,f,g,h){var i=this,j={};return null!=a&&a!=this.raw.name&&(j.name=a),null!=b&&b!=this.raw.brand&&(j.brand=b),null!=c&&c!=this.raw.model&&(j.model=c),null!=d&&("object"==typeof d&&d.isValid()?d.isSame(this.raw.warrantyDate)||(j.warrantyDate=d):j.warrantyDate=""),null!=e&&("object"==typeof e&&e.isValid()?e.isSame(this.raw.purchaseDate)||(j.purchaseDate=e):j.purchaseDate=""),null!=f&&f!=this.raw.purchasePrice&&(j.purchasePrice=f),null!=g&&g!=this.raw.residualValue&&(j.residualValue=g),this.ds.update(this.id,j,this._fields).then(function(a){return 1==h?a:i._fromJson(a)})},h.prototype.canChangeCategory=function(a){return this._doApiCall({collectionCall:!0,method:"canChangeCategory",params:{pks:[this.id],category:a},skipRead:!0,_fields:"*"})},h.prototype.changeCategory=function(a,b){var c=this;return this._doApiCall({collectionCall:!0,method:"changeCategory",params:{pks:[this.id],category:a},skipRead:!0}).then(function(a){return 1==b?a:c._fromJson(a[0])})},h.prototype.updateAllowedActions=function(a,b,c,d){return this._doApiCall({method:"setAllowedActions",params:{reserve:a,order:b,custody:c},skipRead:d})},h.prototype.canReserve=function(){return b.itemCanReserve(this.raw)},h.prototype.canCheckout=function(){return b.itemCanCheckout(this.raw)},h.prototype.canTakeCustody=function(){return b.itemCanTakeCustody(this.raw)},h.prototype.canReleaseCustody=function(){return b.itemCanReleaseCustody(this.raw)},h.prototype.canTransferCustody=function(){return b.itemCanTransferCustody(this.raw)},h.prototype.takeCustody=function(a,b){return this._doApiCall({method:"takeCustody",params:{customer:a},skipRead:b})},h.prototype.releaseCustody=function(a,b){return this._doApiCall({method:"releaseCustody",params:{location:a},skipRead:b})},h.prototype.transferCustody=function(a,b){return this._doApiCall({method:"transferCustody",params:{customer:a},skipRead:b})},h.prototype.getDepreciation=function(a){return this.ds.call(this.id,"getDepreciation",{frequency:a||"quarterly"})},h}(a,z,L),T=function(a,b,c){var d={name:"",items:[],status:"unknown",cover:"",canReserve:"available",canOrder:"available",canCustody:"available",allowReserve:!0,allowOrder:!0,allowCustody:!0},e=function(){};e.prototype=b.prototype;var f=function(c){var e=a.extend({_fields:["*"],crtype:"cheqroom.types.kit"},c);b.call(this,e),this.name=e.name||d.name,this.items=e.items||d.items.slice(),this.codes=[],this.conflicts=[],this.status=e.status||d.status,this.cover=e.cover||d.cover,this.allowReserve=void 0!==e.allowReserve?e.allowReserve:d.allowReserve,this.allowCheckout=void 0!==e.allowOrder?e.allowOrder:d.allowOrder,this.allowCustody=void 0!==e.allowCustody?e.allowCustody:d.allowCustody,this._canReserve=void 0!==e.canReserve?e.canReserve:d.canReserve,this._canOrder=void 0!==e.canOrder?e.canOrder:d.canOrder,this._canCustody=void 0!==e.canCustody?e.canCustody:d.canCustody};return f.prototype=new e,f.prototype.constructor=f,f.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},f.prototype.isNameAvailableAsync=function(){return null!=this.id&&null!=this.raw&&this.name==this.raw.name?a.Deferred().resolve(!0):(this._dfdNameAvailable&&this._dfdNameAvailable.abort(),this._dfdNameAvailable=this.ds.search({name:a.trim(this.name)},"_id"),this._dfdNameAvailable.then(function(a){return 0==a.count},function(a){return!1}))},f.prototype.isValid=function(){return this.isValidName()},f.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==d.name},f.prototype.isDirtyItems=function(){var a=function(a){return a=a||[],a.map(function(a){return a._id}).sort().join(",")},b=this.raw||{};return a(this.items)!=a(b.items)},f.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);return!a&&this.raw&&(a=this._isDirtyStringProperty("name")),a||this.isDirtyItems()},f.prototype.canCheckout=function(){return c.kitCanCheckout(this.raw)},f.prototype.canReserve=function(){return c.kitCanReserve(this.raw)},f.prototype.addItems=function(b,c){return this.existsInDb()?this._doApiCall({method:"addItems",params:{items:b},skipRead:c}):a.Deferred().reject(new Error("Cannot addItems from document without id"))},f.prototype.removeItems=function(b,c){return this.existsInDb()?this._doApiCall({method:"removeItems",params:{items:b},skipRead:c}):a.Deferred().reject(new Error("Cannot removeItems from document without id"))},f.prototype.moveItem=function(b,c,d){return this.existsInDb()?this._doApiCall({method:"moveItem",params:{item:b,toPos:c},skipRead:d}):a.Deferred().reject(new Error("Cannot moveItem from document without id"))},f.prototype.addCode=function(a,b){return this._doApiCall({method:"addCodes",params:{codes:[a]},skipRead:b})},f.prototype.removeCode=function(a,b){return this._doApiCall({method:"removeCodes",params:{codes:[a]},skipRead:b})},f.prototype.duplicate=function(a,b,c){return this._doApiCall({method:"duplicate",params:{times:a,location:b},skipRead:c||!0})},f.prototype.canTakeCustody=function(){return c.kitCanTakeCustody(this.raw)},f.prototype.canReleaseCustody=function(){return c.kitCanReleaseCustody(this.raw)},f.prototype.canTransferCustody=function(){return c.kitCanTransferCustody(this.raw)},f.prototype.takeCustody=function(a,b){return this._doApiCall({method:"takeCustody",params:{customer:a},skipRead:b})},f.prototype.releaseCustody=function(a,b){return this._doApiCall({method:"releaseCustody",params:{location:a},skipRead:b})},f.prototype.transferCustody=function(a,b){return this._doApiCall({method:"transferCustody",params:{customer:a},skipRead:b})},f.prototype._getDefaults=function(){return d},f.prototype._toJson=function(a){var c=b.prototype._toJson.call(this,a);return c.name=this.name||d.name,c},f.prototype._fromJson=function(c,e){var f=this;return b.prototype._fromJson.call(this,c,e).then(function(b){return f.name=b.name||d.name,f.items=b.items||d.items.slice(),f.codes=b.codes||[],f.status=b.status||d.status,f.cover=b.cover||d.cover,f._canReserve=void 0!==b.canReserve?b.canReserve:d.canReserve,f._canOrder=void 0!==b.canOrder?b.canOrder:d.canOrder,f._canCustody=void 0!==b.canCustody?b.canCustody:d.canCustody,f.allowReserve=void 0!==b.allowReserve?b.allowReserve:d.allowReserve,f.allowCheckout=void 0!==b.allowOrder?b.allowOrder:d.allowOrder,f.allowCustody=void 0!==b.allowCustody?b.allowCustody:d.allowCustody,f._loadConflicts(f.items),a.publish("Kit.fromJson",b),b})},f.prototype.create=function(b){if(this.existsInDb())return a.Deferred().reject(new Error("Cannot create document, already exists in database"));var c=this,d={name:this.name,items:this._getIds(this.items)};return a.extend(d,this._toJsonFields()),delete d.id,this.ds.create(d,this._fields).then(function(a){return 1==b?a:c._fromJson(a)})},f.prototype._loadConflicts=function(b){var d=[],e=c.getKitStatus(b);"incomplete"==e&&a.each(b,function(a,b){switch(b.status){case"await_checkout":d.push({kind:"status",item:b._id,itemName:b.name,itemStatus:b.status,order:b.order});break;case"checkedout":d.push({kind:"order",item:b._id,itemName:b.name,itemStatus:b.status,order:b.order});break;case"expired":d.push({kind:"status",item:b._id,itemName:b.name,itemStatus:b.status});break;case"in_custody":d.push({kind:"custody",item:b._id,itemName:b.name,itemStatus:b.status})}}),this.conflicts=d},f}(a,L,z),U=function(a,b){var c={name:"",address:""},d=function(){};d.prototype=b.prototype;var e=function(d){var e=a.extend({_fields:["*"]},d);b.call(this,e),this.name=e.name||c.name,this.address=e.address||c.address};return e.prototype=new d,e.prototype.constructor=e,e.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==c.name&&this.address==c.address},e.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);if(!a&&this.raw){var d=this.raw.name||c.name,e=this.raw.address||c.address;return this.name!=d||this.address!=e}return a},e.prototype._getDefaults=function(){return c},e.prototype._toJson=function(a){var d=b.prototype._toJson.call(this,a);return d.name=this.name||c.name,d.address=this.address||c.address,d},e.prototype._fromJson=function(d,e){var f=this;return b.prototype._fromJson.call(this,d,e).then(function(){return f.name=d.name||c.name,f.address=d.address||c.address,a.publish("location.fromJson",d),d})},e}(a,L),V=function(a,b){var c={name:"",address:""},d=function(){};d.prototype=b.prototype;var e=function(d){var e=a.extend({_fields:["*"]},d);b.call(this,e),this.name=e.name||c.name,this.address=e.address||c.address};return e.prototype=new d,e.prototype.constructor=e,e.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==c.name&&this.address==c.address},e.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);if(!a&&this.raw){var d=this.raw.name||c.name,e=this.raw.address||c.address;return this.name!=d||this.address!=e}return a},e.prototype._getDefaults=function(){return c},e.prototype._toJson=function(a){var d=b.prototype._toJson.call(this,a);return d.name=this.name||c.name,d.address=this.address||c.address,d},e.prototype._fromJson=function(d,e){var f=this;return b.prototype._fromJson.call(this,d,e).then(function(){return f.name=d.name||c.name,f.address=d.address||c.address,a.publish("location.fromJson",d),d})},e}(a,L),W=function(a,b){b.fn.toJSONDate=function(){return this.format("YYYY-MM-DD[T]HH:mm:ss.000[Z]")},b.fn.roundTo=function(a,c,d){a=b.normalizeUnits(a),c=c||1;var e=function(a){switch(d){case"up":a=Math.ceil(a/c);break;case"down":a=Math.floor(a/c);break;default:a=Math.round(a/c)}return a*c};switch(a){case"year":this.year(e(this.year()));break;case"month":this.month(e(this.month()));break;case"week":this.weekday(e(this.weekday()));break;case"isoWeek":this.isoWeekday(e(this.isoWeekday()));break;case"day":this.day(e(this.day()));break;case"hour":this.hour(e(this.hour()));break;case"minute":this.minute(e(this.minute()));break;case"second":this.second(e(this.second()));break;default:this.millisecond(e(this.millisecond()))}return this};var c=15,d=9,e=17,f=function(a){a=a||{},this.roundType=a.roundType||"nearest",this.roundMinutes=a.roundMinutes||c,this.timeFormat24=a.timeFormat24?a.timeFormat24:!1,this._momentFormat=this.timeFormat24?"MMM D [at] H:mm":"MMM D [at] h:mm a",this.startOfDayHours=null!=a.startOfDayHours?startOfDayHours:d,this.endOfDayHours=null!=a.endOfDayHours?endOfDayHours:e,this.businessHours=a.businessHours||[],this.weekStart=a.weekStart||1};return f.prototype.parseDate=function(a){if(("string"==typeof a||a instanceof String)&&a.endsWith("+00:00")){var c=a.length;

if(25==c)return b(a.substring(0,c-6));if(32==c)return b(a.substring(0,c-6).split(".")[0])}},f.prototype.getNow=function(){return b()},f.prototype.getFriendlyDuration=function(a){return a.humanize()},f.prototype.getFriendlyDateParts=function(a,c,d){return b.isMoment(a)||(a=b(a)),c=c||this.getNow(),a.calendar().replace("AM","am").replace("PM","pm").split(" at ")},f.prototype.getDateRanges=function(a,c,d,e){d&&!b.isMoment(d)&&(d=b(d)),e=e||{year:"year",years:"years",month:"month",months:"months",week:"week",weeks:"weeks",day:"day",days:"days",hour:"hour",hours:"hours"};for(var f=["years","months","weeks","days","hours"],g=[8760,720,168,24,1],h=null,i=null,j=null,k=0,l=-1,m=[],n=0;n<f.length;n++)if(i=g[n],h=f[n],a>=i&&a%i==0){l=n;break}if(d=d||this.getNow(),l>=0)for(var n=1;c>=n;n++)k=n*a,j=e[1==k?h.replace("s",""):h],m.push({option:h,hours:k,title:k/g[l]+" "+j,from:d.clone(),to:d.clone().add(k,"hours")});return m.filter(function(a){return global.dateHelper.isValidBusinessDate(a.to)})},f.prototype.getFriendlyFromTo=function(a,c,d,e,f,g){b.isMoment(a)||(a=b(a)),b.isMoment(c)||(c=b(c)),e=e||this.getNow();var h=f||" - ",i=this.getFriendlyDateParts(a,e,g),j=this.getFriendlyDateParts(c,e,g),k={dayDiff:a?a.clone().startOf("day").diff(c,"days"):-1,fromDate:a?i[0]:"No from date set",fromTime:d&&null!=a?i[1]:"",toDate:c?j[0]:"No to date set",toTime:d&&null!=c?j[1]:""};return k.fromText=k.fromDate,k.toText=k.toDate,d&&(k.fromTime&&(k.fromText+=" "+k.fromTime),k.toTime&&(k.toText+=" "+k.toTime)),k.text=0==k.dayDiff?d?k.fromText+h+k.toText:k.fromText:k.fromText+h+k.toText,k},f.prototype.getFriendlyFromToOld=function(a,c,d){var e=this.roundFromTime(a,d),f=this.roundToTime(c,d);return{from:e,to:f,daysBetween:f.clone().startOf("day").diff(e.clone().startOf("day"),"days"),duration:b.duration(e-f).humanize(),fromText:e.calendar().replace(" at "," "),toText:f.calendar().replace(" at "," ")}},f.prototype.makeStartDate=function(a,c,d,e,f,g){if(c=null!=c?c:!0,d=null!=d?d:!1,g=g||b(),c&&!d)a=this.roundTimeFrom(a);else{var h=a.isSame(g,"day"),i=this._makeStartOfBusinessDay(a);a=h?a.isBefore(i)?i:this.roundTimeFrom(a):i}return e&&a.isBefore(e)?e:a},f.prototype.makeEndDate=function(a,c,d,e,f,g){if(c=null!=c?c:!0,d=null!=d?d:!1,g=g||b(),c&&!d)a=this.roundTimeTo(a);else{var h=a.isSame(g,"day"),i=this._makeEndOfBusinessDay(a),j=this._makeEndOfDay(a);a=h?a.isBefore(i)?i:j:a.isAfter(i)?j:i}return f&&a.isAfter(f)?f:a},f.prototype.getFriendlyDateText=function(a,b,c,d){if(null==a)return"Not set";var e=this.getFriendlyDateParts(a,c,d);return b?e.join(" "):e[0]},f.prototype.addAverageDuration=function(a){return a.clone().add(1,"day")},f.prototype.roundTimeFrom=function(a){return this.roundMinutes<=1?a:this.roundTime(a,this.roundMinutes,this._typeToDirection(this.roundType,"from"))},f.prototype.roundTimeTo=function(a){return this.roundMinutes<=1?a:this.roundTime(a,this.roundMinutes,this._typeToDirection(this.roundType,"to"))},f.prototype.roundTime=function(a,d,e){var f=b.isMoment(a)?a:b(a);return f.seconds(0).milliseconds(0),f.roundTo("minute",d||c,e)},f.prototype.roundTimeUp=function(a,d){var e=b.isMoment(a)?a:b(a);return e.seconds(0).milliseconds(0),e.roundTo("minute",d||c,"up")},f.prototype.roundTimeDown=function(a,d){var e=b.isMoment(a)?a:b(a);return e.seconds(0).milliseconds(0),e.roundTo("minute",d||c,"down")},f.prototype._typeToDirection=function(a,b){switch(a){case"longer":switch(b){case"from":return"down";case"to":return"up"}break;case"shorter":switch(b){case"from":return"up";case"to":return"down"}}},f.prototype.isValidBusinessDate=function(c){var d=!1,e=this.businessHours;return e.length>0?a.each(this._getBusinessHours(c),function(a,e){var f=b(b.utc(b.duration(e.openTime,"minutes").asMilliseconds()).format("H:mm"),"H:mm"),g=b(b.utc(b.duration(e.closeTime,"minutes").asMilliseconds()).format("H:mm"),"H:mm"),h=b(c.clone().format("H:mm"),"H:mm");return d=h.isBetween(f,g)||h.isSame(f)||h.isSame(g),d?!1:void 0}):d=!0,d},f.prototype.getValidBusinessDate=function(a){var b=this,c=this.getNow(),d=0;for(a.isBefore(c)&&a.date(c.date());!this.isValidBusinessDate(a)||d>=10080;)a=a.add(b.roundMinutes,"minutes"),d+=b.roundMinutes;return a},f.prototype._getBusinessHours=function(a){var b=this.businessHours;return b.length>0?b.filter(function(b){return b.isoWeekday==a.isoWeekday()}):[]},f.prototype._makeStartOfBusinessDay=function(a){var c=a.clone().hour(this.startOfDayHours).minutes(0).seconds(0).milliseconds(0),d=this.businessHours;if(d.length>0){var e=this._getBusinessHours(a);if(e.length>0){var f=b(b.utc(b.duration(e[0].openTime,"minutes").asMilliseconds()).format("H:mm"),"H:mm");c.hour(f.hour()).minute(f.minute())}}return this.getValidBusinessDate(c)},f.prototype._makeEndOfBusinessDay=function(a){var c=a.clone().hour(this.endOfDayHours).minutes(0).seconds(0).milliseconds(0),d=this.businessHours;if(d.length>0){var e=this._getBusinessHours(a).sort(function(a,b){return a.closeTime<b.closeTime});if(e.length>0){var f=b(b.utc(b.duration(e[0].closeTime,"minutes").asMilliseconds()).format("H:mm"),"H:mm");c.hour(f.hour()).minute(f.minute())}}return this.getValidBusinessDate(c)},f.prototype._makeEndOfDay=function(a){return a.clone().hours(23).minutes(45).seconds(0).milliseconds(0)},f}(a,b),X=function(a,c,d,e,f,g){var h={status:"creating",from:null,to:null,due:null,contact:null,location:null,number:"",items:[],conflicts:[],by:null,archived:null,itemSummary:null,name:null},i=function(){};i.prototype=d.prototype;var j=function(b){var c=a.extend({},b);d.call(this,c),this.dsItems=c.dsItems,this.autoCleanup=null!=c.autoCleanup?c.autoCleanup:!1,this.dateHelper=c.dateHelper||new f,this.helper=c.helper||new g,this.status=c.status||h.status,this.from=c.from||h.from,this.to=c.to||h.to,this.due=c.due||h.due,this.number=c.number||h.number,this.contact=c.contact||h.contact,this.location=c.location||h.location,this.items=c.items||h.items.slice(),this.conflicts=c.conflicts||h.conflicts.slice(),this.by=c.by||h.by,this.itemSummary=c.itemSummary||h.itemSummary,this.name=c.name||h.name};return j.prototype=new i,j.prototype.constructor=d,j.prototype.getNow=function(){return this._getDateHelper().getNow()},j.prototype.getNowRounded=function(){return this._getDateHelper().roundTimeFrom(this.getNow())},j.prototype.getNextTimeSlot=function(a){a=a||this.getNowRounded();var c=this._getDateHelper(),d=b(a).add(c.roundMinutes,"minutes");return d.isSame(a)&&(d=d.add(c.roundMinutes,"minutes")),c.getValidBusinessDate(d)},j.prototype.getMinDateFrom=function(){return this.getMinDate()},j.prototype.getMaxDateFrom=function(){return this.getMaxDate()},j.prototype.getMinDateTo=function(){return this.getNextTimeSlot(this.getMinDateFrom())},j.prototype.getMaxDateTo=function(){return this.getMaxDate()},j.prototype.getMinDateDue=function(){return this.getMinDateTo()},j.prototype.getMaxDateDue=function(){return this.getMaxDateTo()},j.prototype.getMinDate=function(){return this.getNow()},j.prototype.getMaxDate=function(){var a=this._getDateHelper(),b=a.getNow(),c=a.roundTimeTo(b);return c.add(2,"years")},j.prototype.suggestEndDate=function(a){var b=this._getDateHelper(),c=b.addAverageDuration(a||b.getNow());return b.roundTimeTo(c)},j.prototype.isEmpty=function(){return d.prototype.isEmpty.call(this)&&this.status==h.status&&("cheqroom.types.order"==this.crtype?!0:this.from==h.from)&&this.to==h.to&&this.due==h.due&&this.number==h.number&&this.contact==h.contact&&this.location==h.location&&0==this.items.length},j.prototype.isDirty=function(){return d.prototype.isDirty.call(this)||this._isDirtyBasic()||this._isDirtyDates()||this._isDirtyLocation()||this._isDirtyContact()||this._isDirtyItems()},j.prototype._isDirtyBasic=function(){if(this.raw){var a=this.raw.status||h.status;return this.status!=a}return!1},j.prototype._isDirtyDates=function(){if(this.raw){var a=this.raw.from||h.from,b=this.raw.to||h.to,c=this.raw.due||h.due;return this.from!=a||this.to!=b||this.due!=c}return!1},j.prototype._isDirtyLocation=function(){if(this.raw){var a=h.location;return this.raw.location&&(a=this.raw.location._id?this.raw.location._id:this.raw.location),this.location!=a}return!1},j.prototype._isDirtyContact=function(){if(this.raw){var a=h.contact;return this.raw.customer&&(a=this.raw.customer._id?this.raw.customer._id:this.raw.customer),this.contact!=a}return!1},j.prototype._isDirtyItems=function(){if(this.raw){{h.items.slice()}return this.raw.items,!1}return!1},j.prototype._getDefaults=function(){return h},j.prototype._toJson=function(a){var b=d.prototype._toJson.call(this,a);return b.due=this.due,this.location&&(b.location=this._getId(this.location)),this.contact&&(b.customer=this._getId(this.contact)),b},j.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.cover=null,c.status=a.status||h.status,c.number=a.number||h.number,c.location=a.location||h.location,c.contact=a.customer||h.contact,c.items=a.items||h.items.slice(),c.by=a.by||h.by,c.archived=a.archived||h.archived,c.itemSummary=a.itemSummary||h.itemSummary,c.name=a.name||h.name,c._getConflicts().then(function(a){c.conflicts=a})})},j.prototype._toLog=function(a){var b=this._toJson(a);b.minDateFrom=this.getMinDateFrom().toJSONDate(),b.maxDateFrom=this.getMaxDateFrom().toJSONDate(),b.minDateDue=this.getMinDateDue().toJSONDate(),b.maxDateDue=this.getMaxDateDue().toJSONDate(),b.minDateTo=this.getMinDateTo().toJSONDate(),b.maxDateTo=this.getMaxDateTo().toJSONDate()},j.prototype._checkFromDateBetweenMinMax=function(a){return this._checkDateBetweenMinMax(a,this.getMinDateFrom(),this.getMaxDateFrom())},j.prototype._checkDueDateBetweenMinMax=function(a){return this._checkDateBetweenMinMax(a,this.getMinDateDue(),this.getMaxDateDue())},j.prototype._checkToDateBetweenMinMax=function(a){return this._checkDateBetweenMinMax(a,this.getMinDateTo(),this.getMaxDateTo())},j.prototype._getUniqueItemIds=function(a){return a=a||[],a.reduce(function(a,b,c,d){return-1==a.indexOf(b)&&a.push(b),a},[])},j.prototype.clearFromDate=function(a){return this.from=h.from,this._handleTransaction(a)},j.prototype.setFromDate=function(a,b){return this.from=this._getDateHelper().roundTimeFrom(a),this._handleTransaction(b)},j.prototype.clearToDate=function(a){return this.to=h.to,this._handleTransaction(a)},j.prototype.setToDate=function(a,b){return this.to=this._getDateHelper().roundTimeTo(a),this._handleTransaction(b)},j.prototype.clearDueDate=function(a){return this.due=h.due,this._handleTransaction(a)},j.prototype.setDueDate=function(a,b){return this.due=this._getDateHelper().roundTimeTo(a),this._handleTransaction(b)},j.prototype.setLabel=function(b,c){var e=this,f=this.existsInDb()?a.Deferred().resolve():this._createTransaction(c);return f.then(function(){return d.prototype.setLabel.call(e,b,c)})},j.prototype.setLocation=function(a,b){return this.location=a,this.existsInDb()?this._doApiCall({method:"setLocation",params:{location:a},skipRead:b}):this._createTransaction(b)},j.prototype.clearLocation=function(a){var b=this;return this.location=h.location,this._doApiCall({method:"clearLocation",skipRead:a}).then(function(){return b._ensureTransactionDeleted()})},j.prototype.setContact=function(a,b){return this.contact=a,this.existsInDb()?this._doApiCall({method:"setCustomer",params:{customer:a},skipRead:b}):this._createTransaction(b)},j.prototype.clearContact=function(a){var b=this;return this.contact=h.contact,this._doApiCall({method:"clearCustomer",skipRead:a}).then(function(){return b._ensureTransactionDeleted()})},j.prototype.setName=function(a,b){return this._doApiCall({method:"setName",params:{name:a},skipRead:b})},j.prototype.clearName=function(a){return this._doApiCall({method:"clearName",skipRead:a})},j.prototype.addItems=function(a,b){var c=this;return a=c._getUniqueItemIds(a),this._ensureTransactionExists(b).then(function(){return c._doApiCall({method:"addItems",params:{items:a},skipRead:b})})},j.prototype.removeItems=function(b,c){var d=this;return this.existsInDb()?(b=d._getUniqueItemIds(b),this._doApiCall({method:"removeItems",params:{items:b},skipRead:c}).then(function(a){return d._ensureTransactionDeleted().then(function(){return a})})):a.Deferred().reject(new Error("Cannot removeItems from document without id"))},j.prototype.clearItems=function(b){if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot clearItems from document without id"));var c=this;return this._doApiCall({method:"clearItems",skipRead:b}).then(function(a){return c._ensureTransactionDeleted().then(function(){return a})})},j.prototype.swapItem=function(b,c,d){return this.existsInDb()?this._doApiCall({method:"swapItem",params:{fromItem:b,toItem:c},skipRead:d}):a.Deferred().reject(new Error("Cannot swapItem from document without id"))},j.prototype.hasItems=function(b){var c=this.items||[],d=[],e=null;return a.each(b,function(b,f){a.each(c,function(a,b){return b._id==f?(e=f,!1):void 0}),null!=e&&d.push(e)}),d},j.prototype.archive=function(b){return this.canArchive()?this._doApiCall({method:"archive",params:{},skipRead:b}):a.Deferred().reject(new Error("Cannot archive document"))},j.prototype.undoArchive=function(b){return this.canUndoArchive()?this._doApiCall({method:"undoArchive",params:{},skipRead:b}):a.Deferred().reject(new Error("Cannot unarchive document"))},j.prototype.canArchive=function(){return null==this.archived&&("cancelled"==this.status||"closed"==this.status||"closed_manually"==this.status)},j.prototype.canUndoArchive=function(){return null!=this.archived&&("cancelled"==this.status||"closed"==this.status||"closed_manually"==this.status)},j.prototype.setField=function(a,b,c){var d=this;return this._ensureTransactionExists(c).then(function(){return d._doApiCall({method:"setField",params:{field:a,value:b},skipRead:c})})},j.prototype._getConflicts=function(){return a.Deferred().resolve([])},j.prototype._getDateHelper=function(){return this.dateHelper},j.prototype._searchItems=function(b,d,e,f,g){if(null==this.dsItems)return a.Deferred().reject(new c.ApiBadRequest(this.crtype+" has no DataSource for items"));b=b||{},this.location&&(b.location=this._getId(this.location)),null!=d&&d.length>0&&(b.listName=d);var h=this,i=null;return g&&g.length&&(i=g.slice(0),a.each(i,function(a,b){i[a]=h._getId(b)})),1==e?(b.onlyUnbooked=null!=f?f:!0,b.fromDate=this.from,b.toDate=this.to||this.due,b._limit=b._limit||20,b._skip=b._skip||0,i&&i.length&&(b.skipItems=i),this.dsItems.call(null,"searchAvailable",b)):(i&&i.length&&(b.pk__nin=i),this.dsItems.search(b))},j.prototype._checkDateBetweenMinMax=function(b,d,e){if(d=d||this.getMinDate(),e=e||this.getMaxDate(),d>b||b>e){var f="date "+b.toJSONDate()+" is outside of min max range "+d.toJSONDate()+"->"+e.toJSONDate();return a.Deferred().reject(new c.ApiUnprocessableEntity(f))}return a.Deferred().resolve(b)},j.prototype._handleTransaction=function(b){var c=this.isEmpty();return this.existsInDb()?c?this.autoCleanup?this._deleteTransaction():a.Deferred().resolve():this._updateTransaction(b):c?a.Deferred().resolve():this._createTransaction(b)},j.prototype._deleteTransaction=function(){return this["delete"]()},j.prototype._updateTransaction=function(a){return this.update(a)},j.prototype._createTransaction=function(a){return this.create(a)},j.prototype._ensureTransactionExists=function(b){return this.existsInDb()?a.Deferred().resolve():this._createTransaction(b)},j.prototype._ensureTransactionDeleted=function(){return this.isEmpty()&&this.autoCleanup?this._deleteTransaction():a.Deferred().resolve()},j}(a,d,L,V,W,N),Y=function(a){var b={kind:"",doc:"",item:"",itemName:"",locationCurrent:"",locationDesired:"",fromDate:null,toDate:null},c=function(a){this.ds=a.ds,this._fields=a._fields,this.raw=null,this.kind=a.kind||b.kind,this.doc=a.doc||b.doc,this.item=a.item||b.item,this.itemName=a.itemName||b.itemName,this.locationCurrent=a.locationCurrent||b.locationCurrent,this.locationDesired=a.locationDesired||b.locationDesired,this.fromDate=a.fromDate||b.fromDate,this.toDate=a.toDate||b.toDate};return c.prototype._toJson=function(a){return{kind:this.kind,doc:this.doc,item:this.item,itemName:this.itemName,locationCurrent:this.locationCurrent,locationDesired:this.locationDesired,fromDate:this.fromDate,toDate:this.toDate}},c.prototype._fromJson=function(c,d){return this.raw=c,this.kind=c.kind||b.kind,this.item=c.item||b.item,this.itemName=c.itemName||b.itemName,this.fromDate=c.fromDate||b.fromDate,this.toDate=c.toDate||b.toDate,a.Deferred().resolve(c)},c}(a),Z=function(a,b,c,d,e){var f=function(){};f.prototype=c.prototype;var g=function(b){var d=a.extend({crtype:"cheqroom.types.order",_fields:["*"]},b);c.call(this,d),this.dsReservations=d.dsReservations};return g.prototype=new f,g.prototype.constructor=g,g.prototype.getMinDateFrom=function(){return this.getNowRounded()},g.prototype.getMinDateDue=function(){return"open"==this.status?this.getNextTimeSlot():c.prototype.getMinDateDue.call(this)},g.prototype._toJson=function(a){var b=c.prototype._toJson.call(this,a);return b.fromDate=null!=this.fromDate?this.fromDate.toJSONDate():"null",b.toDate=null!=this.toDate?this.toDate.toJSONDate():"null",b.due=null!=this.due?this.due.toJSONDate():"null",b},g.prototype._fromJson=function(b,d){var e=this;return e.from=null==b.started||"null"==b.started?this.getMinDateFrom():b.started,e.to=null==b.finished||"null"==b.finished?null:b.finished,e.due=null==b.due||"null"==b.due?null:b.due,e.reservation=b.reservation||null,c.prototype._fromJson.call(this,b,d).then(function(){return a.publish("order.fromJson",b),b})},g.prototype.getDuration=function(){return e.getOrderDuration(this.raw)},g.prototype.getFriendlyDuration=function(){return e.getFriendlyOrderDuration(this.raw,this._getDateHelper())},g.prototype.canGenerateAgreement=function(){return"open"==this.status||"closed"==this.status},g.prototype.canCheckin=function(){return"open"==this.status},g.prototype.canSpotcheck=function(){return e.canOrderSpotcheck(this.raw)},g.prototype.canGoToReservation=function(){return null!=this.reservation},g.prototype.isValidDueDate=function(){{var a=this.due,b=this.status,c=this.getNextTimeSlot();this.getMaxDateDue()}return"creating"==b||"open"==b?null!=a&&(a.isSame(c)||a.isAfter(c)):!0},g.prototype.canCheckout=function(){var a=this;return"creating"==this.status&&null!=this.location&&null!=this.contact&&"active"==this.contact.status&&this.isValidDueDate()&&this.items&&this.items.length>0&&this.items.filter(function(b){return a.id==a.helper.ensureId(b.order)}).length>0},g.prototype.canCheckoutAgain=function(){return"closed"==this.status&&this.contact&&"active"==this.contact.status&&this.items.filter(function(a){return"available"==a.status}).length==this.items.length},g.prototype.checkoutAgain=function(a){return this._doApiCall({method:"checkoutAgain",params:{},skipRead:a})},g.prototype.canUndoCheckout=function(){return"open"==this.status},g.prototype.canDelete=function(){var a=this;return"creating"==this.status&&this.items.filter(function(b){return b.order&&b.order==a.id}).length==this.items.length},g.prototype.canAddItems=function(){return"creating"==this.status},g.prototype.canRemoveItems=function(){return"creating"==this.status},g.prototype.canRemoveItem=function(a){return"await_checkout"==a.status&&a.order&&a.order==this.id},g.prototype.canSwapItems=function(){return"creating"==this.status},g.prototype.canGenerateDocument=function(){return"open"==this.status||"closed"==this.status},g.prototype.canExtendCheckout=function(a){var b=!0;return("open"!=this.status||a&&a.isBefore(this.getNextTimeSlot()))&&(b=!1),this.contact&&"active"!=this.contact.status&&(b=!1),b},g.prototype._getConflictsForExtend=function(){var b=[];if("open"==this.status){var c=[],d=this;if(a.each(this.items,function(a,b){"checkedout"==b.status&&b.order==d.id&&c.push(b)}),this.due)return this._getServerConflicts(this.items,this.from,this.due,this.id,this.helper.ensureId(this.reservation)).then(function(a){var c=d.items.filter(function(a){return d.helper.ensureId(a.order)==d.id}).map(function(a){return a._id});return b.concat(a.filter(function(a){return-1!=c.indexOf(a.item)}))})}return a.Deferred().resolve(b)},g.prototype._getConflicts=function(){var b=[];return"creating"==this.status&&this.items.length>0&&(b=this._getClientConflicts(),this.due)?this._getServerConflicts(this.items,this.from,this.due,this.id,this.helper.ensureId(this.reservation)).then(function(a){return b.concat(a)}):a.Deferred().resolve(b)},g.prototype._getServerConflicts=function(b,c,f,g,h){var i=this,j=[],k="",l=null,m=e.getItemIds(b.filter(function(a){return a.order==i.id}));return this.dsItems.call(null,"getAvailabilities",{items:m,fromDate:c,toDate:f}).then(function(c){return a.each(c,function(c,e){l=a.grep(b,function(a){return a._id==e.item}),l&&l.length>0&&(l=l[0]),null!=l&&"expired"!=l.status&&"in_custody"!=l.status&&e.order!=g&&e.reservation!=h&&(k="",k=k||(e.order?"order":""),k=k||(e.reservation?"reservation":""),j.push(new d({kind:k,item:l._id,itemName:l.name,fromDate:e.fromDate,toDate:e.toDate,doc:e.order||e.reservation})))}),j})},g.prototype._getClientConflicts=function(){var b=this,c=[],e=this.helper.ensureId(this.location||"");return a.each(this.items,function(a,f){return f.order!=b.id?!0:void("unavailable_allow"===f.canOrder?c.push(new d({kind:"not_allowed_order",item:f._id,itemName:f.name})):"expired"==f.status?c.push(new d({kind:"expired",item:f._id,itemName:f.name,locationCurrent:f.location,locationDesired:e})):"in_custody"==f.status?c.push(new d({kind:"custody",item:f._id,itemName:f.name,locationCurrent:f.location,locationDesired:e})):e&&f.location!=e&&c.push(new d({kind:"location",item:f._id,itemName:f.name,locationCurrent:f.location,locationDesired:e})))}),c},g.prototype.setFromDueDate=function(c,d,e){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order from / due date, status is "+this.status));var f=this,g=this.getMinDateFrom(),h=d?this._getDateHelper().roundTimeTo(d):this._getDateHelper().addAverageDuration(g);return this._checkFromDueDate(g,h).then(function(){return f.from=g,f.due=h,f._handleTransaction(e)})},g.prototype.setFromDate=function(c,d){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order from date, status is "+this.status));var e=this,f=this._getDateHelper().roundTimeFrom(c);return this._checkFromDueDate(f,this.due).then(function(){return e.from=f,e._handleTransaction(d)})},g.prototype.clearFromDate=function(c){return"creating"!=this.status?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot clear order from date, status is "+this.status)):(this.from=null,this._handleTransaction(c))},g.prototype.setDueDate=function(c,d){if("creating"!=this.status&&"open"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order due date, status is "+this.status));var e=this,f=this._getDateHelper().roundTimeTo(c);return this.from=this.getMinDateFrom(),this._checkDueDateBetweenMinMax(f).then(function(){return e.due=f,e.existsInDb()?"open"==e.status?e.canExtend(f).then(function(b){return b&&1==b.result?e.extend(f,d):a.Deferred().reject("Cannot extend order to given date because it has conflicts.",b)}):e._doApiCall({method:"setDueDate",params:{due:f},skipRead:d}):e._createTransaction(d)})},g.prototype.clearDueDate=function(c){return"creating"!=this.status?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot clear order due date, status is "+this.status)):(this.due=null,this._doApiCall({method:"clearDueDate",skipRead:c}))},g.prototype.setToDate=function(a,b){throw"Order.setToDate not implemented, it is set during order close"},g.prototype.clearToDate=function(a,b){throw"Order.clearToDate not implemented, it is set during order close"},g.prototype.searchItems=function(a,b,c,d,e){return this._searchItems(a,null!=e?e:"available",b,c,d||this.items)},g.prototype.checkin=function(b,c,d,e){var f=this;return this._doApiCall({method:"checkin",params:{items:b,location:c},skipRead:d}).then(function(a){return a},function(b){if(!e&&b&&422==b.code){if(b.opt&&-1!=b.opt.detail.indexOf("order has status closed"))return f.get();if(b.opt&&-1!=b.opt.detail.indexOf("already checked in or used somewhere else"))return f.get()}return a.Deferred().reject(b)})},g.prototype.checkout=function(b,c){var d=this;return this._doApiCall({method:"checkout",skipRead:b}).then(function(a){return a},function(b){return!c&&b&&422==b.code&&b.opt&&-1!=b.opt.detail.indexOf("order has status open")?d.get():a.Deferred().reject(b)})},g.prototype.undoCheckout=function(b,c){var d=this;return this._doApiCall({method:"undoCheckout",skipRead:b}).then(function(a){return a},function(b){return!c&&b&&422==b.code&&b.opt&&-1!=b.opt.detail.indexOf("order has status creating")?d.get():a.Deferred().reject(b)})},g.prototype.canExtend=function(b){return a.Deferred().resolve({result:this.canExtendCheckout(b)})},g.prototype.extend=function(b,c){var d=this;return this.canExtend(b).then(function(e){return e&&1==e.result?d._doApiCall({method:"extend",params:{due:b},skipRead:c}):a.Deferred().reject("Cannot extend order to given date because it has conflicts.",e)})},g.prototype.generateDocument=function(a,b,c){return this._doApiLongCall({method:"generateDocument",params:{template:a,signature:b},skipRead:c})},g.prototype._fromCommentsJson=function(b,c){var d=this;return d.dsReservations&&b.reservation&&b.reservation.comments&&b.reservation.comments.length>0?H.prototype._fromCommentsJson.call(d,b.reservation,a.extend(c,{ds:d.dsReservations,fromReservation:!0})).then(function(){var a=d.comments;return H.prototype._fromCommentsJson.call(d,b,c).then(function(){d.comments=d.comments.concat(a).sort(function(a,b){return b.modified>a.modified})})}):H.prototype._fromCommentsJson.call(d,b,c)},g.prototype._fromAttachmentsJson=function(b,c){var d=this;return d.dsReservations&&b.reservation&&b.reservation.comments&&b.reservation.comments.length>0?H.prototype._fromAttachmentsJson.call(d,b.reservation,a.extend(c,{ds:d.dsReservations,fromReservation:!0})).then(function(){var a=d.attachments;return H.prototype._fromAttachmentsJson.call(d,b,c).then(function(){d.attachments=d.attachments.concat(a).sort(function(a,b){return b.modified>a.modified})})}):H.prototype._fromAttachmentsJson.call(d,b,c)},g.prototype._checkFromDueDate=function(c,d){var e=this._getDateHelper(),f=c,g=d;return f&&g?a.when(this._checkDateBetweenMinMax(f),this._checkDateBetweenMinMax(g)).then(function(c,d){var h=e.roundMinutes;return g.diff(f,"minutes")<h?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order from date, after (or too close to) to date "+g.toJSONDate())):f.diff(g,"minutes")>h?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order due date, before (or too close to) from date "+f.toJSONDate())):void 0}):f?this._checkDateBetweenMinMax(f):g?this._checkDateBetweenMinMax(g):a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot from/due date, both are null"))},g}(a,d,X,Y,z),_=function(){var a=function(a,b,c){switch(this.user=a,this.profile=b,this.limits=c,this._isOwner=a.isOwner,this._isRootOrAdmin="root"==a.role||"admin"==a.role,this._isRootOrAdminOrUser="root"==a.role||"admin"==a.role||"user"==a.role,this._isSelfService="selfservice"==a.role,this._isBlockedContact=a.customer&&"blocked"==a.customer.status,this._useWebhooks=c.allowWebhooks&&b.useWebhooks,this._useOrders=c.allowOrders&&b.useOrders,this._useReservations=c.allowReservations&&b.useReservations,this._usePdf=c.allowGeneratePdf,this._useKits=c.allowKits&&b.useKits,this._useCustody=c.allowCustody&&b.useCustody,this._useGeo=b.useGeo,this._useSelfService=c.allowSelfService&&b.useSelfService,this._useCheckinLocation=this._useOrders&&b.orderCheckinLocation,this._usePublicSelfService=c.allowSelfService&&b.usePublicSelfService,this._useOrderTransfers=c.allowOrderTransfers&&b.useOrderTransfers,this._useSendMessage=c.allowSendMessage&&b.useSendMessage,this._useUserSync=c.allowUserSync&&b.useUserSync,this._useFlags=b.useFlags,this._useGeo=b.useGeo,this._useRestrictLocations=c.allowRestrictLocations&&b.useRestrictLocations,this._useReporting=c.allowReporting&&b.useReporting,this._useDepreciations=c.allowDepreciations&&b.useDepreciations,this._useNotifications=c.allowNotifications&&b.useNotifications,this._useBlockContacts=c.allowBlockContacts&&b.useBlockContacts,this._useReservationsClose=this._useReservations&&b.useReservationsClose,this._useSlack=c.allowIntegrationSlack&&b.useIntegrationSlack,this._useApi=c.allowAPI,this._useReleaseAtLocation=this._useCustody&&(void 0!==b.custodyCanChangeLocation?b.custodyCanChangeLocation:!0),this._useSpotcheck=c.allowSpotcheck&&b.useSpotcheck,this._canSetFlag=!1,this._canClearFlag=!1,a.role){case"selfservice":this._canSetFlag=this._useFlags&&b.selfServiceCanSetFlag,this._canClearFlag=this._useFlags&&b.selfServiceCanClearFlag,this._canSetLabel=b.selfServiceCanSetLabel,this._canClearLabel=b.selfServiceCanClearLabel,this._canReadOrders=this._useOrders&&b.selfServiceCanSeeOwnOrders,this._canCreateOrders=this._useOrders&&b.selfServiceCanOrder&&!this._isBlockedContact,this._canOrderConflict=this._useOrders&&b.selfServiceCanOrderConflict,this._canCreateReservations=this._useReservations&&b.selfServiceCanReserve&&!this._isBlockedContact,this._canReadReservations=this._useReservations&&b.selfServiceCanReserve,this._canReservationConflict=this._useReservations&&b.selfServiceCanReservationConflict,this._canTakeCustody=this._useCustody&&b.selfServiceCanCustody&&!this._isBlockedContact,this._canReadOwnCustody=this._useCustody,this._canBlockContacts=!1;break;case"user":this._canSetFlag=this._useFlags&&b.userCanSetFlag,this._canClearFlag=this._useFlags&&b.userCanClearFlag,this._canSetLabel=b.userCanSetLabel,this._canClearLabel=b.userCanClearLabel,this._canReadOrders=this._useOrders,this._canCreateOrders=this._useOrders,this._canOrderConflict=this._useOrders&&b.userCanOrderConflict,this._canCreateReservations=this._useReservations,this._canReadReservations=this._useReservations,this._canReservationConflict=this._useOrders&&b.userCanReservationConflict,this._canTakeCustody=this._useCustody,this._canReadOwnCustody=this._useCustody,this._canBlockContacts=this._useBlockContacts&&b.userCanBlock;break;default:this._canSetFlag=this._useFlags,this._canClearFlag=this._useFlags,this._canSetLabel=!0,this._canClearLabel=!0,this._canReadOrders=this._useOrders,this._canCreateOrders=this._useOrders,this._canOrderConflict=this._useOrders&&b.adminCanOrderConflict,this._canCreateReservations=this._useReservations,this._canReadReservations=this._useReservations,this._canReservationConflict=this._useOrders&&b.adminCanReservationConflict,this._canTakeCustody=this._useCustody,this._canReadOwnCustody=this._useCustody,this._canBlockContacts=this._useBlockContacts}};return a.prototype.canUseItemCustody=function(){return this.limits.allowCustody},a.prototype.canUseItemDepreciation=function(){return this.limits.allowDepreciations},a.prototype.canUseReporting=function(){return this.limits.allowReporting},a.prototype.canUseWebhooks=function(){return this.limits.allowWebhooks},a.prototype.canUseUserSync=function(){return this.limits.allowUserSync},a.prototype.canUseRestrictLocations=function(){return this.limits.allowRestrictLocations},a.prototype.canUseBlockContacts=function(){return this.limits.allowBlockContacts},a.prototype.canUseBusinessHours=function(){return this.limits.allowBusinessHours},a.prototype.canUseSlack=function(){return this.limits.allowIntegrationSlack},a.prototype.canUseSpotcheck=function(){return this.limits.allowSpotcheck},a.prototype.hasUpgradePermission=function(){return this._isOwner||this._isRootOrAdmin},a.prototype.hasAnyAdminPermission=function(){return this.hasPermission("create","locations")||this.hasPermission("create","categories")||this.hasPermission("create","webhooks")||this.hasPermission("create","users")||this.hasPermission("create","templates")||this.hasPermission("create","syncs")},a.prototype.hasDashboardPermission=function(a,b,c){return this._isSelfService?this.hasReservationPermission("read")||this.hasCheckoutPermission("read"):!0;

},a.prototype.hasCalendarPermission=function(a,b,c){return this.hasReservationPermission("read")||this.hasCheckoutPermission("read")},a.prototype.hasItemPermission=function(a,b,c){return this.hasPermission(a||"read","items",b,c)},a.prototype.hasItemCustodyPermission=function(){return this._useCustody||this._canReadOwnCustody},a.prototype.hasItemFlagPermission=function(){return this._useFlags},a.prototype.hasItemGeoPermission=function(){return this._useGeo},a.prototype.hasItemDepreciationPermission=function(){return this._isRootOrAdmin&&this._useDepreciations},a.prototype.hasUserSyncPermission=function(){return this.hasAccountUserSyncPermission("read")},a.prototype.hasSelfservicePermission=function(){return this._useSelfService},a.prototype.hasReportingPermission=function(){return this._isRootOrAdmin&&this._useReporting},a.prototype.hasLabelPermission=function(){return this._canSetLabel&&this._canClearLabel},a.prototype.hasSlackPermission=function(){return this._useSlack},a.prototype.hasApiPermission=function(){return this._useApi},a.prototype.hasSpotcheckPermission=function(){return this._useSpotcheck},a.prototype.hasKitPermission=function(a,b,c){return this.hasPermission(a||"read","kits",b,c)},a.prototype.hasContactPermission=function(a,b,c){return this.hasPermission(a||"read","contacts",b,c)},a.prototype.hasContactReadOtherPermission=function(a,b,c){return!this._isSelfService},a.prototype.hasBlockContactsPermission=function(a,b,c){return this._useBlockContacts},a.prototype.hasCheckoutPermission=function(a,b,c){return this.hasPermission(a||"read","orders",b,c)},a.prototype.hasReservationPermission=function(a,b,c){return this.hasPermission(a||"read","reservations",b,c)},a.prototype.hasCategoriesPermission=function(a,b,c){return this.hasPermission(a,"categories",b,c)},a.prototype.hasNotificationPermission=function(a,b,c){return this.hasPermission(a,"notifications",b,c)},a.prototype.hasUserPermission=function(a,b,c){return this.hasPermission(a,"users",b,c)},a.prototype.hasLocationPermission=function(a,b,c){return this.hasPermission(a,"locations",b,c)},a.prototype.hasRestrictLocationPermission=function(){return this._useRestrictLocations},a.prototype.hasWebhookPermission=function(a,b,c){return this.hasPermission(a,"webhooks",b,c)},a.prototype.hasAccountPermission=function(a,b,c){return this.hasPermission(a,"account",b,c)},a.prototype.hasAccountInvoicesPermission=function(a,b,c){return this.hasPermission(a,"invoices",b,c)},a.prototype.hasAccountSubscriptionPermission=function(a,b,c){return this.hasPermission(a,"subscription",b,c)},a.prototype.hasAccountBillingPermission=function(a,b,c){return this.hasPermission(a,"billing",b,c)},a.prototype.hasAccountTemplatePermission=function(a,b,c){return this.hasPermission(a,"templates",b,c)},a.prototype.hasAccountUserSyncPermission=function(a,b,c){return this.hasPermission(a,"syncs",b,c)},a.prototype.hasAssetTagsPermission=function(a,b,c){return this.hasAnyAdminPermission()},a.prototype.hasPermission=function(a,b,c,d){if(this._isSelfService&&!this._useSelfService)return!1;switch(b){default:return!1;case"items":switch(a){default:return!1;case"read":return!0;case"create":case"duplicate":case"update":case"delete":case"expire":case"undoExpire":case"setFields":case"setField":case"clearField":case"addAttachment":case"addComment":case"updateComment":case"removeComment":case"import":case"export":case"updateGeo":case"changeLocation":case"changeCategory":case"updatePermissions":return this._isRootOrAdmin;case"printLabel":return this._isRootOrAdmin;case"setFlag":return this._useFlags&&this._canSetFlag;case"clearFlag":return this._useFlags&&this._canClearFlag;case"reserve":return this._canCreateReservations;case"checkout":return this._canCreateOrders;case"seeOwnCustody":return this._canReadOwnCustody;case"takeCustody":case"releaseCustody":case"transferCustody":return this._canTakeCustody;case"giveCustody":return this._canTakeCustody&&this._isRootOrAdmin;case"releaseCustodyAt":return this._canTakeCustody&&this._useReleaseAtLocation}break;case"kits":switch(a){default:return!1;case"read":return this._useKits;case"create":case"duplicate":case"update":case"delete":case"setFields":case"setField":case"clearField":case"addAttachment":case"addComment":case"updateComment":case"removeComment":case"addItems":case"removeItems":case"moveItem":case"export":case"updatePermissions":return this._useKits&&this._isRootOrAdmin;case"printLabel":return this._isRootOrAdmin;case"setFlag":return this._useFlags&&this._canSetFlag;case"clearFlag":return this._useFlags&&this._canClearFlag;case"takeApart":return this.profile.canTakeApartKits;case"reserve":return this._canCreateReservations;case"checkout":return this._canCreateOrders;case"seeOwnCustody":return this._canReadOwnCustody;case"takeCustody":case"releaseCustody":case"transferCustody":return this._canTakeCustody;case"giveCustody":return this._canTakeCustody&&this._isRootOrAdmin;case"releaseCustodyAt":return this._canTakeCustody&&this._useReleaseAtLocation}break;case"orders":case"checkouts":switch(a){default:return!1;case"create":case"update":case"delete":return this._canCreateOrders;case"read":return this._canReadOrders;case"setCustomer":case"clearCustomer":case"setLocation":case"clearLocation":case"addItems":case"removeItems":case"swapItems":case"undoCheckout":case"checkout":case"checkin":case"setFields":case"setField":case"clearField":case"extend":case"checkoutAgain":return this._canCreateOrders;case"addAttachment":case"addComment":case"updateComment":case"removeComment":case"export":return this._useOrders;case"archive":case"undoArchive":return this._useOrders&&this._isRootOrAdmin;case"setFlag":return this._useFlags&&this._canSetFlag;case"clearFlag":return this._useFlags&&this._canClearFlag;case"generateDocument":return this._usePdf&&this._canCreateOrders;case"checkinAt":return this._canCreateOrders&&this._useCheckinLocation;case"forceCheckListCheckin":return this.profile.forceCheckListCheckin;case"ignoreConflicts":return this._canOrderConflict}break;case"reservations":switch(a){default:return!1;case"create":case"update":case"delete":return this._canCreateReservations;case"read":return this._canReadReservations;case"setFromToDate":case"setCustomer":case"clearCustomer":case"setLocation":case"clearLocation":case"addItems":case"removeItems":case"swapItems":case"reserve":case"undoReserve":case"cancel":case"undoCancel":case"switchToOrder":case"reserveAgain":case"reserveRepeat":case"setFields":case"setField":case"clearField":case"addAttachment":case"addComment":case"updateComment":case"removeComment":case"export":return this._canCreateReservations;case"makeOrder":return this._canCreateOrders;case"archive":case"undoArchive":return this._useReservations&&this._isRootOrAdmin;case"setFlag":return this._useFlags&&this._canSetFlag;case"clearFlag":return this._useFlags&&this._canClearFlag;case"generateDocument":return this._usePdf&&this._canCreateReservations;case"ignoreConflicts":return this._canReservationConflict;case"close":case"undoClose":return this._useReservationsClose}break;case"customers":case"contacts":switch(a){default:return!1;case"read":case"create":case"update":case"delete":case"archive":case"undoArchive":case"setFields":case"setField":case"clearField":case"addAttachment":case"addComment":case"updateComment":case"removeComment":case"import":case"export":return this._isRootOrAdminOrUser;case"setFlag":return this._useFlags&&this._canSetFlag;case"clearFlag":return this._useFlags&&this._canClearFlag;case"printLabel":return this._isRootOrAdmin;case"generateDocument":return this._usePdf;case"block":case"undoBlock":return this._canBlockContacts}break;case"users":switch(a){default:return!1;case"read":return!0;case"create":case"update":case"delete":case"linkNewCustomer":case"linkCustomer":case"unLinkCustomer":case"inviteUser":case"archive":case"undoArchive":case"activate":case"deactivate":case"clearSync":return this._isRootOrAdmin;case"changeAccountOwner":return this._isOwner}break;case"categories":case"locations":switch(a){default:return!1;case"read":return!0;case"create":case"update":case"delete":case"archive":return this._isRootOrAdmin}break;case"syncs":switch(a){default:return!1;case"read":case"create":case"update":case"delete":case"clone":case"testConnection":case"syncUsers":return this._useUserSync&&this._isRootOrAdmin}break;case"notifications":switch(a){default:return!1;case"read":case"create":case"update":case"delete":return this._useNotifications&&this._isRootOrAdmin}break;case"webhooks":switch(a){default:return!1;case"read":case"create":case"update":case"delete":return this._useWebhooks&&this._isRootOrAdmin}break;case"account":switch(a){default:return this._isRootOrAdmin;case"reset":case"cancelPlan":case"changePlan":return this._isOwner}break;case"subscription":case"invoices":case"billing":case"templates":switch(a){default:return!1;case"read":case"create":case"update":case"delete":case"archive":case"undoArchive":case"activate":case"deactivate":case"clone":return this._isRootOrAdmin}break;case"asset-tags":switch(a){default:return this._isRootOrAdmin}}},a}(),aa=function(a,b,c,d,e){var f=function(){};f.prototype=c.prototype;var g=function(b){var d=a.extend({crtype:"cheqroom.types.reservation",_fields:["*"]},b);c.call(this,d),this.conflicts=[],this.order=null};return g.prototype=new f,g.prototype.constructor=g,g.prototype.getMinDateFrom=function(){return this.getNextTimeSlot()},g.prototype.getMinDateTo=function(){return this.getNextTimeSlot(this.from&&this.from.isBefore(this.getNowRounded())?null:this.from)},g.prototype.getDuration=function(){return e.getReservationDuration(this.raw)},g.prototype.getFriendlyDuration=function(){return e.getFriendlyReservationDuration(this.raw,this._getDateHelper())},g.prototype.isValidFromDate=function(){var a=this.from,b=this.status,c=this.getNow();return"creating"==b||"open"==b?null!=a&&a.isAfter(c):!0},g.prototype.isValidToDate=function(){var a=this.from,b=this.to,c=this.status,d=this.getNow();return"creating"==c||"open"==c?null!=b&&b.isAfter(a)&&b.isAfter(d):!0},g.prototype.canSpotcheck=function(){return e.canReservationSpotcheck(this.raw)},g.prototype.canReserve=function(){return"creating"==this.status&&this.location&&this.contact&&"active"==this.contact.status&&this.isValidFromDate()&&this.isValidToDate()&&this.items&&this.items.length},g.prototype.canUndoReserve=function(){return"open"==this.status},g.prototype.canCancel=function(){return"open"==this.status},g.prototype.canClose=function(){return"open"==this.status},g.prototype.canUndoClose=function(){return"closed_manually"==this.status&&this.contact&&"active"==this.contact.status},g.prototype.canEdit=function(){return"creating"==this.status},g.prototype.canDelete=function(){return"creating"==this.status},g.prototype.canAddItems=function(){return"creating"==this.status},g.prototype.canRemoveItems=function(){return"creating"==this.status},g.prototype.canSwapItems=function(){return"creating"==this.status||"open"==this.status},g.prototype.canMakeOrder=function(){if("open"==this.status&&this.contact&&"active"==this.contact.status&&null!=this.to&&this.to.isAfter(this.getNow())){var b=this._getUnavailableItems(),c=a.map(b,function(a,b){return b}).length;return 0==c}return!1},g.prototype.canGoToOrder=function(){return null!=this.order},g.prototype.canReserveAgain=function(){return("open"==this.status||"closed"==this.status||"closed_manually"==this.status||"cancelled"==this.status)&&this.contact&&"active"==this.contact.status},g.prototype.canReserveRepeat=function(){return("open"==this.status||"closed"==this.status||"closed_manually"==this.status)&&this.contact&&"active"==this.contact.status},g.prototype.canGenerateDocument=function(){return"open"==this.status||"closed"==this.status||"closed_manually"==this.status},g.prototype._toJson=function(a){var b=c.prototype._toJson.call(this,a);return b.fromDate=null!=this.from?this.from.toJSONDate():"null",b.toDate=null!=this.to?this.to.toJSONDate():"null",b},g.prototype._fromJson=function(b,d){var e=this;return e.from=null==b.fromDate||"null"==b.fromDate?null:b.fromDate,e.to=null==b.toDate||"null"==b.toDate?null:b.toDate,e.due=null,e.order=b.order||null,e.repeatId=b.repeatId||null,e.repeatFrequency=b.repeatFrequency||"",c.prototype._fromJson.call(this,b,d).then(function(){return a.publish("reservation.fromJson",b),b})},g.prototype._getConflicts=function(){var b=this,c=[],e=null;if(-1!=["creating","open"].indexOf(this.status)&&this.items&&this.items.length&&(this.location||this.from&&this.to||this.items.filter(function(a){return"available"!==a.canReserve}))){var f=this.location?this._getId(this.location):null,g=this.from&&this.to&&"open"==this.status,h=null!=f,i=!0,j=!0;return this.ds.call(this.id,"getConflicts").then(function(k){return k=k||[],a.each(b.items,function(a,b){if(e=k.find(function(a){return a.item==b._id})){var l=e.kind||"";l=l||(e.order?"order":""),l=l||(e.reservation?"reservation":""),c.push(new d({kind:l,item:b._id,itemName:b.name,doc:e.conflictsWith,fromDate:e.fromDate,toDate:e.toDate,locationCurrent:e.locationCurrent,locationDesired:e.locationDesired}))}else j&&"unavailable_allow"==b.canReserve?c.push(new d({kind:"not_allowed_reservation",item:b._id,itemName:b.name})):i&&"expired"==b.status?c.push(new d({kind:"expired",item:b._id,itemName:b.name,doc:b.order})):i&&"in_custody"==b.status?c.push(new d({kind:"custody",item:b._id,itemName:b.name,doc:b.order})):g&&"available"!=b.status?c.push(new d({kind:"order",item:b._id,itemName:b.name,doc:b.order})):h&&b.location!=f&&c.push(new d({kind:"location",item:b._id,itemName:b.name,locationCurrent:b.location,locationDesired:f,doc:b.order}))}),c})}return a.Deferred().resolve(c)},g.prototype.setFromToDate=function(c,d,e){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation from / to date, status is "+this.status));var f=this,g=this._getDateHelper().roundTimeFrom(c),h=d?this._getDateHelper().roundTimeTo(d):this._getDateHelper().addAverageDuration(g);return this._checkFromToDate(g,h).then(function(){return f.from=g,f.to=h,f._doApiCall({method:"setFromToDate",params:{fromDate:g,toDate:h},skipRead:e})})},g.prototype.setFromDate=function(c,d){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation from date, status is "+this.status));var e=this,f=this._getDateHelper(),g=f.roundMinutes,h=f.roundTimeFrom(c);return this._checkFromDateBetweenMinMax(h).then(function(){return e.to&&e.to.diff(h,"minutes")<g?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation from date, after (or too close to) to date "+e.to.toJSONDate())):(e.from=h,e.existsInDb()?e._doApiCall({method:"setFromDate",params:{fromDate:h},skipRead:d}):e._createTransaction(d))})},g.prototype.clearFromDate=function(c){return"creating"!=this.status?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot clear reservation from date, status is "+this.status)):(this.from=null,this._doApiCall({method:"clearFromDate",skipRead:c}))},g.prototype.setToDate=function(c,d){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation to date, status is "+this.status));var e=this,f=this._getDateHelper(),g=f.roundMinutes,h=f.roundTimeTo(c);return this._checkToDateBetweenMinMax(h).then(function(){return e.from&&e.from.diff(h,"minutes")>g?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation to date, before (or too close to) to date "+e.from.toJSONDate())):(e.to=h,e.existsInDb()?e._doApiCall({method:"setToDate",params:{toDate:h},skipRead:d}):e._createTransaction(d))})},g.prototype.clearToDate=function(c){return"creating"!=this.status?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot clear reservation to date, status is "+this.status)):(this.to=null,this._doApiCall({method:"clearToDate",skipRead:c}))},g.prototype.clearDueDate=function(a){throw"Reservation.clearDueDate not implemented"},g.prototype.setDueDate=function(a,b){throw"Reservation.setDueDate not implemented"},g.prototype.searchItems=function(a,b,c,d){return this._searchItems(a,null,!0,c,d||this.items)},g.prototype.reserve=function(b,c){var d=this;return this._doApiCall({method:"reserve",skipRead:b}).then(function(a){return a},function(b){return!c&&b&&422==b.code&&b.opt&&-1!=b.opt.detail.indexOf("reservation has status open")?d.get():a.Deferred().reject(b)})},g.prototype.undoReserve=function(b,c){var d=this;return this._doApiCall({method:"undoReserve",skipRead:b}).then(function(a){return a},function(b){return!c&&b&&422==b.code&&b.opt&&-1!=b.opt.detail.indexOf("reservation has status creating")?d.get():a.Deferred().reject(b)})},g.prototype.cancel=function(b,c,d){var e=this;return this._doApiCall({method:"cancel",params:{message:b||""},skipRead:c}).then(function(a){return a},function(b){return!d&&b&&422==b.code&&b.opt&&-1!=b.opt.detail.indexOf("reservation has status cancelled")?e.get():a.Deferred().reject(b)})},g.prototype.cancelRepeat=function(b,c,d){var e=this;return this._doApiCall({method:"cancelRepeat",params:{message:b||""},skipRead:c}).then(function(a){return a},function(b){return!d&&b&&422==b.code&&b.opt&&-1!=b.opt.detail.indexOf("reservation has status cancelled")?e.get():a.Deferred().reject(b)})},g.prototype.close=function(b,c,d){var e=this;return this._doApiCall({method:"close",params:{message:b||""},skipRead:c}).then(function(a){return a},function(b){return!d&&b&&422==b.code&&b.opt&&-1!=b.opt.detail.indexOf("reservation has status closed_manually")?e.get():a.Deferred().reject(b)})},g.prototype.undoClose=function(b,c){var d=this;return this._doApiCall({method:"undoClose",skipRead:b}).then(function(a){return a},function(b){return!c&&b&&422==b.code&&b.opt&&-1!=b.opt.detail.indexOf("reservation has status open")?d.get():a.Deferred().reject(b)})},g.prototype.makeOrder=function(b){var c=this;return this._doApiCall({method:"makeOrder",skipRead:!0}).then(function(a){return a},function(d){return!b&&d&&422==d.code&&d.opt&&-1!=d.opt.detail.indexOf("reservation has status closed")?c.get().then(function(a){var b=c._getId(a.order);return{_id:b}}):a.Deferred().reject(d)})},g.prototype.switchToOrder=function(){return this._doApiCall({method:"switchToOrder",skipRead:!0})},g.prototype.generateDocument=function(a,b,c){return this._doApiLongCall({method:"generateDocument",params:{template:a,signature:b},skipRead:c})},g.prototype.reserveAgain=function(a,b,c,d,e){var f={location:d,customer:c};return a&&(f.fromDate=a),b&&(f.toDate=b),this._doApiLongCall({method:"reserveAgain",params:f,skipRead:e})},g.prototype.reserveRepeat=function(a,b,c,d){return this._doApiLongCall({method:"reserveRepeat",params:{frequency:a,until:b,customer:c,location:d},skipRead:!0})},g.prototype._checkFromToDate=function(c,d){var e=this._getDateHelper(),f=c,g=d;return f&&g?a.when(this._checkFromDateBetweenMinMax(f),this._checkToDateBetweenMinMax(g)).then(function(c,d){var h=e.roundMinutes;return g.diff(f,"minutes")<h?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order from date, after (or too close to) to date "+g.toJSONDate())):f.diff(g,"minutes")>h?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order due date, before (or too close to) from date "+f.toJSONDate())):void 0}):f?this._checkFromDateBetweenMinMax(f):g?this._checkToDateBetweenMinMax(g):a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot from/due date, both are null"))},g.prototype._getUnavailableItems=function(){var b={};if("open"==this.status&&this.location&&null!=this.items&&this.items.length>0){{var c=this;c._getId(c.location)}a.each(this.items,function(a,c){"available"!=c.status&&(b.status=b.status||[],b.status.push(c._id))})}return b},g}(a,d,X,Y,z),ba=function(a,b,c,d){var e={id:"",status:"inactive",name:"",body:"",format:"",kind:"",width:0,height:0,unit:"inch",askSignature:!1,system:!0,archived:null,createdBy:null,createdOn:null,modifiedBy:null,modifiedOn:null},f=function(){};f.prototype=d.prototype;var g=function(b){var c=a.extend({},b);d.call(this,c),this.name=c.name||e.name,this.status=c.status||e.status,this.body=c.body||e.body,this.format=c.format||e.format,this.kind=c.kind||e.kind,this.askSignature=null!=c.askSignature?1==c.askSignature:e.askSignature,this.width=c.width||e.width,this.height=c.height||e.height,this.unit=c.unit||e.unit,this.system=null!=c.system?1==c.system:e.system,this.archived=c.archived||e.archived,this.createdBy=c.createdBy||e.createdBy,this.createdOn=c.createdOn||e.createdOn,this.modifiedBy=c.modifiedBy||e.modifiedBy,this.modifiedOn=c.modifiedOn||e.modifiedOn};return g.prototype=new f,g.prototype.constructor=g,g.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},g.prototype.isValid=function(){return this.isValidName()},g.prototype._getDefaults=function(){return e},g.prototype.isEmpty=function(){return d.prototype.isEmpty.call(this)&&this.name==e.name},g.prototype.isArchived=function(){return b.templateIsArchived(this)},g.prototype.isDirty=function(){var a=d.prototype.isDirty.call(this);return!a&&this.raw&&(a=this.name!=this.raw.name||this.body!=this.raw.body||this.format!=this.raw.format||this.kind!=this.raw.kind||this.askSignature!=this.raw.askSignature||this.width!=this.raw.width||this.height!=this.raw.height||this.unit!=this.raw.unit),a},g.prototype.clone=function(){return this.ds.call(this.id,"clone")},g.prototype.archive=function(a){return this._doApiCall({method:"archive",skipRead:a})},g.prototype.undoArchive=function(a){return this._doApiCall({method:"undoArchive",skipRead:a})},g.prototype.activate=function(a){return this._doApiCall({method:"activate",skipRead:a})},g.prototype.deactivate=function(a){return this._doApiCall({method:"deactivate",skipRead:a})},g.prototype.canDelete=function(){return b.templateCanDelete(this)},g.prototype.canActivate=function(){return b.templateCanActivate(this)},g.prototype.canDeactivate=function(){return b.templateCanDeactivate(this)},g.prototype.canArchive=function(){return b.templateCanArchive(this)},g.prototype.canUndoArchive=function(){return b.templateCanUndoArchive(this)},g.prototype._toJson=function(a){var b=d.prototype._toJson.call(this,a);return b.name=this.name,b.body=this.body,b.kind=this.kind,b.askSignature=this.askSignature,b.width=this.width,b.height=this.height,b.unit=this.unit,b},g.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.name=a.name||e.name,c.status=a.status||e.status,c.body=a.body||e.body,c.format=a.format||e.format,c.kind=a.kind||e.kind,c.askSignature=null!=a.askSignature?1==a.askSignature:e.askSignature,c.width=a.width||e.width,c.height=a.height||e.height,c.unit=a.unit||e.unit,c.system=null!=a.system?1==a.system:e.system,c.archived=a.archived||e.archived,c.createdBy=a.createdBy||e.createdBy,c.createdOn=a.createdOn||e.createdOn,c.modifiedBy=a.modifiedBy||e.modifiedBy,c.modifiedOn=a.modifiedOn||e.modifiedOn,a})},g}(a,z,d,B),ca=function(a,c,d,e,f,g){var h={status:"creating",from:null,to:null,due:null,contact:null,location:null,number:"",items:[],conflicts:[],by:null,archived:null,itemSummary:null,name:null},i=function(){};i.prototype=d.prototype;var j=function(b){var c=a.extend({},b);d.call(this,c),this.dsItems=c.dsItems,this.autoCleanup=null!=c.autoCleanup?c.autoCleanup:!1,this.dateHelper=c.dateHelper||new f,this.helper=c.helper||new g,this.status=c.status||h.status,this.from=c.from||h.from,this.to=c.to||h.to,this.due=c.due||h.due,this.number=c.number||h.number,this.contact=c.contact||h.contact,this.location=c.location||h.location,this.items=c.items||h.items.slice(),this.conflicts=c.conflicts||h.conflicts.slice(),this.by=c.by||h.by,this.itemSummary=c.itemSummary||h.itemSummary,this.name=c.name||h.name};return j.prototype=new i,j.prototype.constructor=d,j.prototype.getNow=function(){return this._getDateHelper().getNow()},j.prototype.getNowRounded=function(){return this._getDateHelper().roundTimeFrom(this.getNow())},j.prototype.getNextTimeSlot=function(a){a=a||this.getNowRounded();var c=this._getDateHelper(),d=b(a).add(c.roundMinutes,"minutes");return d.isSame(a)&&(d=d.add(c.roundMinutes,"minutes")),c.getValidBusinessDate(d)},j.prototype.getMinDateFrom=function(){return this.getMinDate()},j.prototype.getMaxDateFrom=function(){return this.getMaxDate()},j.prototype.getMinDateTo=function(){return this.getNextTimeSlot(this.getMinDateFrom())},j.prototype.getMaxDateTo=function(){return this.getMaxDate()},j.prototype.getMinDateDue=function(){return this.getMinDateTo()},j.prototype.getMaxDateDue=function(){return this.getMaxDateTo()},j.prototype.getMinDate=function(){return this.getNow()},j.prototype.getMaxDate=function(){var a=this._getDateHelper(),b=a.getNow(),c=a.roundTimeTo(b);return c.add(2,"years")},j.prototype.suggestEndDate=function(a){var b=this._getDateHelper(),c=b.addAverageDuration(a||b.getNow());return b.roundTimeTo(c)},j.prototype.isEmpty=function(){return d.prototype.isEmpty.call(this)&&this.status==h.status&&("cheqroom.types.order"==this.crtype?!0:this.from==h.from)&&this.to==h.to&&this.due==h.due&&this.number==h.number&&this.contact==h.contact&&this.location==h.location&&0==this.items.length},j.prototype.isDirty=function(){return d.prototype.isDirty.call(this)||this._isDirtyBasic()||this._isDirtyDates()||this._isDirtyLocation()||this._isDirtyContact()||this._isDirtyItems()},j.prototype._isDirtyBasic=function(){if(this.raw){var a=this.raw.status||h.status;return this.status!=a}return!1},j.prototype._isDirtyDates=function(){if(this.raw){var a=this.raw.from||h.from,b=this.raw.to||h.to,c=this.raw.due||h.due;return this.from!=a||this.to!=b||this.due!=c}return!1},j.prototype._isDirtyLocation=function(){if(this.raw){var a=h.location;return this.raw.location&&(a=this.raw.location._id?this.raw.location._id:this.raw.location),this.location!=a}return!1},j.prototype._isDirtyContact=function(){if(this.raw){var a=h.contact;return this.raw.customer&&(a=this.raw.customer._id?this.raw.customer._id:this.raw.customer),this.contact!=a}return!1},j.prototype._isDirtyItems=function(){if(this.raw){{h.items.slice()}return this.raw.items,!1}return!1},j.prototype._getDefaults=function(){return h},j.prototype._toJson=function(a){var b=d.prototype._toJson.call(this,a);return b.due=this.due,this.location&&(b.location=this._getId(this.location)),this.contact&&(b.customer=this._getId(this.contact)),b},j.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.cover=null,c.status=a.status||h.status,c.number=a.number||h.number,c.location=a.location||h.location,c.contact=a.customer||h.contact,c.items=a.items||h.items.slice(),c.by=a.by||h.by,c.archived=a.archived||h.archived,c.itemSummary=a.itemSummary||h.itemSummary,c.name=a.name||h.name,c._getConflicts().then(function(a){c.conflicts=a})})},j.prototype._toLog=function(a){var b=this._toJson(a);b.minDateFrom=this.getMinDateFrom().toJSONDate(),b.maxDateFrom=this.getMaxDateFrom().toJSONDate(),b.minDateDue=this.getMinDateDue().toJSONDate(),b.maxDateDue=this.getMaxDateDue().toJSONDate(),b.minDateTo=this.getMinDateTo().toJSONDate(),b.maxDateTo=this.getMaxDateTo().toJSONDate()},j.prototype._checkFromDateBetweenMinMax=function(a){return this._checkDateBetweenMinMax(a,this.getMinDateFrom(),this.getMaxDateFrom())},j.prototype._checkDueDateBetweenMinMax=function(a){return this._checkDateBetweenMinMax(a,this.getMinDateDue(),this.getMaxDateDue())},j.prototype._checkToDateBetweenMinMax=function(a){return this._checkDateBetweenMinMax(a,this.getMinDateTo(),this.getMaxDateTo())},j.prototype._getUniqueItemIds=function(a){return a=a||[],a.reduce(function(a,b,c,d){return-1==a.indexOf(b)&&a.push(b),a},[])},j.prototype.clearFromDate=function(a){return this.from=h.from,this._handleTransaction(a)},j.prototype.setFromDate=function(a,b){return this.from=this._getDateHelper().roundTimeFrom(a),this._handleTransaction(b)},j.prototype.clearToDate=function(a){return this.to=h.to,this._handleTransaction(a)},j.prototype.setToDate=function(a,b){return this.to=this._getDateHelper().roundTimeTo(a),this._handleTransaction(b)},j.prototype.clearDueDate=function(a){return this.due=h.due,this._handleTransaction(a)},j.prototype.setDueDate=function(a,b){return this.due=this._getDateHelper().roundTimeTo(a),this._handleTransaction(b)},j.prototype.setLabel=function(b,c){var e=this,f=this.existsInDb()?a.Deferred().resolve():this._createTransaction(c);return f.then(function(){return d.prototype.setLabel.call(e,b,c)})},j.prototype.setLocation=function(a,b){return this.location=a,this.existsInDb()?this._doApiCall({method:"setLocation",params:{location:a},skipRead:b}):this._createTransaction(b)},j.prototype.clearLocation=function(a){var b=this;return this.location=h.location,this._doApiCall({method:"clearLocation",skipRead:a}).then(function(){return b._ensureTransactionDeleted()})},j.prototype.setContact=function(a,b){return this.contact=a,this.existsInDb()?this._doApiCall({method:"setCustomer",params:{customer:a},skipRead:b}):this._createTransaction(b)},j.prototype.clearContact=function(a){var b=this;return this.contact=h.contact,this._doApiCall({method:"clearCustomer",skipRead:a}).then(function(){return b._ensureTransactionDeleted()})},j.prototype.setName=function(a,b){return this._doApiCall({method:"setName",params:{name:a},skipRead:b})},j.prototype.clearName=function(a){return this._doApiCall({method:"clearName",skipRead:a})},j.prototype.addItems=function(a,b){var c=this;return a=c._getUniqueItemIds(a),this._ensureTransactionExists(b).then(function(){return c._doApiCall({method:"addItems",params:{items:a},skipRead:b})})},j.prototype.removeItems=function(b,c){var d=this;return this.existsInDb()?(b=d._getUniqueItemIds(b),this._doApiCall({method:"removeItems",params:{items:b},skipRead:c}).then(function(a){return d._ensureTransactionDeleted().then(function(){return a})})):a.Deferred().reject(new Error("Cannot removeItems from document without id"))},j.prototype.clearItems=function(b){if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot clearItems from document without id"));var c=this;return this._doApiCall({method:"clearItems",skipRead:b}).then(function(a){return c._ensureTransactionDeleted().then(function(){return a})})},j.prototype.swapItem=function(b,c,d){return this.existsInDb()?this._doApiCall({method:"swapItem",params:{fromItem:b,toItem:c},skipRead:d}):a.Deferred().reject(new Error("Cannot swapItem from document without id"))},j.prototype.hasItems=function(b){var c=this.items||[],d=[],e=null;return a.each(b,function(b,f){a.each(c,function(a,b){return b._id==f?(e=f,!1):void 0}),null!=e&&d.push(e)}),d},j.prototype.archive=function(b){return this.canArchive()?this._doApiCall({method:"archive",params:{},skipRead:b}):a.Deferred().reject(new Error("Cannot archive document"))},j.prototype.undoArchive=function(b){return this.canUndoArchive()?this._doApiCall({method:"undoArchive",params:{},skipRead:b}):a.Deferred().reject(new Error("Cannot unarchive document"))},j.prototype.canArchive=function(){return null==this.archived&&("cancelled"==this.status||"closed"==this.status||"closed_manually"==this.status)},j.prototype.canUndoArchive=function(){return null!=this.archived&&("cancelled"==this.status||"closed"==this.status||"closed_manually"==this.status)},j.prototype.setField=function(a,b,c){var d=this;return this._ensureTransactionExists(c).then(function(){return d._doApiCall({method:"setField",params:{field:a,value:b},skipRead:c})})},j.prototype._getConflicts=function(){return a.Deferred().resolve([])},j.prototype._getDateHelper=function(){return this.dateHelper},j.prototype._searchItems=function(b,d,e,f,g){if(null==this.dsItems)return a.Deferred().reject(new c.ApiBadRequest(this.crtype+" has no DataSource for items"));b=b||{},this.location&&(b.location=this._getId(this.location)),null!=d&&d.length>0&&(b.listName=d);var h=this,i=null;return g&&g.length&&(i=g.slice(0),a.each(i,function(a,b){i[a]=h._getId(b)})),1==e?(b.onlyUnbooked=null!=f?f:!0,b.fromDate=this.from,b.toDate=this.to||this.due,
b._limit=b._limit||20,b._skip=b._skip||0,i&&i.length&&(b.skipItems=i),this.dsItems.call(null,"searchAvailable",b)):(i&&i.length&&(b.pk__nin=i),this.dsItems.search(b))},j.prototype._checkDateBetweenMinMax=function(b,d,e){if(d=d||this.getMinDate(),e=e||this.getMaxDate(),d>b||b>e){var f="date "+b.toJSONDate()+" is outside of min max range "+d.toJSONDate()+"->"+e.toJSONDate();return a.Deferred().reject(new c.ApiUnprocessableEntity(f))}return a.Deferred().resolve(b)},j.prototype._handleTransaction=function(b){var c=this.isEmpty();return this.existsInDb()?c?this.autoCleanup?this._deleteTransaction():a.Deferred().resolve():this._updateTransaction(b):c?a.Deferred().resolve():this._createTransaction(b)},j.prototype._deleteTransaction=function(){return this["delete"]()},j.prototype._updateTransaction=function(a){return this.update(a)},j.prototype._createTransaction=function(a){return this.create(a)},j.prototype._ensureTransactionExists=function(b){return this.existsInDb()?a.Deferred().resolve():this._createTransaction(b)},j.prototype._ensureTransactionDeleted=function(){return this.isEmpty()&&this.autoCleanup?this._deleteTransaction():a.Deferred().resolve()},j}(a,d,L,V,W,N),da=function(a,b,c){var d={name:"",email:"",group:"",picture:"",role:"user",active:!0,isOwner:!1,archived:null,restrictLocations:[]},e=function(){};e.prototype=b.prototype;var f=function(c){var e=a.extend({_fields:["*","group","picture"]},c);b.call(this,e),this.helper=e.helper,this.name=e.name||d.name,this.picture=e.picture||d.picture,this.email=e.email||d.email,this.role=e.role||d.role,this.group=e.group||d.group,this.active=null!=e.active?e.active:d.active,this.isOwner=null!=e.isOwner?e.isOwner:d.isOwner,this.archived=e.archived||d.archived,this.restrictLocations=e.restrictLocations?e.restrictLocations.slice():d.restrictLocations.slice(),this.dsAnonymous=e.dsAnonymous};return f.prototype=new e,f.prototype.constructor=f,f.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=4},f.prototype.isValidEmail=function(){return this.email=a.trim(this.email),c.isValidEmail(this.email)},f.prototype.isValidRole=function(){switch(this.role){case"user":case"admin":case"root":case"selfservice":return!0;default:return!1}},f.prototype.emailExists=function(){return this.isValidEmail()?null!=this.id&&this.email==this.raw.email?a.Deferred().resolve(!1):this.dsAnonymous.call("emailExists",{email:this.email}).then(function(a){return a.result}):a.Deferred().resolve(!1)},f.prototype.isValidPassword=function(){return this.password=a.trim(this.password),c.isValidPassword(this.password)},f.prototype.isValid=function(){return this.isValidName()&&this.isValidEmail()&&this.isValidRole()},f.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==d.name&&this.email==d.email&&this.role==d.role&&this.restrictLocations&&0==this.restrictLocations.length},f.prototype._isDirtyInfo=function(){if(this.raw){var a=this.raw.name||d.name,b=this.raw.role||d.role,c=this.raw.email||d.email,e=null!=this.raw.active?this.raw.active:d.active;return this.name!=a||this.email!=c||this.role!=b||this.active!=e}return!1},f.prototype._isDirtyRestrictLocations=function(){if(this.raw){var a=this,b=this.raw.restrictLocations||d.restrictLocations;return this.restrictLocations.filter(function(a){return b.indexOf(a)<0}).length>0||b.filter(function(b){return a.restrictLocations.indexOf(b)<0}).length>0}return!1},f.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);return a||this._isDirtyInfo()||this._isDirtyRestrictLocations()},f.prototype.getImageUrl=function(a,b){return null!=this.picture&&this.picture.length>0?this.helper.getImageCDNUrl(this.group,this.picture,a,b):this.helper.getImageUrl(this.ds,this.id,a,b)},f.prototype._getDefaults=function(){return d},f.prototype.addKeyValue=function(b,c,d,e){return a.Deferred().reject("Not implemented for User, use setPicture instead?")},f.prototype.addKeyValue=function(b,c,d,e,f){return a.Deferred().reject("Not implemented for User, use setPicture instead?")},f.prototype.removeKeyValue=function(b,c){return a.Deferred().reject("Not implemented for User, use clearPicture instead?")},f.prototype.setPicture=function(b,c){return this.existsInDb()?(this.picture=b,this._doApiCall({method:"setPicture",params:{attachment:b},skipRead:c})):a.Deferred().reject("User does not exist in database")},f.prototype.clearPicture=function(b){return this.existsInDb()?this._doApiCall({method:"clearPicture",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.canActivate=function(){return!this.active&&null==this.archived},f.prototype.canDeactivate=function(){return this.active&&null==this.archived&&!this.isOwner},f.prototype.canArchive=function(){return null==this.archived&&!this.isOwner},f.prototype.canUndoArchive=function(){return null!=this.archived},f.prototype.canBeOwner=function(){return null==this.archived&&this.active&&!this.isOwner&&"admin"==this.role},f.prototype.activate=function(b){return this.existsInDb()?this._doApiCall({method:"activate",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.deactivate=function(b){return this.existsInDb()?this._doApiCall({method:"deactivate",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.archive=function(b){return this.existsInDb()?this._doApiCall({method:"archive",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.undoArchive=function(b){return this.existsInDb()?this._doApiCall({method:"undoArchive",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.setRestrictLocations=function(b,c){return this.existsInDb()?this._doApiCall({method:"setRestrictLocations",params:{restrictLocations:b},skipRead:c}):a.Deferred().reject("User does not exist in database")},f.prototype.clearRestrictLocations=function(b){return this.existsInDb()?this._doApiCall({method:"clearRestrictLocations",skipRead:b}):a.Deferred().reject("User does not exist in database")},f.prototype.update=function(b){if(this.isEmpty())return a.Deferred().reject(new Error("Cannot update to empty user"));if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot update user without id"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot update, invalid user"));var c=a.Deferred(),d=a.Deferred();return this._isDirtyInfo()?d=this.ds.update(this.id,this._toJson(),this._fields):d.resolve(),this._isDirtyRestrictLocations()?c=0!=this.restrictLocations.length?this.setRestrictLocations(this.restrictLocations,!0):this.clearRestrictLocations(!0):c.resolve(),a.when(d,c)},f.prototype._toJson=function(a){var c=b.prototype._toJson.call(this,a);return c.name=this.name||d.name,c.email=this.email||d.email,c.group=this.group||d.group,c.role=this.role||d.role,c},f.prototype._fromJson=function(c,e){var f=this;return b.prototype._fromJson.call(this,c,e).then(function(){return f.group=c.group&&null!=c.group._id?c.group._id:c.group||d.group,f.name=c.name||d.name,f.picture=c.picture||d.picture,f.email=c.email||d.email,f.role=c.role||d.role,f.active=null!=c.active?c.active:d.active,f.isOwner=null!=c.isOwner?c.isOwner:d.isOwner,f.archived=c.archived||d.archived,f.restrictLocations=c.restrictLocations?c.restrictLocations.slice():d.restrictLocations.slice(),a.publish("user.fromJson",c),c})},f}(a,L,z),ea=function(a,b,c){var d={kind:"ldap",name:"",host:"ldap://yourdomain.com",port:389,timeOut:10,login:"",password:"",newUsers:"create",existingUsers:"update",missingUsers:"ignore",overwriteLocalUsers:!0,autoSync:!1,role:"selfservice",query:"(cn=*)",base:"ou=team,dc=yourdomain,dc=com",loginField:"uid",nameField:"cn",emailField:"mail",restrictLocations:[],timezone:"Etc/GMT",hostCert:"ldap_tls_demand",caCert:"",report:"always",reportEmail:""},e=function(){};e.prototype=b.prototype;var f=function(c){var e=a.extend({_fields:["*"]},c);b.call(this,e),this.helper=e.helper,this.kind=e.kind||d.kind,this.name=e.name||d.name,this.host=e.host||d.host,this.port=e.port||d.port,this.timeOut=e.timeOut||d.timeOut,this.login=e.login||d.login,this.password=e.password||d.password,this.newUsers=e.newUsers||d.newUsers,this.existingUsers=e.existingUsers||d.existingUsers,this.missingUsers=e.missingUsers||d.missingUsers,this.autoSync=null!=e.autoSync?e.autoSync:d.autoSync,this.overwriteLocalUsers=null!=e.overwriteLocalUsers?e.overwriteLocalUsers:d.overwriteLocalUsers,this.role=e.role||d.role,this.query=e.query||d.query,this.base=e.base||d.base,this.loginField=e.loginField||d.loginField,this.nameField=e.nameField||d.nameField,this.emailField=e.emailField||d.emailField,this.restrictLocations=e.restrictLocations?e.restrictLocations.slice():d.restrictLocations.slice(),this.timezone=e.timezone||d.timezone,this.hostCert=e.hostCert||d.hostCert,this.caCert=e.caCert||d.caCert,this.report=e.report||d.report,this.reportEmail=e.reportEmail||d.reportEmail};return f.prototype=new e,f.prototype.constructor=f,f.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},f.prototype.isValidRole=function(){switch(this.role){case"user":case"admin":case"selfservice":return!0;default:return!1}},f.prototype.isValid=function(){return this.isValidName()&&this.isValidRole()},f.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.kind==d.kind&&this.name==d.name&&this.host==d.host&&this.port==d.port&&this.timeOut==d.timeOut&&this.login==d.login&&this.password==d.password&&this.newUsers==d.newUsers&&this.existsingUsers==d.existingUsers&&this.missingUsers==d.missingUsers&&this.autoSync==d.autoSync&&this.overwriteLocalUsers==d.overwriteLocalUsers&&this.role==d.role&&this.query==d.query&&this.base==d.base&&this.loginField==d.loginField&&this.nameField==d.nameField&&this.emailField==d.emailField&&this.timezone==d.timezone&&this.hostCert==d.hostCert&&this.caCert==d.caCert&&this.report==d.report&&this.reportEmail==d.reportEmail&&this.restrictLocations&&0==this.restrictLocations.length},f.prototype.isDirty=function(){return this._isDirtyInfo()||this._isDirtyRestrictLocations()},f.prototype._isDirtyInfo=function(){var a=b.prototype.isDirty.call(this);if(!a&&this.raw){var c=this.raw.kind||d.kind,e=this.raw.name||d.name,f=this.raw.host||d.host,g=this.raw.port||d.port,h=this.raw.timeOut||d.timeOut,i=this.raw.login||d.login,j=this.raw.password||d.password,k=this.raw.newUsers||d.newUsers,l=this.raw.existingUsers||d.existingUsers,m=this.raw.missingUsers||d.missingUsers,n=null!=this.raw.autoSync?this.raw.autoSync:d.autoSync,o=null!=this.raw.overwriteLocalUsers?this.raw.overwriteLocalUsers:d.overwriteLocalUsers,p=this.raw.role||d.role,q=this.raw.query||d.query,r=this.raw.base||d.base,s=this.raw.loginField||d.loginField,t=this.raw.nameField||d.nameField,u=this.raw.emailField||d.emailField,v=this.raw.timezone||d.timezone,w=this.raw.hostCert||d.hostCert,x=this.raw.caCert||d.caCert,y=this.raw.report||d.report,z=this.raw.reportEmail||d.reportEmail;return this.kind!=c||this.name!=e||this.host!=f||this.port!=g||this.timeOut!=h||this.login!=i||this.password!=j||this.newUsers!=k||this.existingUsers!=l||this.missingUsers!=m||this.autoSync!=n||this.overwriteLocalUsers!=o||this.role!=p||this.query!=q||this.base!=r||this.loginField!=s||this.nameField!=t||this.emailField!=u||this.timezone!=v||this.hostCert!=w||this.caCert!=x||this.report!=y||this.reportEmail!=z||this._isDirtyRestrictLocations()}return a},f.prototype._isDirtyRestrictLocations=function(){if(this.raw){var a=this,b=this.raw.restrictLocations||d.restrictLocations;return this.restrictLocations.filter(function(a){return b.indexOf(a)<0}).length>0||b.filter(function(b){return a.restrictLocations.indexOf(b)<0}).length>0}return!1},f.prototype._getDefaults=function(){return d},f.prototype.clone=function(){return this.ds.call(this.id,"clone")},f.prototype.testConnection=function(){return this.ds.call(this.id,"testConnection")},f.prototype.syncUsers=function(a){return this.ds.call(this.id,"syncUsers",{wetRun:a})},f.prototype._toJson=function(a){var c=b.prototype._toJson.call(this,a);return c.kind=this.kind||d.kind,c.name=this.name||d.name,c.host=this.host||d.host,c.port=this.port||d.port,c.timeOut=this.timeOut||d.timeOut,c.login=this.login||d.login,this.password&&(c.password=this.password),c.newUsers=this.newUsers||d.newUsers,c.existingUsers=this.existingUsers||d.existingUsers,c.missingUsers=this.missingUsers||d.missingUsers,c.autoSync=null!=this.autoSync?this.autoSync:d.autoSync,c.overwriteLocalUsers=null!=this.overwriteLocalUsers?this.overwriteLocalUsers:d.overwriteLocalUsers,c.role=this.role||d.role,c.query=this.query||d.query,c.base=this.base||d.base,c.loginField=this.loginField||d.loginField,c.nameField=this.nameField||d.nameField,c.emailField=this.emailField||d.emailField,c.timezone=this.timezone||d.timezone,c.hostCert=this.hostCert||d.hostCert,c.caCert=this.caCert||d.caCert,c.report=this.report||d.report,c.reportEmail=this.reportEmail||d.reportEmail,c},f.prototype._fromJson=function(c,e){var f=this;return b.prototype._fromJson.call(this,c,e).then(function(){return f.kind=c.kind||d.kind,f.name=c.name||d.name,f.host=c.host||d.host,f.port=c.port||d.port,f.timeOut=c.timeOut||d.timeOut,f.login=c.login||d.login,f.password=c.password||d.password,f.newUsers=c.newUsers||d.newUsers,f.existingUsers=c.existingUsers||d.existingUsers,f.missingUsers=c.missingUsers||d.missingUsers,f.autoSync=null!=c.autoSync?c.autoSync:d.autoSync,f.overwriteLocalUsers=null!=c.overwriteLocalUsers?c.overwriteLocalUsers:d.overwriteLocalUsers,f.role=c.role||d.role,f.query=c.query||d.query,f.base=c.base||d.base,f.loginField=c.loginField||d.loginField,f.nameField=c.nameField||d.nameField,f.emailField=c.emailField||d.emailField,f.restrictLocations=c.restrictLocations?c.restrictLocations.slice():d.restrictLocations.slice(),f.timezone=c.timezone||d.timezone,f.hostCert=c.hostCert||d.hostCert,f.caCert=c.caCert||d.caCert,f.report=c.report||d.report,f.reportEmail=c.reportEmail||d.reportEmail,a.publish("usersync.fromJson",c),c})},f.prototype.setRestrictLocations=function(b,c){return this.existsInDb()?this._doApiCall({method:"setRestrictLocations",params:{restrictLocations:b},skipRead:c}):a.Deferred().reject("Usersync does not exist in database")},f.prototype.clearRestrictLocations=function(b){return this.existsInDb()?this._doApiCall({method:"clearRestrictLocations",skipRead:b}):a.Deferred().reject("Usersync does not exist in database")},f.prototype.update=function(b){if(this.isEmpty())return a.Deferred().reject(new Error("Cannot update to empty usersync"));if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot update usersync without id"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot update, invalid usersync"));var c=this,d=a.Deferred(),e=a.Deferred(),f=this._toJson();return this._isDirtyInfo()?e=this.ds.update(this.id,f,this._fields).then(function(a){c._fromJson(a)}):e.resolve(),this._isDirtyRestrictLocations()?d=0!=this.restrictLocations.length?this.setRestrictLocations(this.restrictLocations,!0):this.clearRestrictLocations(!0):d.resolve(),a.when(e,d)},f.prototype.create=function(b){return this.existsInDb()?a.Deferred().reject(new Error("Cannot create document, already exists in database")):this.isEmpty()?a.Deferred().reject(new Error("Cannot create empty document")):this._create(b)},f}(a,L,z),fa=function(a,b,c,d){var e={id:"",name:"",address:"",topic:"",hookFields:"*, location.*, items.*, customer.*,by.name,by.email",format:"",created:null,modified:null,enabled:!0,log10:[],fails:0,minutes:0},f=function(){};f.prototype=d.prototype;var g=function(b){var c=a.extend({},b);d.call(this,c),this.name=c.name||e.name,this.address=c.address||e.address,this.topic=c.topic||e.topic,this.hookFields=c.hookFields||e.hookFields,this.created=c.created||e.created,this.modified=c.modified||e.modified,this.enabled=null!=c.enabled?1==c.enabled:e.enabled,this.log10=c.log10||e.log10.slice(),this.fails=c.fails||e.fails,this.minutes=c.minutes||e.minutes};return g.prototype=new f,g.prototype.constructor=g,g.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},g.prototype.isValidAddress=function(){return this.address=a.trim(this.address),b.isValidURL(this.address)},g.prototype.isValid=function(){return this.isValidName()&&this.isValidAddress()&&this.topic},g.prototype._getDefaults=function(){return e},g.prototype.isEmpty=function(){return d.prototype.isEmpty.call(this)&&this.name==e.name&&this.address==e.address&&this.topic==e.topic},g.prototype.isDirty=function(){var a=d.prototype.isDirty.call(this);return!a&&this.raw&&(a=this.name!=this.raw.name||this.address!=this.raw.address||this.topic!=this.raw.topic||this.enabled!=this.raw.enabled||this.minutes!=this.raw.minutes),a},g.prototype.canDelete=function(){return a.Deferred().resolve(!0)},g.prototype._toJson=function(a){var b=d.prototype._toJson.call(this,a);return b.name=this.name,b.address=this.address,b.topic=this.topic,b.fields=this.hookFields,b.enabled=this.enabled,b.minutes=this.minutes,b},g.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.name=a.name||e.name,c.address=a.address||e.address,c.topic=a.topic||e.topic,c.hookFields=a.fields||e.hookFields,c.created=a.created_at||e.created,c.modified=a.modified||e.modified,c.enabled=null!=a.enabled?1==a.enabled:e.enabled,c.log10=a.log10||e.log10.slice(),c.fails=a.nr_consecutive_fails||e.fails,c.minutes=a.minutes||e.minutes,a})},g}(a,z,d,B),ga=function(a,b){var c={by:null,created:null,modified:null,status:"creating",items:[],started:null,accepted:null,fromOrder:null,toOrder:null,startedBy:null},d=function(){};d.prototype=b.prototype;var e=function(d){var e=a.extend({_fields:["*"],crtype:"cheqroom.types.reservation.ordertransfer"},d);b.call(this,e),this.by=e.by||c.by,this.created=e.created||c.created,this.modified=e.modified||c.modified,this.status=e.status||c.status,this.items=e.items||c.items,this.started=e.started||c.started,this.accepted=e.accepted||c.accepted,this.fromOrder=e.fromOrder||c.fromOrder,this.toOrder=e.toOrder||c.toOrder,this.startedBy=e.startedBy||c.startedBy};return e.prototype=new d,e.prototype.constructor=e,e.prototype.isEmpty=function(){return!1},e.prototype._toJson=function(a){var d=b.prototype._toJson.call(this,a);return d.items=this.items||c.items,d},e.prototype._fromJson=function(a,d){var e=this;return b.prototype._fromJson.call(this,a,d).then(function(){return e.by=a.by||c.by,e.created=a.created||c.created,e.modified=a.modified||c.modified,e.items=a.items||c.items,e.status=a.status||c.status,e.started=a.started||c.started,e.accepted=a.accepted||c.accepted,e.fromOrder=a.fromOrder||c.fromOrder,e.toOrder=a.toOrder||c.toOrder,e.startedBy=a.startedBy||c.startedBy,a})},e.prototype.addItems=function(a,b){return this._doApiCall({method:"addItems",params:{items:a},skipRead:b})},e.prototype.removeItems=function(a,b){return this._doApiCall({method:"removeItems",params:{items:a},skipRead:b})},e.prototype.start=function(a){return this._doApiCall({method:"start",params:{},skipRead:a})},e.prototype.undoStart=function(a){return this._doApiCall({method:"undoStart",params:{},skipRead:a})},e.prototype.accept=function(a,b){return this._doApiCall({method:"accept",params:a,skipRead:b})},e.prototype.getQRUrl=function(a){return this.ds._baseUrl+"/"+this.id+"/call/qr?size="+(a||300)},e}(a,L),ha=function(a){var b={id:null,name:"",color:"Gold",readonly:!1,selected:!1},c=function(c){c=c||{},this.raw=a.extend({},b,c),this.id=c.id||b.id,this.name=c.name||b.name,this.color=c.color||b.color,this.readonly=c.readonly||b.readonly,this.selected=c.selected||b.selected};return c.prototype.isDirty=function(){return this.raw.name!=this.name||this.raw.color!=this.color},c.prototype.isValid=function(){return this.name&&this.name.length>0},c.prototype._fromJson=function(c){return this.id=c.id||b.id,this.name=c.name||b.name,this.color=c.color||b.color,this.selected=c.selected||b.selected,this.readonly=c.readonly||b.readonly,a.Deferred().resolve()},c.prototype._toJson=function(){return{id:this.id,name:this.name,color:this.color,selected:this.selected,readonly:this.readonly}},c}(a),ia=function(a,b){var c={name:null,value:null,required:!1,unit:"",kind:"string",form:!1,editor:null,description:"",select:[]},d=function(a){a=a||{},this.raw=a,this.name=a.name||c.name,this.value=a.value||c.value,this.required=a.required||c.required,this.unit=a.unit||c.unit,this.kind=a.kind||c.kind,this.form=a.form||c.form,this.editor=a.editor||c.editor,this.description=a.description||c.description,this.select=a.select||c.select};return d.prototype.isValid=function(c){var d=a.trim(this.value);if(!this.required&&""==d)return!0;switch(this.kind){case"float":case"decimal":case"currency":return b.isNumeric(d);case"int":return b.isNumeric(d,!0);case"date":case"datetime":return b.isValidDate(d);case"string":case"select":return"phone"==this.editor?b.isValidPhone(d):"email"==this.editor?b.isValidEmail(d):"url"==this.editor?b.isValidURL(d):"number"==this.editor?b.isNumeric(d):""!=d;default:return!0}},d.prototype.isDirty=function(){return this.raw.value!=this.value},d.prototype.isEmpty=function(){return""==a.trim(this.value)},d}(a,z),ja=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){var B={};return B.api=a,B.common=x,B.Availability=b,B.Attachment=c,B.Base=d,B.Category=e,B.Comment=f,B.Conflict=g,B.Contact=h,B.DateHelper=i,B.Document=j,B.Group=k,B.Item=l,B.Kit=m,B.Location=n,B.Order=o,B.PermissionHandler=q,B.Reservation=r,B.Template=s,B.Transaction=t,B.User=u,B.UserSync=v,B.WebHook=w,B.OrderTransfer=y,B.Helper=p,B.ColorLabel=z,B.Field=A,B}(d,C,D,H,I,J,K,O,P,Q,R,S,T,U,Z,N,_,aa,ba,ca,da,ea,fa,z,ga,ha,ia)});