/*! core 2015-05-28 */
!function(a,b){"function"==typeof define&&define.amd?define(["jquery","jquery-jsonp","jquery-pubsub","moment"],b):a.cr=b($,jsonp,pubsub,moment)}(this,function(a,b,c,d){var e,f,g;return function(a){function b(a,b){return u.call(a,b)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(n=n.slice(0,n.length-1),a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function d(b,c){return function(){var d=v.call(arguments,0);return"string"!=typeof d[0]&&1===d.length&&d.push(null),n.apply(a,d.concat([b,c]))}}function h(a){return function(b){return c(b,a)}}function i(a){return function(b){q[a]=b}}function j(c){if(b(r,c)){var d=r[c];delete r[c],t[c]=!0,m.apply(a,d)}if(!b(q,c)&&!b(t,c))throw new Error("No "+c);return q[c]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var d,e=k(a),f=e[0];return a=e[1],f&&(f=c(f,b),d=j(f)),f?a=d&&d.normalize?d.normalize(a,h(b)):c(a,b):(a=c(a,b),e=k(a),f=e[0],a=e[1],f&&(d=j(f))),{f:f?f+"!"+a:a,n:a,pr:f,p:d}},p={require:function(a){return d(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(c,e,f,g){var h,k,l,m,n,s,u=[],v=typeof f;if(g=g||c,"undefined"===v||"function"===v){for(e=!e.length&&f.length?["require","exports","module"]:e,n=0;n<e.length;n+=1)if(m=o(e[n],g),k=m.f,"require"===k)u[n]=p.require(c);else if("exports"===k)u[n]=p.exports(c),s=!0;else if("module"===k)h=u[n]=p.module(c);else if(b(q,k)||b(r,k)||b(t,k))u[n]=j(k);else{if(!m.p)throw new Error(c+" missing "+k);m.p.load(m.n,d(g,!0),i(k),{}),u[n]=q[k]}l=f?f.apply(q[c],u):void 0,c&&(h&&h.exports!==a&&h.exports!==q[c]?q[c]=h.exports:l===a&&s||(q[c]=l))}else c&&(q[c]=f)},e=f=n=function(b,c,d,e,f){if("string"==typeof b)return p[b]?p[b](c):j(o(b,c).f);if(!b.splice){if(s=b,s.deps&&n(s.deps,s.callback),!c)return;c.splice?(b=c,c=d,d=null):b=a}return c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n},n.config=function(a){return n(a)},e._defined=q,g=function(a,c,d){c.splice||(d=c,c=[]),b(q,a)||b(r,a)||(r[a]=[a,c,d])},g.amd={jQuery:!0}}(),g("../../tests/js/lib/almond/almond",function(){}),g("common",[],function(){return String.prototype.startsWith=function(a){return 0==this.indexOf(a)},String.prototype.endsWith=function(a){return this.length<a.length?!1:this.lastIndexOf(a)==this.length-a.length},String.prototype.pluralize=function(a,b){return"is"==this&&1!=a?"are":this.endsWith("s")?(b=b||"es",1==a?this:this+b):this.endsWith("y")?(b=b||"ies",1==a?this:this.substr(0,this.length-1)+b):(b=b||"s",1==a?this:this+b)},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.truncate=function(a){a=null!=a?a:25;var b=this.match(RegExp("^.{0,"+a+"}[S]*")),c=b[0].length;return b=b[0].replace(/\s$/,""),c<this.length&&(b+="&hellip;"),b},{getUrlParam:function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.href);return d?decodeURIComponent(d[1].replace(/\+/g," ")):null}}}),g("dateHelper",["jquery","moment"],function(a,b){b.fn.toJSONDate=function(){return this.format("YYYY-MM-DDTHH:mm:ss.000[Z]")},b.fn.roundTo=function(a,c,d){a=b.normalizeUnits(a),c=c||1;var e=function(a){switch(d){case"up":a=Math.ceil(a/c);break;case"down":a=Math.floor(a/c);break;default:a=Math.round(a/c)}return a*c};switch(a){case"year":this.year(e(this.year()));break;case"month":this.month(e(this.month()));break;case"week":this.weekday(e(this.weekday()));break;case"isoWeek":this.isoWeekday(e(this.isoWeekday()));break;case"day":this.day(e(this.day()));break;case"hour":this.hour(e(this.hour()));break;case"minute":this.minute(e(this.minute()));break;case"second":this.second(e(this.second()));break;default:this.millisecond(e(this.millisecond()))}return this};var c=15,d=function(a){a=a||{},this.roundType=a.roundType||"nearest",this.roundMinutes=a.roundMinutes||c};return d.prototype.getNow=function(){return b()},d.prototype.getFriendlyDuration=function(a){return a.humanize()},d.prototype.fixDates=function(c){if("string"==typeof c||c instanceof String){if(c.endsWith("+00:00")){var d=c.length;if(25==d)return b(c.substring(0,d-6));if(32==d)return b(c.substring(0,d-6).split(".")[0])}}else if(c instanceof Object||a.isArray(c)){var e=this;a.each(c,function(a,b){c[a]=e.fixDates(b)})}return c},d.prototype.roundTimeFrom=function(a){return this.roundMinutes<=1?a:this.roundTime(a,this.roundMinutes,this._typeToDirection(this.roundType,"from"))},d.prototype.roundTimeTo=function(a){return this.roundMinutes<=1?a:this.roundTime(a,this.roundMinutes,this._typeToDirection(this.roundType,"to"))},d.prototype.roundTime=function(a,d,e){var f=b.isMoment(a)?a:b(a);return f.seconds(0).milliseconds(0),f.roundTo("minute",d||c,e)},d.prototype.roundTimeUp=function(a,d){var e=b.isMoment(a)?a:b(a);return e.seconds(0).milliseconds(0),e.roundTo("minute",d||c,"up")},d.prototype.roundTimeDown=function(a,d){var e=b.isMoment(a)?a:b(a);return e.seconds(0).milliseconds(0),e.roundTo("minute",d||c,"down")},d.prototype._typeToDirection=function(a,b){switch(a){case"longer":switch(b){case"from":return"down";case"to":return"up"}break;case"shorter":switch(b){case"from":return"up";case"to":return"down"}}},d}),g("api",["jquery","jquery-jsonp","moment","common","dateHelper"],function(a,b,c,d,e){var f={};return f.ApiNetworkNotConnected=function(a){this.code=999,this.message=a||"Connection interrupted"},f.ApiNetworkNotConnected.prototype=new Error,f.ApiNetworkTimeout=function(a){this.code=408,this.message=a||"Could not reach the server in time"},f.ApiNetworkTimeout.prototype=new Error,f.ApiError=function(a){this.code=500,this.message=a||"Something went wrong on the server"},f.ApiError.prototype=new Error,f.ApiNotFound=function(a){this.code=404,this.message=a||"Could not find what you're looking for"},f.ApiNotFound.prototype=new Error,f.ApiBadRequest=function(a){this.code=400,this.message=a||"The server did not understand your request"},f.ApiBadRequest.prototype=new Error,f.ApiUnauthorized=function(a){this.code=401,this.message=a||"Your session has expired"},f.ApiUnauthorized.prototype=new Error,f.ApiPaymentRequired=function(a){this.code=402,this.message=a||"Your subscription has expired"},f.ApiPaymentRequired.prototype=new Error,f.ApiForbidden=function(a){this.code=403,this.message=a||"You have insufficient rights"},f.ApiForbidden.prototype=new Error,f.ApiUnprocessableEntity=function(a){this.code=422,this.message=a||"Some data is invalid"},f.ApiUnprocessableEntity.prototype=new Error,f.ApiAjax=function(a){a=a||{},this.useJsonp=null!=a.useJsonp?a.useJsonp:!0,this.timeOut=a.timeOut||1e4,this.responseInTz=!0},f.ApiAjax.prototype.get=function(a,b){return this.useJsonp?this._getJsonp(a,b):this._getAjax(a,b)},f.ApiAjax.prototype.post=function(a,b,c){if(this.useJsonp)throw"ApiAjax cannot post while useJsonp is true";return this._postAjax(a,b,c)},f.ApiAjax.prototype._handleAjaxSuccess=function(a,b){return this.responseInTz&&(b=this._fixDates(b)),a.resolve(b)},f.ApiAjax.prototype._handleAjaxError=function(a,b,c,d){if("timeout"===d)a.reject(new f.ApiNetworkTimeout);else switch(b.status){case 400:a.reject(new f.ApiBadRequest);break;case 401:a.reject(new f.ApiUnauthorized);break;case 403:a.reject(new f.ApiForbidden);break;case 404:a.reject(new f.ApiNotFound);break;case 422:a.reject(new f.ApiUnprocessableEntity);break;case 500:default:a.reject(new f.ApiError)}},f.ApiAjax.prototype._postAjax=function(b,c,d){var e=a.Deferred(),f=this;return a.ajax({type:"POST",url:b,data:JSON.stringify(this._prepareDict(c)),contentType:"application/json; charset=utf-8",timeout:d||this.timeOut,success:function(a){return f._handleAjaxSuccess(e,a)},error:function(a,b,c){return f._handleAjaxError(e,a,b,c)}}),e.promise()},f.ApiAjax.prototype._getAjax=function(b,c){var d=a.Deferred(),e=this;return a.ajax({url:b,timeout:c||this.timeOut,success:function(a){return e._handleAjaxSuccess(d,a)},error:function(a,b,c){return e._handleAjaxError(d,a,b,c)}}),d.promise()},f.ApiAjax.prototype._getJsonp=function(b,c){var d=a.Deferred(),e=this;return a.jsonp({url:b,type:"GET",timeout:c||this.timeOut,dataType:" jsonp",callbackParameter:"callback",success:function(a,b,c){return e._handleAjaxSuccess(d,a)},error:function(a,b){d.reject(new f.ApiError)}}),d.promise()},f.ApiAjax.prototype._prepareDict=function(b){return a.each(b,function(a,d){c.isMoment(d)&&(b[a]=d.toJSONDate())}),b},f.ApiAjax.prototype._fixDates=function(b){if("string"==typeof b||b instanceof String){if(b.endsWith("+00:00")){var d=b.length;if(25==d)return c(b.substring(0,d-6));if(32==d)return c(b.substring(0,d-6).split(".")[0])}}else if(b instanceof Object||a.isArray(b)){var e=this;a.each(b,function(a,c){b[a]=e._fixDates(c)})}return b},f.ApiUser=function(a){a=a||{},this.userId=a.userId||"",this.userToken=a.userToken||"",this.tokenType=a.tokenType||""},f.ApiUser.prototype.fromStorage=function(){this.userId=window.localStorage.getItem("userId")||"",this.userToken=window.localStorage.getItem("userToken")||"",this.tokenType=window.localStorage.getItem("tokenType")||""},f.ApiUser.prototype.toStorage=function(){window.localStorage.setItem("userId",this.userId),window.localStorage.setItem("userToken",this.userToken),window.localStorage.setItem("tokenType",this.tokenType)},f.ApiUser.prototype.removeFromStorage=function(){window.localStorage.removeItem("userId"),window.localStorage.removeItem("userToken"),window.localStorage.removeItem("tokenType")},f.ApiUser.prototype.clearToken=function(){window.localStorage.setItem("userToken",null),window.localStorage.setItem("tokenType",null)},f.ApiUser.prototype.isValid=function(){return this.userId&&this.userId.length>0&&this.userToken&&this.userToken.length>0&&this.tokenType},f.ApiUser.prototype._reset=function(){this.userId="",this.userToken="",this.tokenType=""},f.ApiAuth=function(a){a=a||{},this.urlAuth=a.urlAuth||"",this.ajax=a.ajax},f.ApiAuth.prototype.authenticate=function(b,c){var d=this.urlAuth+"?"+a.param({user:b,password:c,auth_v:2}),e=a.Deferred();return this.ajax.get(d).done(function(a){"OK"==a.status?e.resolve(a.data):e.reject(new Error("Your username or password is not correct"))}).fail(function(a){e.reject(a)}),e.promise()},f.ApiAuthV2=function(a){a=a||{},this.urlAuth=a.urlAuth||"",this.ajax=a.ajax},f.ApiAuthV2.prototype.authenticate=function(b,c){var d=this.urlAuth+"?"+a.param({user:b,password:c,auth_v:2}),e=a.Deferred();return this.ajax.get(d).done(function(a){"OK"==a.status?e.resolve(a.data):e.reject(new Error("Your username or password is not correct"))}).fail(function(a){e.reject(a)}),e.promise()},f.ApiAnonymous=function(a){a=a||{},this.ajax=a.ajax,this.urlApi=a.urlApi||""},f.ApiAnonymous.prototype.call=function(b,c,d){var e=this.urlApi+"/"+b+"?"+a.param(this.ajax._prepareDict(c));return this.ajax.get(e,d)},f.ApiDataSource=function(a){a=a||{},this.collection=a.collection||"",this.urlApi=a.urlApi||"",this.user=a.user,this.ajax=a.ajax;var b=null!=this.user.tokenType&&this.user.tokenType.length>0?this.user.tokenType:"null";this._baseUrl=this.urlApi+"/"+this.user.userId+"/"+this.user.userToken+"/"+b+"/"+this.collection+"/"},f.ApiDataSource.prototype.exists=function(b,c){var d=a.Deferred(),e=this;return this.get(b,c).done(function(a){d.resolve(a)}).fail(function(a){e.ajax.useJsonp?d.resolve(null):a instanceof f.ApiNotFound?d.resolve(null):d.reject(a)}),d.promise()},f.ApiDataSource.prototype.get=function(b,c){var d=this.getBaseUrl()+b,e=this.getParamsDict(c);return a.isEmptyObject(e)||(d+="?"+this.getParams(e)),this.ajax.get(d)},f.ApiDataSource.prototype.getIgnore404=function(b,c){var d=this,e=a.Deferred();return this.get(b,c).done(function(a){e.resolve(a)}).fail(function(a){d.ajax.useJsonp?e.resolve(null):a instanceof f.ApiNotFound?e.resolve(null):e.reject(a)}),e.promise()},f.ApiDataSource.prototype.getMultiple=function(b,c){var d=this.getBaseUrl()+b.join(",")+",",e=this.getParamsDict(c);return a.isEmptyObject(e)||(d+="?"+this.getParams(e)),this.ajax.get(d)},f.ApiDataSource.prototype["delete"]=function(a){var b=this.getBaseUrl()+a+"/delete";return this.ajax.get(b)},f.ApiDataSource.prototype.update=function(b,c,d){var e=this.getBaseUrl()+b+"/update",f=a.extend({},c);return null!=d&&d.length>0&&(f._fields=a.isArray(d)?d.join(","):d),e+="?"+this.getParams(f),this.ajax.get(e)},f.ApiDataSource.prototype.create=function(b,c){var d=this.getBaseUrl()+"create",e=a.extend({},b);return null!=c&&c.length>0&&(e._fields=a.isArray(c)?c.join(","):c),d+="?"+this.getParams(e),this.ajax.get(d)},f.ApiDataSource.prototype.createMultiple=function(b,c){var d=a.Deferred(),e=this,f=b.slice(0),g=[],h=function(a){if(a.length>0){var b=a.pop();e.create(b,c).done(function(b){return g.push(b._id),h(a)}).fail(function(a){d.reject(a)})}else d.resolve(g)};return h(f),d.promise()},f.ApiDataSource.prototype.list=function(b,c,d,e,f){var g=this.getBaseUrl();null!=b&&b.length>0&&(g+="list/"+b+"/");var h=this.getParamsDict(c,d,e,f);return a.isEmptyObject(h)||(g+="?"+this.getParams(h)),this.ajax.get(g)},f.ApiDataSource.prototype.search=function(a,b,c,d,e,f){var g=this.searchUrl(a,b,c,d,e,f);return this.ajax.get(g)},f.ApiDataSource.prototype.searchUrl=function(b,c,d,e,f,g){var h=this.getBaseUrl()+"search",i=a.extend(this.getParamsDict(c,d,e,f),b);return null!=g&&g.length>0&&(i.mimeType=g),h+="?"+this.getParams(i)},f.ApiDataSource.prototype.call=function(b,c,d,e,f,g){var h=null!=b&&b.length>0?this.getBaseUrl()+b+"/call/"+c:this.getBaseUrl()+"call/"+c,i=a.extend({},this.getParamsDict(e,null,null,null),d);return g?this.ajax.post(h,i,f):(h+="?"+this.getParams(i),this.ajax.get(h,f))},f.ApiDataSource.prototype.getBaseUrl=function(){return this._baseUrl},f.ApiDataSource.prototype.getParams=function(b){return a.param(this.ajax._prepareDict(b))},f.ApiDataSource.prototype.getParamsDict=function(b,c,d,e){var f={};return b&&(f._fields=a.isArray(b)?b.join(","):b.replace(/\s/g,"")),c&&(f._limit=c),d&&(f._skip=d),e&&(f._sort=e),f},f}),g("document",["jquery","common","api"],function(a,b,c){var d={id:""},e=function(a){this.ds=a.ds,this.fields=a.fields,this.raw=null,this.id=a.id||d.id};return e.prototype.reset=function(){return this._fromJson(this._getDefaults(),null)},e.prototype.existsInDb=function(){return null!=this.id&&this.id.length>0},e.prototype.isEmpty=function(){return!0},e.prototype.isDirty=function(){return!1},e.prototype.isValid=function(){return!0},e.prototype.discardChanges=function(){return this.raw?this._fromJson(this.raw,null):this.reset()},e.prototype.reload=function(b){return this.existsInDb()?this.get(b):a.Deferred().reject(new c.ApiError("Cannot reload document, id is empty or null"))},e.prototype.get=function(b){if(this.existsInDb()){var d=this;return this.ds.get(this.id,b||this.fields).then(function(a){return d._fromJson(a)})}return a.Deferred().reject(new c.ApiError("Cannot get document, id is empty or null"))},e.prototype.create=function(b){if(this.existsInDb())return a.Deferred().reject(new Error("Cannot create document, already exists in database"));if(this.isEmpty())return a.Deferred().reject(new Error("Cannot create empty document"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot create, invalid document"));var c=this,d=this._toJson();return delete d.id,this.ds.create(d,this.fields).then(function(a){return 1==b?a:c._fromJson(a)})},e.prototype.update=function(b){if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot update document without id"));if(this.isEmpty())return a.Deferred().reject(new Error("Cannot update to empty document"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot update, invalid document"));var c=this,d=this._toJson();return delete d.id,this.ds.update(this.id,d,this.fields).then(function(a){return 1==b?a:c._fromJson(a)})},e.prototype["delete"]=function(){if(this.existsInDb()){var b=this;return this.ds["delete"](this.id).then(function(){return b.reset()})}return a.Deferred().reject(new Error("Document does not exist"))},e.prototype._getDefaults=function(){return d},e.prototype._toJson=function(a){return{id:this.id}},e.prototype._fromJson=function(b,c){return this.raw=b,this.id=b._id||d.id,a.Deferred().resolve(b)},e.prototype._doApiCall=function(a){var b=this;return this.ds.call(1==a.collectionCall?null:a.pk||this.id,a.method,a.params,a.fields||this.fields,a.timeOut,a.usePost).then(function(c){return 1==a.skipRead?c:b._fromJson(c)})},e}),g("Availability",["jquery","common","api","document"],function(a,b,c,d){var e={id:"",planning:"",item:"",from:null,to:null,order:"",reservation:""},f=function(){};f.prototype=d.prototype;var g=function(b){var c=a.extend({},b);d.call(this,c),this.planning=c.planning||e.planning,this.item=c.item||e.item,this.from=c.from||e.from,this.to=c.to||e.to,this.order=c.order||e.order,this.reservation=c.reservation||e.reservation};return g.prototype=new f,g.prototype.constructor=g,g.prototype._getDefaults=function(){return e},g.prototype.isEmpty=function(){return!1},g.prototype.canDelete=function(){return a.Deferred().resolve(!1)},g.prototype._toJson=function(a){var b=d.prototype._toJson.call(this,a);return b.planning=this.planning,b.item=this.item,b.fromDate=this.from,b.toDate=this.to,b.order=this.order,b.reservation=this.reservation,b},g.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.planning=a.planning||e.planning,c.item=a.item||e.item,c.from=a.fromDate||e.from,c.to=a.toDate||e.to,c.order=a.order||e.order,c.reservation=a.reservation||e.reservation,a})},g}),g("keyvalue",["jquery"],function(a){var b={id:"",pk:"",key:"",kind:"string",value:null,modified:null,by:null},c=function(a){this.ds=a.ds,this.fields=a.fields,this.raw=null,this.id=a.id||b.id,this.pk=a.pk||b.pk,this.key=a.key||b.key,this.kind=a.kind||b.kind,this.value=a.value||b.value,this.modified=a.modified||b.modified,this.by=a.by||b.by};return c.prototype.existsInDb=function(){return null!=this.id&&this.id.length>0},c.prototype.getName=function(){var a=this.key.split(";"),b=a[0];return b.split(".").pop().split("+").join(" ")},c.prototype.getUnit=function(){var a=this.key.split(";");return 2==a.length?a[1]:""},c.prototype.isEmpty=function(){return this.id==b.id&&this.pk==b.pk&&this.key==b.key&&this.kind==b.kind&&this.value==b.value&&this.modified==b.modified&&this.by==b.by},c.prototype.isDirty=function(){return!1},c.prototype.isValid=function(){return!0},c.prototype.reset=function(){return this._fromJson(b,null)},c.prototype._toJson=function(a){return{id:this.id,pk:this.pk,key:this.key,kind:this.kind,value:this.value,modified:this.modified,by:this.by}},c.prototype._fromJson=function(c,d){return this.raw=c,this.id=c.id||b.id,this.pk=c.pk||b.pk,this.key=c.key||b.key,this.kind=c.kind||b.kind,this.value=c.value||b.value,this.modified=c.modified||b.modified,this.by=c.by||b.by,a.Deferred().resolve(c)},c}),g("Attachment",["jquery","keyvalue"],function(a,b){var c=/(?:\.([^.]+))?$/,d=["jpg","png"],e=["jpg","png","doc","docx","pdf"],f={isCover:!1,canBeCover:!0},g=function(){};g.prototype=b.prototype;var h=function(a){b.call(this,a),this.isCover=null!=a.isCover?a.isCover:f.isCover,this.canBeCover=null!=a.canBeCover?a.canBeCover:f.canBeCover};return h.prototype=new g,h.prototype.constructor=h,h.prototype.getExt=function(a){return a=a||this.getName(),c.exec(a)[1]||""},h.prototype.isImage=function(){var b=this.getName(),c=this.getExt(b);return a.inArray(c,d)>=0},h.prototype.hasPreview=function(){var b=this.getName(),c=this.getExt(b);return a.inArray(c,e)>=0},h}),g("comment",["jquery","keyvalue"],function(a,b){var c=function(){};c.prototype=b.prototype;var d=function(a){b.call(this,a)};return d.prototype=new c,d.prototype.constructor=d,d}),g("attachment",["jquery","keyvalue"],function(a,b){var c=/(?:\.([^.]+))?$/,d=["jpg","png"],e=["jpg","png","doc","docx","pdf"],f={isCover:!1,canBeCover:!0},g=function(){};g.prototype=b.prototype;var h=function(a){b.call(this,a),this.isCover=null!=a.isCover?a.isCover:f.isCover,this.canBeCover=null!=a.canBeCover?a.canBeCover:f.canBeCover};return h.prototype=new g,h.prototype.constructor=h,h.prototype.getExt=function(a){return a=a||this.getName(),c.exec(a)[1]||""},h.prototype.isImage=function(){var b=this.getName(),c=this.getExt(b);return a.inArray(c,d)>=0},h.prototype.hasPreview=function(){var b=this.getName(),c=this.getExt(b);return a.inArray(c,e)>=0},h}),g("Base",["jquery","common","api","document","comment","attachment","keyvalue"],function(a,b,c,d,e,f,g){var h="cheqroom.Comment",i="cheqroom.Attachment",j="cheqroom.prop.Image",k="cheqroom.attachment.Image",l={id:"",modified:null,cover:null,comments:[],attachments:[],keyValues:[]},m=function(){};m.prototype=d.prototype;var n=function(b){var c=a.extend({},b);d.call(this,c),this.crtype=c.crtype,this.modified=c.modified||l.modified,this.comments=c.comments||l.comments.slice(),this.attachments=c.attachments||l.attachments.slice(),this.keyValues=c.keyValues||l.keyValues.slice(),this.cover=c.cover||l.cover};return n.prototype=new m,n.prototype.constructor=n,n.prototype._getDefaults=function(){return l},n.prototype.isEmpty=function(){return!(null!=this.comments&&0!=this.comments.length||null!=this.attachments&&0!=this.attachments.length||null!=this.keyValues&&0!=this.keyValues.length)},n.prototype.canDelete=function(){return this.existsInDb()?this.ds.call(this.id,"canDelete").then(function(a){return a.result}):a.Deferred().resolve(!1)},n.prototype.addComment=function(a,b){return this.addKeyValue(h,a,"string",b)},n.prototype.updateComment=function(a,b,c){return this.updateKeyValue(a,h,b,"string",c)},n.prototype.deleteComment=function(a,b){return this.removeKeyValue(a,b)},n.prototype.addKeyValue=function(a,b,c,d){return this._doApiCall({method:"addKeyValue",params:{key:a,value:b,kind:c},skipRead:d})},n.prototype.updateKeyValue=function(a,b,c,d,e){return this._doApiCall({method:"updateKeyValue",params:{id:a,key:b,value:c,kind:d},skipRead:e})},n.prototype.removeKeyValue=function(a,b){return this._doApiCall({method:"removeKeyValue",params:{id:a},skipRead:b})},n.prototype.setKeyValue=function(a,b,c,d,e){var f={key:b,value:c,kind:d};return null!=a&&a.length>0&&(f.id=a),this._doApiCall({method:"setKeyValue",params:f,skipRead:e})},n.prototype.getImageUrl=function(a,b,c,d){var e=c||this.cover;return null!=e&&e.length>0?this.helper.getImageCDNUrl(b,e,a):this.helper.getImageUrl(this.ds,this.id,a,d)},n.prototype.setCover=function(a,b){return this._doApiCall({method:"setCover",params:{kvId:a.id},skipRead:b})},n.prototype.attachImage=function(a,b){return this.attach(a,j,b)},n.prototype.attachFile=function(a,b){return this.attach(a,i,b)},n.prototype.attach=function(b,d,e){return this.existsInDb()?this._doApiCall({method:"attach",params:{attachments:[b._id],key:d},skipRead:e}):a.Deferred().reject(new c.ApiError("Cannot attach attachment, id is empty or null"))},n.prototype.detach=function(b,d){return this.existsInDb()?this._doApiCall({method:"detach",params:{attachments:[b],kvId:b},skipRead:d}):a.Deferred().reject(new c.ApiError("Cannot detach attachment, id is empty or null"))},n.prototype._toJson=function(a){return d.prototype._toJson.call(this,a)},n.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.modified=a.modified||l.modified,c._fromKeyValuesJson(a,b)})},n.prototype._fromKeyValuesJson=function(b,c){var d=null,e=this;if(this.comments=l.comments.slice(),this.attachments=l.attachments.slice(),this.keyValues=l.keyValues.slice(),this.cover=b.cover||l.cover,b.keyValues&&b.keyValues.length){var f=b.keyValues.sort(function(a,b){return b.modified>a.modified});a.each(f,function(a,b){switch(b.key){case h:d=e._getComment(b,c),d&&(e.comments=e.comments||[],e.comments.push(d));break;case j:case i:case k:d=e._getAttachment(b,c),d&&(e.attachments=e.attachments||[],e.attachments.push(d));break;default:d=e._getKeyValue(b,c),d&&(e.keyValues=e.keyValues||[],e.keyValues.push(d))}})}return a.Deferred().resolve(b)},n.prototype._getComment=function(b,c){var d=a.extend({ds:this.ds,fields:this.fields},c||{},b);return new e(d)},n.prototype._getAttachment=function(b,c){var d=a.extend({ds:this.ds,fields:this.fields},c||{},b);return new f(d)},n.prototype._getKeyValue=function(b,c){var d=a.extend({ds:this.ds,fields:this.fields},c||{},b);return new g(d)},n}),g("Comment",["jquery","keyvalue"],function(a,b){var c=function(){};c.prototype=b.prototype;var d=function(a){b.call(this,a)};return d.prototype=new c,d.prototype.constructor=d,d}),g("base",["jquery","common","api","document","comment","attachment","keyvalue"],function(a,b,c,d,e,f,g){var h="cheqroom.Comment",i="cheqroom.Attachment",j="cheqroom.prop.Image",k="cheqroom.attachment.Image",l={id:"",modified:null,cover:null,comments:[],attachments:[],keyValues:[]},m=function(){};m.prototype=d.prototype;var n=function(b){var c=a.extend({},b);d.call(this,c),this.crtype=c.crtype,this.modified=c.modified||l.modified,this.comments=c.comments||l.comments.slice(),this.attachments=c.attachments||l.attachments.slice(),this.keyValues=c.keyValues||l.keyValues.slice(),this.cover=c.cover||l.cover};return n.prototype=new m,n.prototype.constructor=n,n.prototype._getDefaults=function(){return l},n.prototype.isEmpty=function(){return!(null!=this.comments&&0!=this.comments.length||null!=this.attachments&&0!=this.attachments.length||null!=this.keyValues&&0!=this.keyValues.length)},n.prototype.canDelete=function(){return this.existsInDb()?this.ds.call(this.id,"canDelete").then(function(a){return a.result}):a.Deferred().resolve(!1)},n.prototype.addComment=function(a,b){return this.addKeyValue(h,a,"string",b)},n.prototype.updateComment=function(a,b,c){return this.updateKeyValue(a,h,b,"string",c)},n.prototype.deleteComment=function(a,b){return this.removeKeyValue(a,b)},n.prototype.addKeyValue=function(a,b,c,d){return this._doApiCall({method:"addKeyValue",params:{key:a,value:b,kind:c},skipRead:d})},n.prototype.updateKeyValue=function(a,b,c,d,e){return this._doApiCall({method:"updateKeyValue",params:{id:a,key:b,value:c,kind:d},skipRead:e})},n.prototype.removeKeyValue=function(a,b){return this._doApiCall({method:"removeKeyValue",params:{id:a},skipRead:b})},n.prototype.setKeyValue=function(a,b,c,d,e){var f={key:b,value:c,kind:d};return null!=a&&a.length>0&&(f.id=a),this._doApiCall({method:"setKeyValue",params:f,skipRead:e})},n.prototype.getImageUrl=function(a,b,c,d){var e=c||this.cover;return null!=e&&e.length>0?this.helper.getImageCDNUrl(b,e,a):this.helper.getImageUrl(this.ds,this.id,a,d)},n.prototype.setCover=function(a,b){return this._doApiCall({method:"setCover",params:{kvId:a.id},skipRead:b})},n.prototype.attachImage=function(a,b){return this.attach(a,j,b)},n.prototype.attachFile=function(a,b){return this.attach(a,i,b)},n.prototype.attach=function(b,d,e){return this.existsInDb()?this._doApiCall({method:"attach",params:{attachments:[b._id],key:d},skipRead:e}):a.Deferred().reject(new c.ApiError("Cannot attach attachment, id is empty or null"))},n.prototype.detach=function(b,d){return this.existsInDb()?this._doApiCall({method:"detach",params:{attachments:[b],kvId:b},skipRead:d}):a.Deferred().reject(new c.ApiError("Cannot detach attachment, id is empty or null"))},n.prototype._toJson=function(a){return d.prototype._toJson.call(this,a)},n.prototype._fromJson=function(a,b){var c=this;return d.prototype._fromJson.call(this,a,b).then(function(){return c.modified=a.modified||l.modified,c._fromKeyValuesJson(a,b)})},n.prototype._fromKeyValuesJson=function(b,c){var d=null,e=this;if(this.comments=l.comments.slice(),this.attachments=l.attachments.slice(),this.keyValues=l.keyValues.slice(),this.cover=b.cover||l.cover,b.keyValues&&b.keyValues.length){var f=b.keyValues.sort(function(a,b){return b.modified>a.modified});a.each(f,function(a,b){switch(b.key){case h:d=e._getComment(b,c),d&&(e.comments=e.comments||[],e.comments.push(d));break;case j:case i:case k:d=e._getAttachment(b,c),d&&(e.attachments=e.attachments||[],e.attachments.push(d));break;default:d=e._getKeyValue(b,c),d&&(e.keyValues=e.keyValues||[],e.keyValues.push(d))}})}return a.Deferred().resolve(b)},n.prototype._getComment=function(b,c){var d=a.extend({ds:this.ds,fields:this.fields},c||{},b);return new e(d)},n.prototype._getAttachment=function(b,c){var d=a.extend({ds:this.ds,fields:this.fields},c||{},b);return new f(d)},n.prototype._getKeyValue=function(b,c){var d=a.extend({ds:this.ds,fields:this.fields},c||{},b);return new g(d)},n}),g("Contact",["jquery","base"],function(a,b){var c={name:"",company:"",phone:"",email:""},d=function(){};d.prototype=b.prototype;var e=function(d){var e=a.extend({fields:["*"],crtype:"cheqroom.types.customer"},d);b.call(this,e),this.name=e.name||c.name,this.company=e.company||c.company,this.phone=e.phone||c.phone,this.email=e.email||c.email};return e.prototype=new d,e.prototype.constructor=e,e.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},e.prototype.isValidCompany=function(){return this.company=a.trim(this.company),this.company.length>=3},e.prototype.isValidPhone=function(){this.phone=a.trim(this.phone);var b=/^\d{9,}$/.test(this.phone);if(b)return!0;var c=this.phone.match(/^[\s()+-]*([0-9][\s()+-]*){10,20}(( x| ext)\d{1,5}){0,1}$/);return null!=c&&c.length>0},e.prototype.isValidEmail=function(){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return this.email=a.trim(this.email),b.test(this.email)},e.prototype.isValid=function(){return this.isValidName()&&this.isValidCompany()&&this.isValidPhone()&&this.isValidEmail()},e.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==c.name&&this.company==c.company&&this.phone==c.phone&&this.email==c.email},e.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);return!a&&this.raw&&(a=this.name!=this.raw.name||this.company!=this.raw.company||this.phone!=this.raw.phone||this.email!=this.raw.email),a},e.prototype._getDefaults=function(){return c},e.prototype._toJson=function(a){var d=b.prototype._toJson.call(this,a);return d.name=this.name||c.name,d.company=this.company||c.company,d.phone=this.phone||c.phone,d.email=this.email||c.email,d},e.prototype._fromJson=function(d,e){var f=this;return b.prototype._fromJson.call(this,d,e).then(function(b){return f.name=b.name||c.name,f.company=b.company||c.company,f.phone=b.phone||c.phone,f.email=b.email||c.email,a.publish("contact.fromJson",b),b})},e}),g("DateHelper",["jquery","moment"],function(a,b){b.fn.toJSONDate=function(){return this.format("YYYY-MM-DDTHH:mm:ss.000[Z]")},b.fn.roundTo=function(a,c,d){a=b.normalizeUnits(a),c=c||1;var e=function(a){switch(d){case"up":a=Math.ceil(a/c);break;case"down":a=Math.floor(a/c);break;default:a=Math.round(a/c)}return a*c};switch(a){case"year":this.year(e(this.year()));break;case"month":this.month(e(this.month()));break;case"week":this.weekday(e(this.weekday()));break;case"isoWeek":this.isoWeekday(e(this.isoWeekday()));break;case"day":this.day(e(this.day()));break;case"hour":this.hour(e(this.hour()));break;case"minute":this.minute(e(this.minute()));break;case"second":this.second(e(this.second()));break;default:this.millisecond(e(this.millisecond()))}return this};var c=15,d=function(a){a=a||{},this.roundType=a.roundType||"nearest",
this.roundMinutes=a.roundMinutes||c};return d.prototype.getNow=function(){return b()},d.prototype.getFriendlyDuration=function(a){return a.humanize()},d.prototype.fixDates=function(c){if("string"==typeof c||c instanceof String){if(c.endsWith("+00:00")){var d=c.length;if(25==d)return b(c.substring(0,d-6));if(32==d)return b(c.substring(0,d-6).split(".")[0])}}else if(c instanceof Object||a.isArray(c)){var e=this;a.each(c,function(a,b){c[a]=e.fixDates(b)})}return c},d.prototype.roundTimeFrom=function(a){return this.roundMinutes<=1?a:this.roundTime(a,this.roundMinutes,this._typeToDirection(this.roundType,"from"))},d.prototype.roundTimeTo=function(a){return this.roundMinutes<=1?a:this.roundTime(a,this.roundMinutes,this._typeToDirection(this.roundType,"to"))},d.prototype.roundTime=function(a,d,e){var f=b.isMoment(a)?a:b(a);return f.seconds(0).milliseconds(0),f.roundTo("minute",d||c,e)},d.prototype.roundTimeUp=function(a,d){var e=b.isMoment(a)?a:b(a);return e.seconds(0).milliseconds(0),e.roundTo("minute",d||c,"up")},d.prototype.roundTimeDown=function(a,d){var e=b.isMoment(a)?a:b(a);return e.seconds(0).milliseconds(0),e.roundTo("minute",d||c,"down")},d.prototype._typeToDirection=function(a,b){switch(a){case"longer":switch(b){case"from":return"down";case"to":return"up"}break;case"shorter":switch(b){case"from":return"up";case"to":return"down"}}},d}),g("Document",["jquery","common","api"],function(a,b,c){var d={id:""},e=function(a){this.ds=a.ds,this.fields=a.fields,this.raw=null,this.id=a.id||d.id};return e.prototype.reset=function(){return this._fromJson(this._getDefaults(),null)},e.prototype.existsInDb=function(){return null!=this.id&&this.id.length>0},e.prototype.isEmpty=function(){return!0},e.prototype.isDirty=function(){return!1},e.prototype.isValid=function(){return!0},e.prototype.discardChanges=function(){return this.raw?this._fromJson(this.raw,null):this.reset()},e.prototype.reload=function(b){return this.existsInDb()?this.get(b):a.Deferred().reject(new c.ApiError("Cannot reload document, id is empty or null"))},e.prototype.get=function(b){if(this.existsInDb()){var d=this;return this.ds.get(this.id,b||this.fields).then(function(a){return d._fromJson(a)})}return a.Deferred().reject(new c.ApiError("Cannot get document, id is empty or null"))},e.prototype.create=function(b){if(this.existsInDb())return a.Deferred().reject(new Error("Cannot create document, already exists in database"));if(this.isEmpty())return a.Deferred().reject(new Error("Cannot create empty document"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot create, invalid document"));var c=this,d=this._toJson();return delete d.id,this.ds.create(d,this.fields).then(function(a){return 1==b?a:c._fromJson(a)})},e.prototype.update=function(b){if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot update document without id"));if(this.isEmpty())return a.Deferred().reject(new Error("Cannot update to empty document"));if(!this.isValid())return a.Deferred().reject(new Error("Cannot update, invalid document"));var c=this,d=this._toJson();return delete d.id,this.ds.update(this.id,d,this.fields).then(function(a){return 1==b?a:c._fromJson(a)})},e.prototype["delete"]=function(){if(this.existsInDb()){var b=this;return this.ds["delete"](this.id).then(function(){return b.reset()})}return a.Deferred().reject(new Error("Document does not exist"))},e.prototype._getDefaults=function(){return d},e.prototype._toJson=function(a){return{id:this.id}},e.prototype._fromJson=function(b,c){return this.raw=b,this.id=b._id||d.id,a.Deferred().resolve(b)},e.prototype._doApiCall=function(a){var b=this;return this.ds.call(1==a.collectionCall?null:a.pk||this.id,a.method,a.params,a.fields||this.fields,a.timeOut,a.usePost).then(function(c){return 1==a.skipRead?c:b._fromJson(c)})},e}),g("Item",["jquery","base"],function(a,b){var c="cheqroom.prop.Custom",d=0,e=0,f={name:"",status:"",codes:[],flag:"",location:"",category:"",geo:[d,e],address:"",order:null},g=function(){};g.prototype=b.prototype;var h=function(c){var d=a.extend({fields:["*"],crtype:"cheqroom.types.item"},c);b.call(this,d),this.name=d.name||f.name,this.status=d.status||f.status,this.codes=d.codes||f.codes,this.flag=d.flag||f.flag,this.location=d.location||f.location,this.category=d.category||f.category,this.geo=d.geo||f.geo.slice(),this.address=d.address||f.address,this.order=d.order||f.order};return h.prototype=new g,h.prototype.constructor=h,h.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=3},h.prototype.isValidCategory=function(){return a.trim(this.category).length>0},h.prototype.isValidLocation=function(){return a.trim(this.location).length>0},h.prototype.isValid=function(){return this.isValidName()&&this.isValidCategory()&&this.isValidLocation()},h.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==f.name&&this.status==f.status&&0==this.codes.length&&this.flag==f.flag&&this.location==f.location&&this.category==f.category},h.prototype.isDirty=function(){return b.prototype.isDirty.call(this)||this._isDirtyName()||this._isDirtyCategory()||this._isDirtyLocation()||this._isDirtyFlag()||this._isDirtyGeo()},h.prototype._getDefaults=function(){return f},h.prototype._toJson=function(a){var c=b.prototype._toJson.call(this,a);return c.name=this.name||f.name,c.category=this.category||f.category,c.location=this.location||f.location,c},h.prototype._fromJson=function(c,d){var e=this;return b.prototype._fromJson.call(this,c,d).then(function(){e.name=c.name||f.name,e.status=c.status||f.status,e.codes=c.codes||f.codes,e.address=c.address||f.address,e.geo=c.geo||f.geo.slice();var b=f.location;c.location&&(b=c.location._id?c.location._id:c.location),e.location=b;var g=f.category;c.category&&(g=c.category._id?c.category._id:c.category),e.category=g;var h=f.order;return c.order&&(h=c.order._id?c.order._id:c.order),e.order=h,e._fromJsonFlag(c,d).then(function(){return a.publish("item.fromJson",c),c})})},h.prototype._fromJsonFlag=function(b,d){var e=this;return this.flag=f.flag,null!=b.keyValues&&b.keyValues.length>0&&a.each(b.keyValues,function(a,b){return b.key==c?(e.flag=b.value,!1):void 0}),a.Deferred().resolve(b)},h.prototype._getKeyValue=function(a,d){return a.key==c?null:b.prototype._getKeyValue(a,d)},h.prototype._isDirtyName=function(){return this.raw?this.name!=this.raw.name:!1},h.prototype._isDirtyLocation=function(){if(this.raw){var a=f.location;return this.raw.location&&(a=this.raw.location._id?this.raw.location._id:this.raw.location),this.location!=a}return!1},h.prototype._isDirtyCategory=function(){if(this.raw){var a=f.category;return this.raw.category&&(a=this.raw.category._id?this.raw.category._id:this.raw.category),this.category!=a}return!1},h.prototype._isDirtyFlag=function(){if(this.raw){var b=f.flag;return this.raw.keyValues&&this.raw.keyValues.length&&a.each(this.raw.keyValues,function(a,d){return d.key==c?(b=d.value,!1):void 0}),this.flag!=b}return!1},h.prototype._isDirtyGeo=function(){if(this.raw){var a=this.raw.address||f.address,b=this.raw.geo||f.geo.slice();return this.address!=a||this.geo[0]!=b[0]||this.geo[1]!=b[1]}return!1},h.prototype.getAvailabilities=function(a,b){return this.ds.call(this.id,"getAvailability",{fromDate:a,toDate:b})},h.prototype.duplicate=function(a){return this._doApiCall({method:"duplicate",params:{times:a},skipRead:!0})},h.prototype.expire=function(a){return this._doApiCall({method:"expire",skipRead:a})},h.prototype.undoExpire=function(a){return this._doApiCall({method:"undoExpire",skipRead:a})},h.prototype.changeLocation=function(a,b){return this._doApiCall({method:"changeLocation",params:{location:a},skipRead:b})},h.prototype.addCode=function(a,b){return this._doApiCall({method:"addCodes",params:{codes:[a]},skipRead:b})},h.prototype.removeCode=function(a,b){return this._doApiCall({method:"removeCodes",params:{codes:[a]},skipRead:b})},h.prototype.updateGeo=function(a,b,c,d){return this._doApiCall({method:"updateGeo",params:{lat:a,lng:b,address:c},skipRead:d})},h.prototype.updateName=function(a,b){var c=this;return this.ds.update(this.id,{name:a},this.fields).then(function(a){return 1==b?a:c._fromJson(a)})},h.prototype.canChangeCategory=function(a){return this._doApiCall({collectionCall:!0,method:"canChangeCategory",params:{pks:[this.id],category:a},skipRead:!0})},h.prototype.changeCategory=function(a,b){var c=this;return this._doApiCall({collectionCall:!0,method:"changeCategory",params:{pks:[this.id],category:a},skipRead:!0}).then(function(a){return 1==b?a:c._fromJson(a[0])})},h.prototype.setFlag=function(a,b){return this.setKeyValue(null,c,a,"string",b)},h}),g("KeyValue",["jquery"],function(a){var b={id:"",pk:"",key:"",kind:"string",value:null,modified:null,by:null},c=function(a){this.ds=a.ds,this.fields=a.fields,this.raw=null,this.id=a.id||b.id,this.pk=a.pk||b.pk,this.key=a.key||b.key,this.kind=a.kind||b.kind,this.value=a.value||b.value,this.modified=a.modified||b.modified,this.by=a.by||b.by};return c.prototype.existsInDb=function(){return null!=this.id&&this.id.length>0},c.prototype.getName=function(){var a=this.key.split(";"),b=a[0];return b.split(".").pop().split("+").join(" ")},c.prototype.getUnit=function(){var a=this.key.split(";");return 2==a.length?a[1]:""},c.prototype.isEmpty=function(){return this.id==b.id&&this.pk==b.pk&&this.key==b.key&&this.kind==b.kind&&this.value==b.value&&this.modified==b.modified&&this.by==b.by},c.prototype.isDirty=function(){return!1},c.prototype.isValid=function(){return!0},c.prototype.reset=function(){return this._fromJson(b,null)},c.prototype._toJson=function(a){return{id:this.id,pk:this.pk,key:this.key,kind:this.kind,value:this.value,modified:this.modified,by:this.by}},c.prototype._fromJson=function(c,d){return this.raw=c,this.id=c.id||b.id,this.pk=c.pk||b.pk,this.key=c.key||b.key,this.kind=c.kind||b.kind,this.value=c.value||b.value,this.modified=c.modified||b.modified,this.by=c.by||b.by,a.Deferred().resolve(c)},c}),g("Location",["jquery","base"],function(a,b){var c={name:"",address:""},d=function(){};d.prototype=b.prototype;var e=function(d){var e=a.extend({fields:["*"]},d);b.call(this,e),this.name=e.name||c.name,this.address=e.address||c.address};return e.prototype=new d,e.prototype.constructor=e,e.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==c.name&&this.address==c.address},e.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);if(!a&&this.raw){var d=this.raw.name||c.name,e=this.raw.address||c.address;return this.name!=d||this.address!=e}return a},e.prototype._getDefaults=function(){return c},e.prototype._toJson=function(a){var d=b.prototype._toJson.call(this,a);return d.name=this.name||c.name,d.address=this.address||c.address,d},e.prototype._fromJson=function(d,e){var f=this;return b.prototype._fromJson.call(this,d,e).then(function(){return f.name=d.name||c.name,f.address=d.address||c.address,a.publish("contact.fromJson",d),d})},e}),g("transaction",["jquery","api","base","Location"],function(a,b,c,d){var e={status:"creating",from:null,to:null,due:null,contact:"",location:"",items:[]},f=function(){};f.prototype=c.prototype;var g=function(b){var d=a.extend({},b);c.call(this,d),this.dsItems=d.dsItems,this.autoCleanup=null!=d.autoCleanup?d.autoCleanup:!1,this.helper=d.helper,this.status=d.status||e.status,this.from=d.from||e.from,this.to=d.to||e.to,this.due=d.due||e.due,this.contact=d.contact||e.contact,this.location=d.location||e.location,this.items=d.items||e.items.slice()};return g.prototype=new f,g.prototype.constructor=d,g.prototype.getMinDate=function(){var a=this._getHelper(),b=a.getNow();return b},g.prototype.getMaxDate=function(){var a=this._getHelper(),b=a.getNow(),c=a.roundTimeTo(b);return c.add(365,"day")},g.prototype.suggestEndDate=function(a){var b=this._getHelper(),c=b.addAverageDuration(a||b.getNow());return b.roundTimeTo(c)},g.prototype.isEmpty=function(){return c.prototype.isEmpty.call(this)&&this.status==e.status&&this.from==e.from&&this.to==e.to&&this.due==e.due&&this.contact==e.contact&&this.location==e.location&&0==this.items.length},g.prototype.isDirty=function(){return c.prototype.isDirty.call(this)||this._isDirtyBasic()||this._isDirtyDates()||this._isDirtyLocation()||this._isDirtyContact()||this._isDirtyItems()},g.prototype._isDirtyBasic=function(){if(this.raw){var a=this.raw.status||e.status;return this.status!=a}return!1},g.prototype._isDirtyDates=function(){if(this.raw){var a=this.raw.from||e.from,b=this.raw.to||e.to,c=this.raw.due||e.due;return this.from!=a||this.to!=b||this.due!=c}return!1},g.prototype._isDirtyLocation=function(){if(this.raw){var a=e.location;return this.raw.location&&(a=this.raw.location._id?this.raw.location._id:this.raw.location),this.location!=a}return!1},g.prototype._isDirtyContact=function(){if(this.raw){var a=e.contact;return this.raw.customer&&(a=this.raw.customer._id?this.raw.customer._id:this.raw.customer),this.contact!=a}return!1},g.prototype._isDirtyItems=function(){if(this.raw){{e.items.slice()}return this.raw.items,!1}return!1},g.prototype._getDefaults=function(){return e},g.prototype._toJson=function(a){var b=c.prototype._toJson.call(this,a);return b.due=this.due,this.location&&(b.location=this.location),this.contact&&(b.customer=this.contact),b},g.prototype._fromJson=function(a,b){var d=this;return c.prototype._fromJson.call(this,a,b).then(function(){d.status=a.status||e.status,d.location=a.location||e.location,d.contact=a.customer||e.contact,d.items=a.items||e.items.slice()})},g.prototype._toLog=function(a){var b=this._toJson(a);b.minDate=this.getMinDate().toJSONDate(),b.maxDate=this.getMaxDate().toJSONDate()},g.prototype.clearFromDate=function(a){return this.from=e.from,this._handleTransaction(a)},g.prototype.setFromDate=function(a,b){return this.from=this.helper.roundTimeFrom(a),this._handleTransaction(b)},g.prototype.clearToDate=function(a){return this.to=e.to,this._handleTransaction(a)},g.prototype.setToDate=function(a,b){return this.to=this.helper.roundTimeTo(a),this._handleTransaction(b)},g.prototype.clearDueDate=function(a){return this.due=e.due,this._handleTransaction(a)},g.prototype.setDueDate=function(a,b){return this.due=this.helper.roundTimeTo(a),this._handleTransaction(b)},g.prototype.setLocation=function(a,b){return this.location=a,this.existsInDb()?this._doApiCall({method:"setLocation",params:{location:a},skipRead:b}):this._createTransaction(b)},g.prototype.clearLocation=function(a){var b=this;return this.location=e.location,this._doApiCall({method:"clearLocation",skipRead:a}).then(function(){return b._ensureTransactionDeleted()})},g.prototype.setContact=function(a,b){return this.contact=a,this.existsInDb()?this._doApiCall({method:"setCustomer",params:{customer:a},skipRead:b}):this._createTransaction(b)},g.prototype.clearContact=function(a){var b=this;return this.contact=e.contact,this._doApiCall({method:"clearCustomer",skipRead:a}).then(function(){return b._ensureTransactionDeleted()})},g.prototype.addItems=function(a,b){var c=this;return this._ensureTransactionExists(b).then(function(){return c._doApiCall({method:"addItems",params:{items:a},skipRead:b})})},g.prototype.removeItems=function(b,c){if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot removeItems from document without id"));var d=this;return this._doApiCall({method:"removeItems",params:{items:b},skipRead:c}).then(function(){return d._ensureTransactionDeleted()})},g.prototype.clearItems=function(b){if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot clearItems from document without id"));var c=this;return this._doApiCall({method:"clearItems",skipRead:b}).then(function(){return c._ensureTransactionDeleted()})},g.prototype.swapItem=function(b,c,d){return this.existsInDb()?this._doApiCall({method:"swapItem",params:{fromItem:b,toItem:c},skipRead:d}):a.Deferred().reject(new Error("Cannot clearItems from document without id"))},g.prototype._getHelper=function(){return this.helper},g.prototype._getDateHelper=function(){return this._getHelper().dateHelper},g.prototype._searchItems=function(c,d,e,f,g){return null==this.dsItems?a.Deferred().reject(new b.ApiBadRequest(this.crtype+" has no DataSource for items")):(c=c||{},c.location=this.location,null!=d&&d.length>0&&(c.listName=d),1==e?(c.onlyUnbooked=null!=f?f:!0,c.fromDate=this.from,c.toDate=this.to,c._limit=20,c._skip=0,g&&g.length&&(c.skipItems=g),this.dsItems.call(null,"searchAvailable",c)):(g&&g.length&&(c.pk__nin=g),this.dsItems.search(c)))},g.prototype._checkDateBetweenMinMax=function(c){var d=this.getMinDate(),e=this.getMaxDate();if(d>c||c>e){var f="date is outside of min max range "+d.toJSONDate()+"->"+e.toJSONDate();return a.Deferred().reject(new b.ApiUnprocessableEntity(f))}return a.Deferred().resolve(c)},g.prototype._handleTransaction=function(b){var c=this.isEmpty();return this.existsInDb()?c?this.autoCleanup?this._deleteTransaction():a.Deferred().resolve():this._updateTransaction(b):c?a.Deferred().resolve():this._createTransaction(b)},g.prototype._deleteTransaction=function(){return this["delete"]()},g.prototype._updateTransaction=function(a){return this.update(a)},g.prototype._createTransaction=function(a){return this.create(a)},g.prototype._ensureTransactionExists=function(b){return this.existsInDb()?a.Deferred().resolve():this._createTransaction(b)},g.prototype._ensureTransactionDeleted=function(){return this.isEmpty()&&this.autoCleanup?this._deleteTransaction():a.Deferred().resolve()},g}),g("Order",["jquery","api","transaction"],function(a,b,c){var e=function(){};e.prototype=c.prototype;var f=function(b){var d=a.extend({crtype:"cheqroom.types.order",fields:["*"]},b);c.call(this,d)};return f.prototype=new e,f.prototype.constructor=f,f.prototype.getMinDate=function(){var a=this._getHelper(),b=a.getNow(),c=a.roundTimeFrom(b);return c},f.prototype._toJson=function(a){var b=c.prototype._toJson.call(this,a);return b.fromDate=null!=this.fromDate?this.fromDate.toJSONDate():"null",b.toDate=null!=this.toDate?this.toDate.toJSONDate():"null",b},f.prototype._fromJson=function(b,d){var e=this;return c.prototype._fromJson.call(this,b,d).then(function(){return e.from=null==b.started||"null"==b.started?null:b.started,e.to=null==b.finished||"null"==b.finished?null:b.finished,e.due=null==b.due||"null"==b.due?null:b.due,a.publish("order.fromJson",b),b})},f.prototype.getFriendlyDuration=function(){var a=this.getDuration();return null!=a?this._getDateHelper().getFriendlyDuration(a):""},f.prototype.getDuration=function(){if(null!=this.from){var a="closed"==this.status?this.to:this.due;if(a)return d.duration(a-this.from)}return null},f.prototype.canGenerateAgreement=function(){return"open"==this.status||"closed"==this.status},f.prototype.canCheckin=function(){return"open"==this.status},f.prototype.canCheckout=function(){return"creating"==this.status&&this.location&&this.contact&&this.due&&this.items&&this.items.length},f.prototype.canUndoCheckout=function(){return"open"==this.status},f.prototype.setFromDueDate=function(c,d,e){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order from / due date, status is "+this.status));var f=this,g=this._getHelper().roundTimeFrom(c),h=d?this._getHelper().roundTimeTo(d):this._getHelper().addAverageDuration(g);return this._checkFromDueDate(g,h).then(function(){return f.from=g,f.due=h,f._handleTransaction(e)})},f.prototype.setFromDate=function(c,d){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order from date, status is "+this.status));var e=this,f=this._getHelper().roundTimeFrom(c);return this._checkFromDueDate(f,this.due).then(function(){return e.from=f,e._handleTransaction(d)})},f.prototype.clearFromDate=function(c){return"creating"!=this.status?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot clear order from date, status is "+this.status)):(this.from=null,this._handleTransaction(c))},f.prototype.setDueDate=function(c,d){if("creating"!=this.status&&"open"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order due date, status is "+this.status));var e=this,f=this._getHelper().roundTimeTo(c);return this._checkFromDueDate(this.from,f).then(function(){return e.due=f,e._handleTransaction(d)})},f.prototype.clearDueDate=function(c){return"creating"!=this.status?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot clear order due date, status is "+this.status)):(this.due=null,this._handleTransaction(c))},f.prototype.setToDate=function(a,b){throw"Order.setToDate not implemented, it is set during order close"},f.prototype.clearToDate=function(a,b){throw"Order.clearToDate not implemented, it is set during order close"},f.prototype.searchItems=function(a,b,c,d){return this._searchItems(a,"available",b,c,d||this.items)},f.prototype.checkin=function(a,b){return this._doApiCall({method:"checkin",params:{items:a},skipRead:b})},f.prototype.checkout=function(a){return this._doApiCall({method:"checkout",skipRead:a})},f.prototype.undoCheckout=function(a){return this._doApiCall({method:"undoCheckout",skipRead:a})},f.prototype.generateAgreement=function(a){return this._doApiCall({method:"generateAgreement",skipRead:a})},f.prototype._checkFromDueDate=function(c,d){var e=this._getDateHelper(),f=c,g=d;return f&&g?a.when(this._checkDateBetweenMinMax(f),this._checkDateBetweenMinMax(g)).then(function(c,d){var h=e.roundMinutes;return g.diff(f,"minutes")<h?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order from date, after (or too close to) to date "+g.toJSONDate())):f.diff(g,"minutes")>h?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order due date, before (or too close to) from date "+f.toJSONDate())):void 0}):f?this._checkDateBetweenMinMax(f):g?this._checkDateBetweenMinMax(g):a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot from/due date, both are null"))},f}),g("settings",[],function(){return{cdn:"https://cheqroom-cdn.s3.amazonaws.com",amazonBucket:"app"}}),g("helper",["jquery","moment","dateHelper","settings"],function(a,b,c,d){var e=function(a){this.dateHelper=new c({})};return e.prototype.getNow=function(){return this.dateHelper.getNow()},e.prototype.roundTimeFrom=function(a){return this.dateHelper.roundTimeFrom(a)},e.prototype.roundTimeTo=function(a){return this.dateHelper.roundTimeTo(a)},e.prototype.addAverageDuration=function(a){return a.clone().add(1,"day")},e.prototype.getImageCDNUrl=function(a,b,c){var e=d.cdn+"/"+d.amazonBucket+"/groups/"+a+"/"+b;if(c&&c.length>0){{var f=e.split(".");f.pop()}e=f.join(".")+"-"+c+".jpg"}return e},e.prototype.getImageUrl=function(a,b,c,d){var e=a.getBaseUrl()+b+"?mimeType=image/jpeg";return c&&(e+="&size="+c),d&&(e+="&_bust="+(new Date).getTime()),e},e}),g("Reservation",["jquery","api","transaction"],function(a,b,c){var d=function(){};d.prototype=c.prototype;var e=function(b){var d=a.extend({crtype:"cheqroom.types.reservation",fields:["*"]},b);c.call(this,d),this.conflicts=[]};return e.prototype=new d,e.prototype.constructor=e,e.prototype.getMinDate=function(){var a=this._getDateHelper(),b=a.getNow(),c=a.roundTimeUp(b,a.roundMinutes);return c==b&&(c=c.add(a.roundMinutes,"minutes")),c},e.prototype.canReserve=function(){return"creating"==this.status&&this.location&&this.contact&&this.from&&this.to&&this.items&&this.items.length},e.prototype.canCancel=function(){return"open"==this.status},e.prototype.canEdit=function(){return"creating"==this.status},e.prototype.canDelete=function(){return"creating"==this.status},e.prototype.canMakeOrder=function(){if("open"==this.status){var b=this._getUnavailableItems(),c=a.map(b,function(a,b){return b}).length;return 0==c}return!1},e.prototype._toJson=function(a){var b=c.prototype._toJson.call(this,a);return b.fromDate=null!=this.from?this.from.toJSONDate():"null",b.toDate=null!=this.to?this.to.toJSONDate():"null",b},e.prototype._fromJson=function(b,d){var e=this;return c.prototype._fromJson.call(this,b,d).then(function(){return e.existsInDb()?e._loadConflicts(b,d).then(function(){e.from=null==b.fromDate||"null"==b.fromDate?null:b.fromDate,e.to=null==b.toDate||"null"==b.toDate?null:b.toDate,e.due=null,a.publish("reservation.fromJson",b)}):(e.from=null==b.fromDate||"null"==b.fromDate?null:b.fromDate,e.to=null==b.toDate||"null"==b.toDate?null:b.toDate,e.due=null,a.publish("reservation.fromJson",b),void 0)})},e.prototype.setFromToDate=function(c,d,e){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation from / to date, status is "+this.status));var f=this,g=this._getHelper().roundTimeFrom(c),h=d?this._getHelper().roundTimeTo(d):this._getHelper().addAverageDuration(g);return this._checkFromToDate(g,h).then(function(){return f.from=g,f.to=h,f._handleTransaction(e)})},e.prototype.setFromDate=function(c,d){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation from date, status is "+this.status));var e=this,f=this._getDateHelper(),g=f.roundMinutes,h=this._getHelper().roundTimeFrom(c);return this._checkDateBetweenMinMax(h).then(function(){return e.to&&e.to.diff(h,"minutes")<g?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation from date, after (or too close to) to date "+e.to.toJSONDate())):(e.from=h,e._handleTransaction(d))})},e.prototype.clearFromDate=function(c){return"creating"!=this.status?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot clear reservation from date, status is "+this.status)):(this.from=null,this._handleTransaction(c))},e.prototype.setToDate=function(c,d){if("creating"!=this.status)return a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation to date, status is "+this.status));var e=this,f=this._getDateHelper(),g=f.roundMinutes,h=this._getHelper().roundTimeTo(c);return this._checkDateBetweenMinMax(h).then(function(){return e.from&&e.from.diff(h,"minutes")>g?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set reservation to date, before (or too close to) to date "+e.from.toJSONDate())):(e.to=h,e._handleTransaction(d))})},e.prototype.clearToDate=function(c){return"creating"!=this.status?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot clear reservation to date, status is "+this.status)):(this.to=null,this._handleTransaction(c))},e.prototype.clearDueDate=function(a){throw"Reservation.clearDueDate not implemented"},e.prototype.setDueDate=function(a,b){throw"Reservation.setDueDate not implemented"},e.prototype.searchItems=function(a,b,c,d){return this._searchItems(a,null,!0,c,d||this.items)},e.prototype.reserve=function(a){return this._doApiCall({method:"reserve",skipRead:a})},e.prototype.undoReserve=function(a){return this._doApiCall({method:"undoReserve",skipRead:a})},e.prototype.cancel=function(a){return this._doApiCall({method:"cancel",skipRead:a})},e.prototype.makeOrder=function(){return this._doApiCall({method:"makeOrder",skipRead:!0})},e.prototype._checkFromToDate=function(c,d){var e=this._getDateHelper(),f=c,g=d;return f&&g?a.when(this._checkDateBetweenMinMax(f),this._checkDateBetweenMinMax(g)).then(function(c,d){var h=e.roundMinutes;return g.diff(f,"minutes")<h?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order from date, after (or too close to) to date "+g.toJSONDate())):f.diff(g,"minutes")>h?a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot set order due date, before (or too close to) from date "+f.toJSONDate())):void 0}):f?this._checkDateBetweenMinMax(f):g?this._checkDateBetweenMinMax(g):a.Deferred().reject(new b.ApiUnprocessableEntity("Cannot from/due date, both are null"))},e.prototype._getUnavailableItems=function(){var b={};return"open"==this.status&&this.location&&null!=this.items&&this.items.length>0&&a.each(this.items,function(a,c){"available"!=c.status?(b.status=b.status||[],b.status.push(c._id)):c.location!=location._id&&(b.location=b.location||[],b.location.push(c._id))}),b},e.prototype._loadConflicts=function(b,c){var d=this,e=null!=this.location,f=null!=this.from||null!=this.to,g=null!=this.items&&this.items.length>0,h="creating"!=this.status&&"open"!=this.status;return h||!e&&!f&&!g?(this.conflicts=[],a.Deferred().resolve(b)):"creating"==this.status?this.ds.call(this.id,"getConflicts").then(function(a){d.conflicts=a||[]}):"open"==this.status?(this.conflicts=[],a.each(this.raw.items,function(a,b){"expired"==b.status?d.conflicts.push({item:b._id?b._id:b,kind:"status",friendlyKind:"Item is expired"}):"available"!=b.status?d.conflicts.push({item:b._id?b._id:b,kind:"status",friendlyKind:"Item is checked out in an order"}):b.location!=d.location&&d.conflicts.push({item:b._id?b._id:b,kind:"location",friendlyKind:"Item is at wrong location"})}),a.Deferred().resolve(b)):(this.conflicts=[],a.Deferred().resolve(b))},e}),g("Transaction",["jquery","api","base","Location"],function(a,b,c,d){var e={status:"creating",from:null,to:null,due:null,contact:"",location:"",items:[]},f=function(){};f.prototype=c.prototype;var g=function(b){var d=a.extend({},b);c.call(this,d),this.dsItems=d.dsItems,this.autoCleanup=null!=d.autoCleanup?d.autoCleanup:!1,this.helper=d.helper,this.status=d.status||e.status,this.from=d.from||e.from,this.to=d.to||e.to,this.due=d.due||e.due,this.contact=d.contact||e.contact,this.location=d.location||e.location,this.items=d.items||e.items.slice()};return g.prototype=new f,g.prototype.constructor=d,g.prototype.getMinDate=function(){var a=this._getHelper(),b=a.getNow();return b},g.prototype.getMaxDate=function(){var a=this._getHelper(),b=a.getNow(),c=a.roundTimeTo(b);return c.add(365,"day")},g.prototype.suggestEndDate=function(a){var b=this._getHelper(),c=b.addAverageDuration(a||b.getNow());return b.roundTimeTo(c)},g.prototype.isEmpty=function(){return c.prototype.isEmpty.call(this)&&this.status==e.status&&this.from==e.from&&this.to==e.to&&this.due==e.due&&this.contact==e.contact&&this.location==e.location&&0==this.items.length},g.prototype.isDirty=function(){return c.prototype.isDirty.call(this)||this._isDirtyBasic()||this._isDirtyDates()||this._isDirtyLocation()||this._isDirtyContact()||this._isDirtyItems()},g.prototype._isDirtyBasic=function(){if(this.raw){var a=this.raw.status||e.status;return this.status!=a}return!1},g.prototype._isDirtyDates=function(){if(this.raw){var a=this.raw.from||e.from,b=this.raw.to||e.to,c=this.raw.due||e.due;return this.from!=a||this.to!=b||this.due!=c}return!1},g.prototype._isDirtyLocation=function(){if(this.raw){var a=e.location;return this.raw.location&&(a=this.raw.location._id?this.raw.location._id:this.raw.location),this.location!=a}return!1},g.prototype._isDirtyContact=function(){if(this.raw){var a=e.contact;return this.raw.customer&&(a=this.raw.customer._id?this.raw.customer._id:this.raw.customer),this.contact!=a}return!1},g.prototype._isDirtyItems=function(){if(this.raw){{e.items.slice()}return this.raw.items,!1}return!1},g.prototype._getDefaults=function(){return e},g.prototype._toJson=function(a){var b=c.prototype._toJson.call(this,a);return b.due=this.due,this.location&&(b.location=this.location),this.contact&&(b.customer=this.contact),b},g.prototype._fromJson=function(a,b){var d=this;return c.prototype._fromJson.call(this,a,b).then(function(){d.status=a.status||e.status,d.location=a.location||e.location,d.contact=a.customer||e.contact,d.items=a.items||e.items.slice()})},g.prototype._toLog=function(a){var b=this._toJson(a);b.minDate=this.getMinDate().toJSONDate(),b.maxDate=this.getMaxDate().toJSONDate()},g.prototype.clearFromDate=function(a){return this.from=e.from,this._handleTransaction(a)},g.prototype.setFromDate=function(a,b){return this.from=this.helper.roundTimeFrom(a),this._handleTransaction(b)},g.prototype.clearToDate=function(a){return this.to=e.to,this._handleTransaction(a)},g.prototype.setToDate=function(a,b){return this.to=this.helper.roundTimeTo(a),this._handleTransaction(b)},g.prototype.clearDueDate=function(a){return this.due=e.due,this._handleTransaction(a)},g.prototype.setDueDate=function(a,b){return this.due=this.helper.roundTimeTo(a),this._handleTransaction(b);

},g.prototype.setLocation=function(a,b){return this.location=a,this.existsInDb()?this._doApiCall({method:"setLocation",params:{location:a},skipRead:b}):this._createTransaction(b)},g.prototype.clearLocation=function(a){var b=this;return this.location=e.location,this._doApiCall({method:"clearLocation",skipRead:a}).then(function(){return b._ensureTransactionDeleted()})},g.prototype.setContact=function(a,b){return this.contact=a,this.existsInDb()?this._doApiCall({method:"setCustomer",params:{customer:a},skipRead:b}):this._createTransaction(b)},g.prototype.clearContact=function(a){var b=this;return this.contact=e.contact,this._doApiCall({method:"clearCustomer",skipRead:a}).then(function(){return b._ensureTransactionDeleted()})},g.prototype.addItems=function(a,b){var c=this;return this._ensureTransactionExists(b).then(function(){return c._doApiCall({method:"addItems",params:{items:a},skipRead:b})})},g.prototype.removeItems=function(b,c){if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot removeItems from document without id"));var d=this;return this._doApiCall({method:"removeItems",params:{items:b},skipRead:c}).then(function(){return d._ensureTransactionDeleted()})},g.prototype.clearItems=function(b){if(!this.existsInDb())return a.Deferred().reject(new Error("Cannot clearItems from document without id"));var c=this;return this._doApiCall({method:"clearItems",skipRead:b}).then(function(){return c._ensureTransactionDeleted()})},g.prototype.swapItem=function(b,c,d){return this.existsInDb()?this._doApiCall({method:"swapItem",params:{fromItem:b,toItem:c},skipRead:d}):a.Deferred().reject(new Error("Cannot clearItems from document without id"))},g.prototype._getHelper=function(){return this.helper},g.prototype._getDateHelper=function(){return this._getHelper().dateHelper},g.prototype._searchItems=function(c,d,e,f,g){return null==this.dsItems?a.Deferred().reject(new b.ApiBadRequest(this.crtype+" has no DataSource for items")):(c=c||{},c.location=this.location,null!=d&&d.length>0&&(c.listName=d),1==e?(c.onlyUnbooked=null!=f?f:!0,c.fromDate=this.from,c.toDate=this.to,c._limit=20,c._skip=0,g&&g.length&&(c.skipItems=g),this.dsItems.call(null,"searchAvailable",c)):(g&&g.length&&(c.pk__nin=g),this.dsItems.search(c)))},g.prototype._checkDateBetweenMinMax=function(c){var d=this.getMinDate(),e=this.getMaxDate();if(d>c||c>e){var f="date is outside of min max range "+d.toJSONDate()+"->"+e.toJSONDate();return a.Deferred().reject(new b.ApiUnprocessableEntity(f))}return a.Deferred().resolve(c)},g.prototype._handleTransaction=function(b){var c=this.isEmpty();return this.existsInDb()?c?this.autoCleanup?this._deleteTransaction():a.Deferred().resolve():this._updateTransaction(b):c?a.Deferred().resolve():this._createTransaction(b)},g.prototype._deleteTransaction=function(){return this["delete"]()},g.prototype._updateTransaction=function(a){return this.update(a)},g.prototype._createTransaction=function(a){return this.create(a)},g.prototype._ensureTransactionExists=function(b){return this.existsInDb()?a.Deferred().resolve():this._createTransaction(b)},g.prototype._ensureTransactionDeleted=function(){return this.isEmpty()&&this.autoCleanup?this._deleteTransaction():a.Deferred().resolve()},g}),g("User",["jquery","base"],function(a,b){var c={name:"",email:"",group:"",picture:"",role:"user",active:!0},d=function(){};d.prototype=b.prototype;var e=function(d){var e=a.extend({fields:["*","group","picture"]},d);b.call(this,e),this.helper=e.helper,this.name=e.name||c.name,this.picture=e.picture||c.picture,this.email=e.email||c.email,this.role=e.role||c.role,this.active=null!=e.active?e.active:c.active};return e.prototype=new d,e.prototype.constructor=e,e.prototype.isValidName=function(){return this.name=a.trim(this.name),this.name.length>=4},e.prototype.isValidEmail=function(){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return this.email=a.trim(this.email),b.test(this.email)},e.prototype.isValidRole=function(){switch(this.role){case"user":case"admin":case"root":return!0;default:return!1}},e.prototype.isValidPassword=function(){this.password=a.trim(this.password);var b=this.password.length,c=this.password.match(/[0-9]/);return b>=4&&c},e.prototype.isValid=function(){return this.isValidName()&&this.isValidEmail()&&this.isValidRole()},e.prototype.isEmpty=function(){return b.prototype.isEmpty.call(this)&&this.name==c.name&&this.email==c.email&&this.role==c.role},e.prototype.isDirty=function(){var a=b.prototype.isDirty.call(this);if(!a&&this.raw){var d=this.raw.name||c.name,e=this.raw.role||c.role,f=this.raw.email||c.email,g=null!=this.raw.active?this.raw.active:c.active;return this.name!=d||this.email!=f||this.role!=e||this.active!=g}return a},e.prototype.getImageUrl=function(a,b){return null!=this.picture&&this.picture.length>0?this.helper.getImageCDNUrl(this.group,this.picture,a,b):this.helper.getImageUrl(this.ds,this.id,a,b)},e.prototype._getDefaults=function(){return c},e.prototype.addKeyValue=function(b,c,d,e){return a.Deferred().reject("Not implemented for User, use setPicture instead?")},e.prototype.addKeyValue=function(b,c,d,e,f){return a.Deferred().reject("Not implemented for User, use setPicture instead?")},e.prototype.removeKeyValue=function(b,c){return a.Deferred().reject("Not implemented for User, use clearPicture instead?")},e.prototype.setPicture=function(b,c){return this.existsInDb()?(this.picture=b,this._doApiCall({method:"setPicture",params:{attachment:b},skipRead:c})):a.Deferred().reject("User does not exist in database")},e.prototype.clearPicture=function(b){return this.existsInDb()?this._doApiCall({method:"clearPicture",skipRead:b}):a.Deferred().reject("User does not exist in database")},e.prototype._toJson=function(a){var d=b.prototype._toJson.call(this,a);return d.name=this.name||c.name,d.email=this.email||c.email,d.group=this.group||c.group,d.role=this.role||c.role,d.active=this.active||c.active,d},e.prototype._fromJson=function(d,e){var f=this;return b.prototype._fromJson.call(this,d,e).then(function(){return f.group=d.group&&null!=d.group._id?d.group._id:d.group||c.group,f.name=d.name||c.name,f.picture=d.picture||c.picture,f.email=d.email||c.email,f.role=d.role||c.role,f.active=null!=d.active?d.active:c.active,a.publish("user.fromJson",d),d})},e}),g("../main",["api","Availability","Attachment","Base","Comment","common","Contact","DateHelper","Document","Item","KeyValue","Location","Order","helper","Reservation","Transaction","User"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r={};return r.api=a,r.Availability=b,r.Attachment=c,r.Base=d,r.Comment=e,r.Contact=g,r.DateHelper=h,r.Document=i,r.Helper=n,r.Item=j,r.KeyValue=k,r.Location=l,r.Order=m,r.Reservation=o,r.Transaction=p,r.User=q,r}),g("jquery",function(){return a}),g("jquery-jsonp",function(){return b}),g("jquery-pubsub",function(){return c}),g("moment",function(){return d}),f("../main")});