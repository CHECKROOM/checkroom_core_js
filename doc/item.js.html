<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: item.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"CHEQROOM","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">CHEQROOM</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="Base">
            <span class="title">
                <a href="Base.html">Base</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Base#_doApiCall"><a href="Base.html#_doApiCall">_doApiCall</a></li>
            
                <li data-name="Base#_fromJson"><a href="Base.html#_fromJson">_fromJson</a></li>
            
                <li data-name="Base#_toJson"><a href="Base.html#_toJson">_toJson</a></li>
            
                <li data-name="Base#create"><a href="Base.html#create">create</a></li>
            
                <li data-name="Base#delete"><a href="Base.html#delete">delete</a></li>
            
                <li data-name="Base#discardChanges"><a href="Base.html#discardChanges">discardChanges</a></li>
            
                <li data-name="Base#existsInDb"><a href="Base.html#existsInDb">existsInDb</a></li>
            
                <li data-name="Base#get"><a href="Base.html#get">get</a></li>
            
                <li data-name="Base#isDirty"><a href="Base.html#isDirty">isDirty</a></li>
            
                <li data-name="Base#isEmpty"><a href="Base.html#isEmpty">isEmpty</a></li>
            
                <li data-name="Base#isValid"><a href="Base.html#isValid">isValid</a></li>
            
                <li data-name="Base#reload"><a href="Base.html#reload">reload</a></li>
            
                <li data-name="Base#reset"><a href="Base.html#reset">reset</a></li>
            
                <li data-name="Base#update"><a href="Base.html#update">update</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Contact">
            <span class="title">
                <a href="Contact.html">Contact</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Contact#_doApiCall"><a href="Contact.html#_doApiCall">_doApiCall</a></li>
            
                <li data-name="Contact#_fromJson"><a href="Contact.html#_fromJson">_fromJson</a></li>
            
                <li data-name="Contact#_toJson"><a href="Contact.html#_toJson">_toJson</a></li>
            
                <li data-name="Contact#create"><a href="Contact.html#create">create</a></li>
            
                <li data-name="Contact#delete"><a href="Contact.html#delete">delete</a></li>
            
                <li data-name="Contact#discardChanges"><a href="Contact.html#discardChanges">discardChanges</a></li>
            
                <li data-name="Contact#existsInDb"><a href="Contact.html#existsInDb">existsInDb</a></li>
            
                <li data-name="Contact#get"><a href="Contact.html#get">get</a></li>
            
                <li data-name="Contact#isDirty"><a href="Contact.html#isDirty">isDirty</a></li>
            
                <li data-name="Contact#isEmpty"><a href="Contact.html#isEmpty">isEmpty</a></li>
            
                <li data-name="Contact#isValid"><a href="Contact.html#isValid">isValid</a></li>
            
                <li data-name="Contact#isValidCompany"><a href="Contact.html#isValidCompany">isValidCompany</a></li>
            
                <li data-name="Contact#isValidEmail"><a href="Contact.html#isValidEmail">isValidEmail</a></li>
            
                <li data-name="Contact#isValidName"><a href="Contact.html#isValidName">isValidName</a></li>
            
                <li data-name="Contact#isValidPhone"><a href="Contact.html#isValidPhone">isValidPhone</a></li>
            
                <li data-name="Contact#reload"><a href="Contact.html#reload">reload</a></li>
            
                <li data-name="Contact#reset"><a href="Contact.html#reset">reset</a></li>
            
                <li data-name="Contact#update"><a href="Contact.html#update">update</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Document">
            <span class="title">
                <a href="Document.html">Document</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Document#_doApiCall"><a href="Document.html#_doApiCall">_doApiCall</a></li>
            
                <li data-name="Document#_fromJson"><a href="Document.html#_fromJson">_fromJson</a></li>
            
                <li data-name="Document#_toJson"><a href="Document.html#_toJson">_toJson</a></li>
            
                <li data-name="Document#create"><a href="Document.html#create">create</a></li>
            
                <li data-name="Document#delete"><a href="Document.html#delete">delete</a></li>
            
                <li data-name="Document#discardChanges"><a href="Document.html#discardChanges">discardChanges</a></li>
            
                <li data-name="Document#existsInDb"><a href="Document.html#existsInDb">existsInDb</a></li>
            
                <li data-name="Document#get"><a href="Document.html#get">get</a></li>
            
                <li data-name="Document#isDirty"><a href="Document.html#isDirty">isDirty</a></li>
            
                <li data-name="Document#isEmpty"><a href="Document.html#isEmpty">isEmpty</a></li>
            
                <li data-name="Document#isValid"><a href="Document.html#isValid">isValid</a></li>
            
                <li data-name="Document#reload"><a href="Document.html#reload">reload</a></li>
            
                <li data-name="Document#reset"><a href="Document.html#reset">reset</a></li>
            
                <li data-name="Document#update"><a href="Document.html#update">update</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="KeyValue">
            <span class="title">
                <a href="KeyValue.html">KeyValue</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="KeyValue#_fromJson"><a href="KeyValue.html#_fromJson">_fromJson</a></li>
            
                <li data-name="KeyValue#_toJson"><a href="KeyValue.html#_toJson">_toJson</a></li>
            
                <li data-name="KeyValue#existsInDb"><a href="KeyValue.html#existsInDb">existsInDb</a></li>
            
                <li data-name="KeyValue#getName"><a href="KeyValue.html#getName">getName</a></li>
            
                <li data-name="KeyValue#getUnit"><a href="KeyValue.html#getUnit">getUnit</a></li>
            
                <li data-name="KeyValue#isDirty"><a href="KeyValue.html#isDirty">isDirty</a></li>
            
                <li data-name="KeyValue#isEmpty"><a href="KeyValue.html#isEmpty">isEmpty</a></li>
            
                <li data-name="KeyValue#isValid"><a href="KeyValue.html#isValid">isValid</a></li>
            
                <li data-name="KeyValue#reset"><a href="KeyValue.html#reset">reset</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="item.js.html">Source: item.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>/**
 * The Item module
 * @module item
 * @copyright CHECKROOM NV 2015
 */
define([
    'jquery',
    'base'], function ($, Base) {

    var FLAG = "cheqroom.prop.Custom",
        DEFAULT_LAT = 0.0,
        DEFAULT_LONG = 0.0,
        DEFAULTS = {
        name: "",
        status: "",
        codes: [],
        flag: "",
        location: "",
        category: "",
        geo: [DEFAULT_LAT,DEFAULT_LONG],
        address: ""
    };
    
    // Allow overriding the ctor during inheritance
    // http://stackoverflow.com/questions/4152931/javascript-inheritance-call-super-constructor-or-use-prototype-chain
    var tmp = function() {};
    tmp.prototype = Base.prototype;

    /**
     * @class Item
     * @constructor
     * @extends Base
     */
    var Item = function(opt) {
        var spec = $.extend({
            fields: ['*'],
            crtype: 'cheqroom.types.item'
        }, opt);
        Base.call(this, spec);

        this.name = spec.name || DEFAULTS.name;
        this.status = spec.status || DEFAULTS.status;
        this.codes = spec.codes || DEFAULTS.codes;
        this.flag = spec.flag || DEFAULTS.flag;
        this.location = spec.location || DEFAULTS.location;     // location._id
        this.category = spec.category || DEFAULTS.category;     // category._id
        this.geo = spec.geo || DEFAULTS.geo.slice();            // null or an array with 2 floats
        this.address = spec.address || DEFAULTS.address;
    };

    Item.prototype = new tmp();
    Item.prototype.constructor = Item;

    //
    // Base overrides
    //

    /**
     * Checks if the item is empty
     * @returns {boolean}
     */
    Item.prototype.isEmpty = function() {
        // Checks for: name, status, codes, flag, location, category
        return (
            (Base.prototype.isEmpty.call(this)) &&
            (this.name==DEFAULTS.name) &&
            (this.status==DEFAULTS.status) &&
            (this.codes.length==0) &&  // not DEFAULTS.codes? :)
            (this.flag==DEFAULTS.flag) &&
            (this.location==DEFAULTS.location) &&
            (this.category==DEFAULTS.category));
    };

    /**
     * Checks if the item is dirty and needs saving
     * @returns {boolean}
     */
    Item.prototype.isDirty = function() {
        return (
            Base.prototype.isDirty.call(this) || 
            this._isDirtyName() ||
            this._isDirtyCategory() ||
            this._isDirtyLocation() ||
            this._isDirtyFlag() ||
            this._isDirtyGeo());
    };

    Item.prototype._getDefaults = function() {
        return DEFAULTS;
    };

    Item.prototype._toJson = function(options) {
        // Writes out; id, name, category, location
        var data = Base.prototype._toJson.call(this, options);
        data.name = this.name || DEFAULTS.name;
        data.category = this.category || DEFAULTS.category;
        data.location = this.location || DEFAULTS.location;
        return data;
    };

    Item.prototype._fromJson = function(data, options) {
        var that = this;
        return Base.prototype._fromJson.call(this, data, options)
            .then(function() {
                that.name = data.name || DEFAULTS.name;
                that.status = data.status || DEFAULTS.status;
                that.codes = data.codes || DEFAULTS.codes;
                that.address = data.address || DEFAULTS.address;
                that.geo = data.geo || DEFAULTS.geo.slice();

                // Depending on the fields we'll need to get the _id directly or from the dicts
                var locId = DEFAULTS.location;
                if (data.location) {
                    locId = (data.location._id) ? data.location._id : data.location;
                }
                that.location = locId;

                var catId = DEFAULTS.category;
                if (data.category) {
                    catId = (data.category._id) ? data.category._id : data.category;
                }
                that.category = catId;

                // Read the flag from the keyvalues
                return that._fromJsonFlag(data, options)
                    .then(function() {
                        $.publish('item.fromJson', data);
                        return data;
                    });
            });
    };

    Item.prototype._fromJsonFlag = function(data, options) {
        var that = this;
        this.flag = DEFAULTS.flag;

        if( (data.keyValues!=null) &&
            (data.keyValues.length>0)) {
            $.each(data.keyValues, function(i, kv) {
                 if (kv.key == FLAG) {
                     that.flag = kv.value;
                     return false;
                 }
            });
        }

        return $.Deferred().resolve(data);
    };

    Item.prototype._getKeyValue = function(kv, options) {
        // Flag is a special keyvalue, we won't read it into keyValues
        // but set it via _fromJsonFlag
        return (kv.key == FLAG) ? null : Base.prototype._getKeyValue(kv, options);
    };

    Item.prototype._isDirtyName = function() {
        if (this.raw) {
            return (this.name!=this.raw.name);
        } else {
            return false;
        }
    };

    Item.prototype._isDirtyLocation = function() {
        if (this.raw) {
            var locId = DEFAULTS.location;
            if (this.raw.location) {
                locId = (this.raw.location._id) ? this.raw.location._id : this.raw.location;
            }
            return (this.location!=locId);
        } else {
            return false;
        }
    };

    Item.prototype._isDirtyCategory = function() {
        if (this.raw) {
            var catId = DEFAULTS.category;
            if (this.raw.category) {
                catId = (this.raw.category._id) ? this.raw.category._id : this.raw.category;
            }
            return (this.category!=catId);
        } else {
            return false;
        }
    };

    Item.prototype._isDirtyFlag = function() {
        if (this.raw) {
            var flag = DEFAULTS.flag;
            if( (this.raw.keyValues) &&
                (this.raw.keyValues.length)) {
                $.each(this.raw.keyValues, function(i, kv) {
                     if (kv.key == FLAG) {
                         flag = kv.value;
                         return false;
                     }
                });
            }
            return (this.flag!=flag);
        } else {
            return false;
        }
    };

    Item.prototype._isDirtyGeo = function() {
        if (this.raw) {
            var address = this.raw.address || DEFAULTS.address;
            var geo = this.raw.geo || DEFAULTS.geo.slice();
            return (
                (this.address!=address) ||
                (this.geo[0]!=geo[0]) ||
                (this.geo[1]!=geo[1]));
        } else {
            return false;
        }
    };

    //
    // Business logic
    //
//
//    /**
//     * updates the Item
//     * We override because Item.update does not support updating categories
//     * @param skipRead
//     * @returns {*}
//     */
//    Item.prototype.update = function(skipRead) {
//        if (this.isEmpty()) {
//            return $.Deferred().reject(new Error("Cannot update to empty document"));
//        }
//        if (!this.existsInDb()) {
//            return $.Deferred().reject(new Error("Cannot update document without id"));
//        }
//        if (!this.isValid()) {
//            return $.Deferred().reject(new Error("Cannot update, invalid document"));
//        }
//
//        var that = this;
//        this.isBusy(true);
//        var pk = this.id;
//        var data = this._toJson();
//
//        // Category is not allowed during update
//        delete data.category;
//
//        return this.ds.update(pk, data, this.fields)
//            .then(function(data) {
//                return (skipRead==true) ? data : that._fromJson(data);
//            }).always(function() {
//                that.isBusy(false);
//            });
//    };
//
//    /**
//     * save
//     */
//    Item.prototype.save = function() {
//        // Works for: name, location, category, flag & geo
//
//        // Avoid doing saves if we try to change a category and it's not allowed
//        var isDirtyCategory = this._isDirtyCategory();
//        var okCategory = null;
//        if (isDirtyCategory) {
//            okCategory = this.canChangeCategory();
//        } else {
//            okCategory = $.Deferred().resolve({result: true});
//        }
//
//        okCategory
//            .done(function(resp) {
//
//            });
//
//        var isNameDirty = this._isDirtyName();
//        var isLocationDirty = this._isDirtyLocation();
//        var isDirtyFlag = this._isDirtyFlag();
//        var isDirtyGeo = this._isDirtyGeo();
//    };

    //
    // TODO: Function calls specific for Item
    // TODO: What with triggered events? Assume we'll handle Intercom on server side!
    //

    /**
     * Duplicates an item a number of tumes
     * @param times
     * @returns {promise}
     */
    Item.prototype.duplicate = function(times) {
        return this._doApiCall({
            method: 'duplicate',
            params: {times: times},
            skipRead: true  // response is an array of new Item objects!!
        });
    };

    /**
     * Expires an item, puts it in the *expired* status
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.expire = function(skipRead) {
        return this._doApiCall({method: 'expire', skipRead: skipRead});
    };

    /**
     * Un-expires an item, puts it in the *available* status again
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.undoExpire = function(skipRead) {
        return this._doApiCall({method: 'undoExpire', skipRead: skipRead});
    };

    /**
     * Change the location of an item
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.changeLocation = function(locationId, skipRead) {
        return this._doApiCall({method: 'changeLocation', params: {location: locationId}, skipRead: skipRead});
    };

    /**
     * Adds a QR code to the item
     * @param code
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.addCode = function(code, skipRead) {
        return this._doApiCall({method: 'addCodes', params: {codes: [code]}, skipRead: skipRead});
    };

    /**
     * Removes a QR code from the item
     * @param code
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.removeCode = function(code, skipRead) {
        return this._doApiCall({method: 'removeCodes', params: {codes: [code]}, skipRead: skipRead});
    };

    /**
     * Updates the geo position of an item
     * @param lat
     * @param lng
     * @param address
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.updateGeo = function(lat, lng, address, skipRead) {
        return this._doApiCall({method: 'updateGeo', params: {lat: lat, lng: lng, address: address}, skipRead: skipRead});
    };

    /**
     * Updates the name of an item
     * @param name
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.updateName = function(name, skipRead) {
        var that = this;
        return this.ds.update(this.id, {name: name}, this.fields)
            .then(function(data) {
                return (skipRead==true) ? data : that._fromJson(data);
            });
    };

    /**
     * Checks if the item can be moved to another category
     * @param category
     * @returns {promise}
     */
    Item.prototype.canChangeCategory = function(category) {
        return this._doApiCall({
            collectionCall: true,  // it's a collection call, not an Item call
            method: 'canChangeCategory',
            params: {pks:[this.id], category: category},
            skipRead: true  // the response is a hash with results and conflicts
        });
    };

    /**
     * Moves the item to another category
     * @param category
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.changeCategory = function(category, skipRead) {
        var that = this;
        return this._doApiCall({
            collectionCall: true,  // it's a collection call, not an Item call
            method: 'changeCategory',
            params: {pks:[this.id], category: category},
            skipRead: true  // the response is a list of changed Items
        })
            .then(function(data) {
                return (skipRead==true) ? data : that._fromJson(data[0]);
            });
    };

    /**
     * Sets the flag of an item
     * @param flag
     * @param skipRead
     * @returns {promise}
     */
    Item.prototype.setFlag = function(flag, skipRead) {
        return this.setKeyValue(null, FLAG, flag, "string", skipRead);
    };

    return Item;
    
});</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Thu Apr 02 2015 12:20:59 GMT+0200 (CEST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
